![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303335277-5ae5920f-7e2e-42cb-ac2e-39c31dae60be.jpeg)

# Table of Contents

[封面](#Top_of_part0000_html)

[书名页](#Top_of_part0002_html)

[内容简介](#Top_of_part0003_html)

[版权页](#Top_of_part0004_html)

[前　言](#Top_of_part0005_html)

[目录](#Top_of_part0006_html)

[第1章　快速开始](#Top_of_part0007_split_000_html)

[1.1　Plotly简介](#1_1_PlotlyJian_Jie)

[1.2　安装与安装环境](#Top_of_part0007_split_001_html)

[1.3　在线初始化](#Top_of_part0007_split_002_html)

[1.4　在线绘图隐私说明](#Top_of_part0007_split_003_html)

[1.5　开始在线绘图](#Top_of_part0007_split_004_html)

[1.6　使用离线绘图库](#Top_of_part0007_split_005_html)

[1.7　参数解读](#Top_of_part0007_split_006_html)

[1.8　查看帮助](#Top_of_part0007_split_007_html)

[第2章　Plotly基础图形](#Top_of_part0008_split_000_html)

[2.1　基础案例解读](#Top_of_part0008_split_001_html)

[2.2　基本绘图流程](#Top_of_part0008_split_002_html)

[2.3　散点图](#Top_of_part0008_split_003_html)

[2.3.1　基本案例](#2_3_1_Ji_Ben_An_Li)

[2.3.2　样式设置](#2_3_2_Yang_Shi_She_Zhi)

[2.3.3　应用案例](#2_3_3_Ying_Yong_An_Li)

[2.3.4　参数解读](#2_3_4_Can_Shu_Jie_Du)

[2.4　气泡图](#Top_of_part0008_split_004_html)

[2.4.1　基本案例](#2_4_1_Ji_Ben_An_Li)

[2.4.2　样式设置](#2_4_2_Yang_Shi_She_Zhi)

[2.4.3　缩放设置](#2_4_3_Suo_Fang_She_Zhi)

[2.4.4　参数解读](#2_4_4_Can_Shu_Jie_Du)

[2.5　线形图](#Top_of_part0008_split_005_html)

[2.5.1　基本案例](#2_5_1_Ji_Ben_An_Li)

[2.5.2　数据缺口与连接](#2_5_2_Shu_Ju_Que_Kou_Yu_Lian_Jie)

[2.5.3　数据插值](#2_5_3_Shu_Ju_Cha_Zhi)

[2.5.4　填充线形图](#2_5_4_Tian_Chong_Xian_Xing_Tu)

[2.5.5　应用案例](#2_5_5_Ying_Yong_An_Li)

[2.5.6　参数解读](#2_5_6_Can_Shu_Jie_Du)

[2.6　柱状图](#Top_of_part0008_split_006_html)

[2.6.1　基本柱状图](#2_6_1_Ji_Ben_Zhu_Zhuang_Tu)

[2.6.2　柱状簇](#2_6_2_Zhu_Zhuang_Cu)

[2.6.3　层叠柱状图](#2_6_3_Ceng_Die_Zhu_Zhuang_Tu)

[2.6.4　瀑布式柱状图](#2_6_4_Pu_Bu_Shi_Zhu_Zhuang_Tu)

[2.6.5　图形样式设置](#2_6_5_Tu_Xing_Yang_Shi_She_Zhi)

[2.6.6　应用案例](#2_6_6_Ying_Yong_An_Li)

[2.6.7　参数解读](#2_6_7_Can_Shu_Jie_Du)

[2.7　水平条形图](#Top_of_part0008_split_007_html)

[2.7.1　基本案例](#2_7_1_Ji_Ben_An_Li)

[2.7.2　应用案例](#2_7_2_Ying_Yong_An_Li)

[2.7.3　参数解读](#2_7_3_Can_Shu_Jie_Du)

[2.8　甘特图](#Top_of_part0008_split_008_html)

[2.8.1　基本甘特图](#2_8_1_Ji_Ben_Gan_Te_Tu)

[2.8.2　甘特图（按数字索引）](#2_8_2_Gan_Te_Tu__An_Shu_Zi_Suo_Y)

[2.8.3　甘特图（按类别索引）](#2_8_3_Gan_Te_Tu__An_Lei_Bie_Suo)

[2.8.4　应用案例](#2_8_4_Ying_Yong_An_Li)

[2.9　面积图](#Top_of_part0008_split_009_html)

[2.9.1　基本面积图](#2_9_1_Ji_Ben_Mian_Ji_Tu)

[2.9.2　内部填充面积图](#2_9_2_Nei_Bu_Tian_Chong_Mian_Ji)

[2.9.3　堆积面积图](#2_9_3_Dui_Ji_Mian_Ji_Tu)

[2.10　直方图](#Top_of_part0008_split_010_html)

[2.10.1　基本直方图](#2_10_1_Ji_Ben_Zhi_Fang_Tu)

[2.10.2　重叠直方图](#2_10_2_Zhong_Die_Zhi_Fang_Tu)

[2.10.3　层叠直方图](#2_10_3_Ceng_Die_Zhi_Fang_Tu)

[2.10.4　累积直方图](#2_10_4_Lei_Ji_Zhi_Fang_Tu)

[2.10.5　应用案例](#2_10_5_Ying_Yong_An_Li)

[2.10.6　参数解读](#2_10_6_Can_Shu_Jie_Du)

[2.11　饼图](#Top_of_part0008_split_011_html)

[2.11.1　基本饼图](#2_11_1_Ji_Ben_Bing_Tu)

[2.11.2　环形饼图](#2_11_2_Huan_Xing_Bing_Tu)

[2.11.3　样式设置](#2_11_3_Yang_Shi_She_Zhi)

[2.11.4　应用案例](#2_11_4_Ying_Yong_An_Li)

[2.11.5　参数解读](#2_11_5_Can_Shu_Jie_Du)

[2.12　更多案例](#Top_of_part0008_split_012_html)

[2.13　Plotly对象概览](#Top_of_part0008_split_013_html)

[第3章　Plotly高级图形](#Top_of_part0009_split_000_html)

[3.1　时间序列](#3_1_Shi_Jian_Xu_Lie)

[3.1.1　使用方法](#3_1_1_Shi_Yong_Fang_Fa)

[3.1.2　时间范围约束](#3_1_2_Shi_Jian_Fan_Wei_Yue_Shu)

[3.2　滑动选择控件](#Top_of_part0009_split_001_html)

[3.3　表格](#Top_of_part0009_split_002_html)

[3.3.1　入门案例](#3_3_1_Ru_Men_An_Li)

[3.3.2　添加链接](#3_3_2_Tian_Jia_Lian_Jie)

[3.3.3　使用Pandas](#3_3_3_Shi_Yong_Pandas)

[3.3.4　改变大小与颜色](#3_3_4_Gai_Bian_Da_Xiao_Yu_Yan_Se)

[3.3.5　表格与图](#3_3_5_Biao_Ge_Yu_Tu)

[3.4　多图表](#Top_of_part0009_split_003_html)

[3.5　多个坐标轴](#Top_of_part0009_split_004_html)

[3.5.1　双坐标轴](#3_5_1_Shuang_Zuo_Biao_Zhou)

[3.5.2　多坐标轴](#3_5_2_Duo_Zuo_Biao_Zhou)

[3.5.3　共享坐标轴](#3_5_3_Gong_Xiang_Zuo_Biao_Zhou)

[3.6　多子图](#Top_of_part0009_split_005_html)

[3.6.1　双子图（方法一）](#3_6_1_Shuang_Zi_Tu__Fang_Fa_Yi)

[3.6.2　双子图（方法二）](#3_6_2_Shuang_Zi_Tu__Fang_Fa_Er)

[3.6.3　多子图（方法一）](#3_6_3_Duo_Zi_Tu__Fang_Fa_Yi)

[3.6.4　多子图（方法二）](#3_6_4_Duo_Zi_Tu__Fang_Fa_Er)

[3.6.5　分割视图区间](#3_6_5_Fen_Ge_Shi_Tu_Qu_Jian)

[3.6.6　子图共享坐标轴（方法一）](#3_6_6_Zi_Tu_Gong_Xiang_Zuo_Biao)

[3.6.7　子图共享坐标轴（方法二）](#3_6_7_Zi_Tu_Gong_Xiang_Zuo_Biao)

[3.6.8　子图坐标轴自定义](#3_6_8_Zi_Tu_Zuo_Biao_Zhou_Zi_Din)

[3.6.9　嵌入式子图](#3_6_9_Qian_Ru_Shi_Zi_Tu)

[3.6.10　混合图](#3_6_10_Hun_He_Tu)

[3.7　绘制SVG](#Top_of_part0009_split_006_html)

[3.7.1　线形图的绘制](#3_7_1_Xian_Xing_Tu_De_Hui_Zhi)

[3.7.2　线形图应用：创建图形的切线](#3_7_2_Xian_Xing_Tu_Ying_Yong__Ch)

[3.7.3　矩形图的绘制](#3_7_3_Ju_Xing_Tu_De_Hui_Zhi)

[3.7.4　矩形图应用：设置时间序列区域高亮显示](#3_7_4_Ju_Xing_Tu_Ying_Yong__She)

[3.7.5　圆形图的绘制](#3_7_5_Yuan_Xing_Tu_De_Hui_Zhi)

[3.7.6　圆形图应用：高亮显示散点图的聚集簇](#3_7_6_Yuan_Xing_Tu_Ying_Yong__Ga)

[第4章　Plotly与Pandas](#Top_of_part0010_split_000_html)

[4.1　简单快速入门](#Top_of_part0010_split_001_html)

[4.1.1　基本线形图](#4_1_1_Ji_Ben_Xian_Xing_Tu)

[4.1.2　基本散点图](#4_1_2_Ji_Ben_San_Dian_Tu)

[4.1.3　基本柱状图](#4_1_3_Ji_Ben_Zhu_Zhuang_Tu)

[4.2　使用cufflinks绘图](#Top_of_part0010_split_002_html)

[4.2.1　安装cufflinks](#4_2_1_An_Zhuang_cufflinks)

[4.2.2　快速入门](#4_2_2_Kuai_Su_Ru_Men)

[4.2.3　快速获取数据](#4_2_3_Kuai_Su_Huo_Qu_Shu_Ju)

[4.2.4　自定义绘图](#4_2_4_Zi_Ding_Yi_Hui_Tu)

[4.2.5　常见经典图形](#4_2_5_Chang_Jian_Jing_Dian_Tu_Xi)

[4.2.6　更多案例](#4_2_6_Geng_Duo_An_Li)

[第5章　金融绘图](#Top_of_part0011_split_000_html)

[5.1　快速绘制K线图](#Top_of_part0011_split_001_html)

[5.1.1　检查Plotly版本](#5_1_1_Jian_Cha_PlotlyBan_Ben)

[5.1.2　快速绘制OHLC（美国线）图](#5_1_2_Kuai_Su_Hui_Zhi_OHLC_Mei_G)

[5.1.3　快速绘制蜡烛图](#5_1_3_Kuai_Su_Hui_Zhi_La_Zhu_Tu)

[5.2　K线图的优化](#Top_of_part0011_split_002_html)

[5.2.1　过滤非交易时间](#5_2_1_Guo_Lu_Fei_Jiao_Yi_Shi_Jia)

[5.2.2　设置形状、颜色和注释](#5_2_2_She_Zhi_Xing_Zhuang___Yan)

[5.2.3　添加技术指标](#5_2_3_Tian_Jia_Ji_Zhu_Zhi_Biao)

[5.3　使用自定义数据的金融绘图](#Top_of_part0011_split_003_html)

[5.4　高级金融绘图](#Top_of_part0011_split_004_html)

[5.4.1　入门案例](#5_4_1_Ru_Men_An_Li)

[5.4.2　综合案例](#5_4_2_Zong_He_An_Li)

[第6章　Matplotlib](#Top_of_part0012_split_000_html)

[6.1　Matplotlib简介](#6_1_MatplotlibJian_Jie)

[6.2　安装Matplotlib](#Top_of_part0012_split_001_html)

[6.3　调整Matplotlib参数](#Top_of_part0012_split_002_html)

[6.4　常用的API功能](#Top_of_part0012_split_003_html)

[6.5　线性函数](#Top_of_part0012_split_004_html)

[6.6　增加子图](#Top_of_part0012_split_005_html)

[6.7　确定坐标范围](#Top_of_part0012_split_006_html)

[6.8　概率图](#Top_of_part0012_split_007_html)

[6.9　散点图](#Top_of_part0012_split_008_html)

[6.10　柱状图](#Top_of_part0012_split_009_html)

[6.11　更多扩展](#Top_of_part0012_split_010_html)

[第7章　Plotly与网页开发](#Top_of_part0013_split_000_html)

[7.1　Plotly在Django中的应用](#7_1_PlotlyZai_DjangoZhong_De_Yin)

[7.1.1　安装环境搭建](#7_1_1_An_Zhuang_Huan_Jing_Da_Jia)

[7.1.2　安装环境测试](#7_1_2_An_Zhuang_Huan_Jing_Ce_Shi)

[7.1.3　入门案例一](#7_1_3_Ru_Men_An_Li_Yi)

[7.1.4　入门案例二](#7_1_4_Ru_Men_An_Li_Er)

[7.1.5　更多案例扩展](#7_1_5_Geng_Duo_An_Li_Kuo_Zhan)

[7.1.6　应用案例一](#7_1_6_Ying_Yong_An_Li_Yi)

[7.1.7　应用案例二](#7_1_7_Ying_Yong_An_Li_Er)

[7.2　Plotly在Flask中的应用](#Top_of_part0013_split_001_html)

[7.2.1　安装Flask](#7_2_1_An_Zhuang_Flask)

[7.2.2　最小的Web应用](#7_2_2_Zui_Xiao_De_WebYing_Yong)

[7.2.3　模板渲染](#7_2_3_Mo_Ban_Xuan_Ran)

[7.2.4　入门案例一](#7_2_4_Ru_Men_An_Li_Yi)

[7.2.5　入门案例二](#7_2_5_Ru_Men_An_Li_Er)

[7.2.6　应用案例](#7_2_6_Ying_Yong_An_Li)

[第8章　Plotly与GUI开发](#Top_of_part0014_split_000_html)

[8.1　PyQt的安装](#Top_of_part0014_split_001_html)

[8.2　案例解读](#Top_of_part0014_split_002_html)

[8.3　设置提升的窗口部件](#Top_of_part0014_split_003_html)

[8.4　Plotly_PyQt 5的使用](#Top_of_part0014_split_004_html)

[8.5　更多扩展（Plotly）](#Top_of_part0014_split_005_html)

[8.6　Plotly与PyQt 5.6的结合](#Top_of_part0014_split_006_html)

[8.7　更多扩展（Matplotlib）](#Top_of_part0014_split_007_html)

[8.8　应用案例：展示产品组合信息](#Top_of_part0014_split_008_html)

[第9章　Plotly与机器学习](#Top_of_part0015_split_000_html)

[9.1　Plotly在Sklearn中的应用](#9_1_PlotlyZai_SklearnZhong_De_Yi)

[9.1.1　分类问题](#9_1_1_Fen_Lei_Wen_Ti)

[9.1.2　回归问题](#9_1_2_Hui_Gui_Wen_Ti)

[9.1.3　聚类问题](#9_1_3_Ju_Lei_Wen_Ti)

[9.2　PyTorch可视化工具](#Top_of_part0015_split_001_html)

[9.2.1　Visdom简介](#9_2_1_VisdomJian_Jie)

[9.2.2　安装Visdom](#9_2_2_An_Zhuang_Visdom)

[9.2.3　Visdom与Plotly](#9_2_3_VisdomYu_Plotly)

[9.2.4　Visdom基本概念](#9_2_4_VisdomJi_Ben_Gai_Nian)

[9.2.5　Visdom经典案例](#9_2_5_VisdomJing_Dian_An_Li)

[9.2.6　Visdom与PyTorch](#9_2_6_VisdomYu_PyTorch)

[第10章　Plotly在量化投资中的应用](#Top_of_part0016_html)

[第11章　Plotly在其他语言中的应用](#Top_of_part0017_split_000_html)

[11.1　Plotly在R语言中的应用](#11_1_PlotlyZai_RYu_Yan_Zhong_De)

[11.1.1　安装R语言](#11_1_1_An_Zhuang_RYu_Yan)

[11.1.2　安装Plotly模块](#11_1_2_An_Zhuang_PlotlyMo_Kuai)

[11.1.3　Plotly应用分析](#11_1_3_PlotlyYing_Yong_Fen_Xi)

[11.1.4　更多扩展](#11_1_4_Geng_Duo_Kuo_Zhan)

[11.2　Plotly在MATLAB中的应用](#Top_of_part0017_split_001_html)

[11.2.1　下载与安装](#11_2_1_Xia_Zai_Yu_An_Zhuang)

[11.2.2　基础入门](#11_2_2_Ji_Chu_Ru_Men)

[11.2.3　经典案例](#11_2_3_Jing_Dian_An_Li)

[11.2.4　更多扩展](#11_2_4_Geng_Duo_Kuo_Zhan)

[11.3　Plotly在JavaScript语言中的应用](#Top_of_part0017_split_002_html)

[11.3.1　基础入门](#11_3_1_Ji_Chu_Ru_Men)

[11.3.2　散点图](#11_3_2_San_Dian_Tu)

[11.3.3　条形图](#11_3_3_Tiao_Xing_Tu)

[11.3.4　扇形图](#11_3_4_Shan_Xing_Tu)

[11.3.5　更多扩展](#11_3_5_Geng_Duo_Kuo_Zhan)

[封底](#Top_of_part0019_html)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303335817-31e314d5-ab67-4003-8128-51ea8bfb9d4b.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303336323-b7e3f55a-c31b-44d7-a91a-8adf53b677bd.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303336875-718f3cda-87fd-460e-83b8-b12962dc430e.jpeg)

# 内容简介

随着信息技术的发展和硬件设备成本的降低，当今的互联网存在海量的数据，要想快速从这些数据中获取更多有效的信息，数据可视化是重要的一环。对于 Python语言来说，比较传统的数据可视化模块是Matplotlib，但它存在不够美观、静态性、不易分享等缺点，限制了Python在数据可视化方面的发展。为了解决这个问题，新型的动态可视化开源模块Plotly应运而生。由于Plotly具有动态、美观、易用、种类丰富等特性，所以一经问世就受到开发人员的喜爱。本书主要介绍Plotly在可视化各领域的应用，包括基础绘图、数据处理、网页开发、程序GUI、机器学习和量化投资等，方便读者对Plotly快速上手。

本书绝大部分代码用Python语言编写，同时也给出了Plotly在R语言、MATLAB和JavaScript中的应用案例。

未经许可，不得以任何方式复制或抄袭本书之部分或全部内容。

版权所有，侵权必究。

图书在版编目（CIP）数据

Python数据分析：基于Plotly的动态可视化绘图/孙洋洋等著. —北京：电子工业出版社，2018.6

ISBN 978-7-121-34113-7

Ⅰ.①P…　Ⅱ.①孙…　Ⅲ.①软件工具－程序设计　Ⅳ.①TP311.561

中国版本图书馆CIP数据核字（2018）第083114号

策划编辑：黄爱萍

责任编辑：牛　勇

印　　刷：三河市华成印务有限公司

装　　订：三河市华成印务有限公司

出版发行：电子工业出版社

北京市海淀区万寿路173信箱　邮编：100036

开　　本：787×980　1/16　印张：25　字数：460千字

版　　次：2018年6月第1版

印　　次：2018年6月第1次印刷

定　　价：79.00元

凡所购买电子工业出版社图书有缺损问题，请向购买书店调换。若书店售缺，请与本社发行部联系，联系及邮购电话：（010）88254888，88258888。

质量投诉请发邮件至zlts@phei.com.cn，盗版侵权举报请发邮件至dbqq@phei.com.cn。

本书咨询联系方式：（010）51260888-819，faq@phei.com.cn。

# 前　言

Python是一门非常优秀的编程语言，其语法简洁、易学易用，越来越受到编程人员的喜爱；Python也是一门非常“人性化”的编程语言，其各种语法规则的设计符合人们的思维方式，开发人员可以用最简单的方式实现自己的编程目的，降低时间成本；同时，Python又是一门非常强大的编程语言，其在编程的各个领域都有非常不错的表现，比如在网页开发、程序GUI设计、网络爬虫、科学计算、数据可视化、机器学习与深度学习等领域，Python都有非常好的解决方案来解决现实中的业务问题。

互联网的快速发展为我们积累了庞大的数据，计算机硬件的创新为存储与分析这些数据创造了硬件条件，编程语言的发展为分析这些数据创造了软件条件。在数据分析这个领域，Python有着自己独有的优势，简单易用的特性与强大的开源模块的支持使其成为数据分析领域方便、好用的利器。

Python在数据分析领域的广泛应用离不开其强大的开源模块的支持，大名鼎鼎的NumPy、SciPy、StatsModels、Pandas等模块的建立与发展奠定了Python在数据分析领域中的重要地位。这些模块简单又好用，它们提供的解决方案能够满足绝大部分业务需求。在人工智能领域，Python也有非常棒的解决方案，如 Sklearn、TensorFlow、MXNet、Theano、PyTorch、Caffe等都是非常好的开源模块。尤其在人工智能中最前沿的深度学习领域，Python几乎占据了霸主的地位。Python借助在数据分析领域中开源模块的优势，在量化投资领域逐渐占据了领头羊的地位。国内外主流量化投资网站大多支持Python语言，其在量化投资领域有一种逐渐淘汰其他语言，一统“江湖”之势。

对数据的分析离不开数据的可视化，相对于Python在数据分析、人工智能、量化投资等领域中的发展，在数据可视化方面的发展有些滞后。最经典的Python可视化绘图库莫过于 Matplotlib了，Matplotlib就是 MATLAB+Plot+Library，即模仿MATLAB的绘图库，其绘图风格与MATLAB类似。由于MATLAB的绘图风格有些偏古典，为了绘出更漂亮的图像，Python开源社区开发出了Seaborn绘图模块，它本质上是对 Matplotlib的封装，绘图效果更符合现代人的审美观。尽管如此，由于Matplotlib是基于GUI的绘图模块，所以存在特有的缺陷。

就笔者使用的经验而言，Matplotlib主要存在两大缺陷：首先，Matplotlib是一个静态的绘图模块，即我们绘出的图像是静态的，就像用看图软件打开图片一样，没有网页绘图的交互式效果；其次，Matplotlib绘图结果的分享很不方便，在绘图结果分享给别人时只能以图片的方式分享，别人看到的绘图结果完全是静态的，分享体验很不好。Matplotlib一直以来都是 Python可视化的主力军，但是确实存在无法克服的缺陷，并且其他的Python绘图模块如Ggplot、Bokeh、Pygal等都比较小众，绘图功能比较单一，完成不了对Matplotlib的替代。

为了解决 Python在可视化中存在的问题，Plotly应运而生，它是一个基于JavaScript的动态绘图模块。Plotly的绘图效果与我们在网页上看到的动态交互式绘图效果是一样的，其默认的绘图结果是一个HTML网页文件，通过浏览器就可以查看。我们可以把这个HTML文件分享给其他人，对方看到的效果与我们在本机上看到的效果完全一样。

Plotly有着自己强大又丰富的绘图库，支持各种类型的绘图方案。Plotly是基于JavaScript的绘图库，所以其绘图结果可以与Web应用无缝集成。总之，Plotly在绘图模块上是Matplotlib强有力的竞争对手，Plotly绘图的种类丰富、效果美观、易于保存与分享，因而越来越受数据分析人士的喜爱，至少笔者对Plotly的喜爱胜于对Matplotlib的喜爱。

Plotly最初是一款商业化的绘图软件，在2015年11月12日，Plotly开发团队决定把该模块的核心框架plotly.js开源，由此Plotly得到了快速发展。虽然在2016年6月，Plotly开发团队才正式发布其Python-api文档，在2017年 1月，Plotly 1.0才正式发布，但是这些都阻止不了程序员对Plotly的喜爱。自plotly.js开源之后，我们可以使用本地的离线模式进行绘图，不依赖于官方的服务器，使得绘图速度更快，效果与在线绘图一样，这也是目前使用Plotly绘图的主流模式。

市面上有很多关于 Matplotlib的可视化绘图教程，但是还没有 Plotly的相关图书，作为一款非常优秀的可视化绘图模块，市面上急需一本科普性的图书。在本书创作之前，市面上就已经出现了电子版的对Plotly的简单翻译版本《Plotly中文说明1期》，这是极宽量化开源团队在2017年1月的作品。极宽量化开源团队是一群研究“Python量化投资”的爱好者自愿组成的一个团队，该团队成立的初衷是为国内量化投资领域做出自己的一份贡献，目前已经成功初步翻译PyAlgoTrade、Seaborn、StatsModels、Plotly等开源模块，并公开上传到网络上，《Plotly中文说明 1期》正是该团队的一个作品。

我作为极宽量化开源团队《Plotly中文说明 1期》项目的第一负责人，最初的想法只是单纯地把 Plotly的基础内容简单翻译一下，以最简单、最快速的方式呈现给大家，方便大家使用。但是后来电子工业出版社的黄爱萍编辑找我沟通，请我编写一本Plotly数据可视化的相关图书，她认为Plotly发展很快，市场上需要一本Plotly的相关教材。经过一段时间的权衡，考虑到个人对Plotly的掌握程度、开源团队对Plotly的热情、个人在写《PyQt 5快速开发与实战》时与黄编辑建立的良好关系，以及《Plotly中文说明 1期》存在的太多缺陷等，也为了能让更多的人接触 Plotly这个优秀的绘图模块，于是决定再次抽出大量的时间来完成本书的创作，这就是本书的写作背景。

Plotly是一个非常优秀的顶级绘图模块，如此优秀的开源模块在国内的知名度却不是很高，这对国内开发人员来说是一个很大的遗憾。顶级模块在特定的领域达到家喻户晓的程度是一个必然的趋势，Plotly正是这种模块，它在可视化绘图领域的表现终会大放异彩。虽然目前 Plotly在国内知名度不是很高，但其在可视化绘图领域做到家喻户晓是一个必然的趋势，只是需要有人加速这种趋势的演化过程，这就是本书存在的意义。

本书结构

本书的框架结构如下。

第1章是本书的快速入门部分，介绍Plotly的安装环境，对在线绘图与离线绘图做了简要的介绍。

第2章是基础绘图部分，对Plotly的一些常见的基础图形如线形图、柱状图、饼图、气泡图和直方图等做了一些介绍。

第3章是高级图形部分，对Plotly的时间序列绘图、表格绘图、多个坐标轴绘图、多子图绘图、SVG绘图等做了一些介绍，是Plotly绘图的高级应用。

第4章是Pandas部分，介绍Pandas这个顶级数据分析模块使用Plotly进行绘图的方法。

第5章是金融绘图部分，主要为金融领域的特殊图形尤其是K线图的绘制提供了解决方案。

第6章是Matplotlib部分，主要介绍如何把Matplotlib绘图迁移到Plotly中。

第7章是网页开发部分，主要介绍Plotly在Python网页开发框架Django和Flask中的应用。

第8章是GUI开发部分，主要介绍Plotly在GUI开发框架PyQt 5中的应用。

第9章是机器学习部分，主要介绍Plotly在机器学习框架Sklearn与PyTorch中的应用。

第10章是量化投资部分，主要介绍Plotly在量化投资领域中的可视化应用。

第11章是其他语言应用部分，主要对其他语言如R、MATLAB、JavaScript的Plotly绘图做了简要的介绍。

如果你仅仅对Plotly的基础绘图有兴趣，那么前两章的内容就能满足你的需求；如果你对Plotly更高级的绘图有兴趣，那么可以参考第3章的内容；对于本书其他章节的内容，可以根据自己的实际情况有选择地阅读，毕竟 Plotly绘图所涉及的范围特别广泛，并不是每个人对这些领域都同时感兴趣。

本书代码与交流

本书的所有代码都将保存在GitHub上，后续代码更新也会以GitHub地址为准，网址是 https://github.com/sunshe35/PythonPlotlyCodes，读者可自行下载。另外，为了方便读者交流、学习Plotly，笔者建立了QQ群（群号：72203080）。

致谢

Plotly虽然只是一个绘图模块，但是其应用场景非常广泛，除有Matplotlib的基本绘图功能外，其在Web开发、GUI开发、机器学习、量化投资等领域也有很好的应用场景。由于其应用场景特别广泛，结合笔者自身知识的局限性，所以写好一本书需要多个人的共同努力，非常感谢下面这些作者对本书的创作所付出的努力：王硕负责本书的Flask、PyTorch、JavaScript部分；邢梦来负责本书的Matplotlib部分；袁泉负责本书的基础绘图与Sklearn部分；吴娜负责本书的Pandas部分，其他都由本人孙洋洋负责。在 Plotly的写作过程中，还有一些人为本书的顺利出版做出了贡献：首先，感谢《Plotly中文说明 1期》的开源组成员们，你们的贡献是本书基础部分的雏形，相关人员的网名和 QQ号分别是 youngle sunny 1535327967、余勤441499022、华子 32509167、啦啦啦 505512828、禛 948280670、L. 1248515039、Rikimaru 11766429、iris 704699640、信平 759949947、吴娜 2184934、周涛 510548099、zw木子 719735825、非洲兔 85011284、十二月 378258849、大朱 775941748、我爱作文你信吗 571171954。其次，感谢山西证券金融科技部的陈亦苏、成都数联铭品科技有限公司的刘赣，以及极宽量化开源组的梁勇对本书网页开发部分提供的帮助，感谢西南财经大学统计学院王彦锋博士对本书R语言部分提供的帮助，感谢北京大学汇丰商学院硕士研究生扶禄城对本书MATLAB部分提供的帮助。再次，感谢黄爱萍与戴新两位编辑对本书的出版所付出的努力。最后，感谢我的父母与兄弟姐妹对我的关心与照顾，我现在取得的成果离不开你们对我的付出。

与读者相识于Plotly是一种缘分，能够看到本书说明读者对Plotly是感兴趣的，感谢读者愿意花费时间阅读本书，希望每一位读者都能够通过阅读本书有所收获，真心祝愿你们都能够学习顺利、事业有成。

孙洋洋

2018年4月

轻松注册成为博文视点社区用户（www.broadview.com.cn），扫码直达本书页面。

● 下载资源：本书如提供示例代码及资源文件，均可在 下载资源处下载。

● 提交勘误：您对书中内容的修改意见可在 提交勘误处提交，若被采纳，将获赠博文视点社区积分（在您购买电子书时，积分可用来抵扣相应金额）。

● 交流互动：在页面下方 读者评论处留下您的疑问或观点，与我们和其他读者一同学习交流。

页面入口：http://www.broadview.com.cn/34113

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303337438-036772a9-05c0-4cbc-bb0a-e8cf16d2e70d.jpeg)

# 目　录

[内容简介](#Nei_Rong_Jian_Jie)

[前　言](#Qian__Yan)

[第1章　快速开始](#Di_1Zhang__Kuai_Su_Kai_Shi)

[1.1　Plotly简介](#1_1_PlotlyJian_Jie)

[1.2　安装与安装环境](#1_2_An_Zhuang_Yu_An_Zhuang_Huan)

[1.3　在线初始化](#1_3_Zai_Xian_Chu_Shi_Hua)

[1.4　在线绘图隐私说明](#1_4_Zai_Xian_Hui_Tu_Yin_Si_Shuo)

[1.5　开始在线绘图](#1_5_Kai_Shi_Zai_Xian_Hui_Tu)

[1.6　使用离线绘图库](#1_6_Shi_Yong_Li_Xian_Hui_Tu_Ku)

[1.7　参数解读](#1_7_Can_Shu_Jie_Du)

[1.8　查看帮助](#1_8_Cha_Kan_Bang_Zhu)

[第2章　Plotly基础图形](#Di_2Zhang__PlotlyJi_Chu_Tu_Xing)

[2.1　基础案例解读](#2_1_Ji_Chu_An_Li_Jie_Du)

[2.2　基本绘图流程](#2_2_Ji_Ben_Hui_Tu_Liu_Cheng)

[2.3　散点图](#2_3_San_Dian_Tu)

[2.3.1　基本案例](#2_3_1_Ji_Ben_An_Li)

[2.3.2　样式设置](#2_3_2_Yang_Shi_She_Zhi)

[2.3.3　应用案例](#2_3_3_Ying_Yong_An_Li)

[2.3.4　参数解读](#2_3_4_Can_Shu_Jie_Du)

[2.4　气泡图](#2_4_Qi_Pao_Tu)

[2.4.1　基本案例](#2_4_1_Ji_Ben_An_Li)

[2.4.2　样式设置](#2_4_2_Yang_Shi_She_Zhi)

[2.4.3　缩放设置](#2_4_3_Suo_Fang_She_Zhi)

[2.4.4　参数解读](#2_4_4_Can_Shu_Jie_Du)

[2.5　线形图](#2_5_Xian_Xing_Tu)

[2.5.1　基本案例](#2_5_1_Ji_Ben_An_Li)

[2.5.2　数据缺口与连接](#2_5_2_Shu_Ju_Que_Kou_Yu_Lian_Jie)

[2.5.3　数据插值](#2_5_3_Shu_Ju_Cha_Zhi)

[2.5.4　填充线形图](#2_5_4_Tian_Chong_Xian_Xing_Tu)

[2.5.5　应用案例](#2_5_5_Ying_Yong_An_Li)

[2.5.6　参数解读](#2_5_6_Can_Shu_Jie_Du)

[2.6　柱状图](#2_6_Zhu_Zhuang_Tu)

[2.6.1　基本柱状图](#2_6_1_Ji_Ben_Zhu_Zhuang_Tu)

[2.6.2　柱状簇](#2_6_2_Zhu_Zhuang_Cu)

[2.6.3　层叠柱状图](#2_6_3_Ceng_Die_Zhu_Zhuang_Tu)

[2.6.4　瀑布式柱状图](#2_6_4_Pu_Bu_Shi_Zhu_Zhuang_Tu)

[2.6.5　图形样式设置](#2_6_5_Tu_Xing_Yang_Shi_She_Zhi)

[2.6.6　应用案例](#2_6_6_Ying_Yong_An_Li)

[2.6.7　参数解读](#2_6_7_Can_Shu_Jie_Du)

[2.7　水平条形图](#2_7_Shui_Ping_Tiao_Xing_Tu)

[2.7.1　基本案例](#2_7_1_Ji_Ben_An_Li)

[2.7.2　应用案例](#2_7_2_Ying_Yong_An_Li)

[2.7.3　参数解读](#2_7_3_Can_Shu_Jie_Du)

[2.8　甘特图](#2_8_Gan_Te_Tu)

[2.8.1　基本甘特图](#2_8_1_Ji_Ben_Gan_Te_Tu)

[2.8.2　甘特图（按数字索引）](#2_8_2_Gan_Te_Tu__An_Shu_Zi_Suo_Y)

[2.8.3　甘特图（按类别索引）](#2_8_3_Gan_Te_Tu__An_Lei_Bie_Suo)

[2.8.4　应用案例](#2_8_4_Ying_Yong_An_Li)

[2.9　面积图](#2_9_Mian_Ji_Tu)

[2.9.1　基本面积图](#2_9_1_Ji_Ben_Mian_Ji_Tu)

[2.9.2　内部填充面积图](#2_9_2_Nei_Bu_Tian_Chong_Mian_Ji)

[2.9.3　堆积面积图](#2_9_3_Dui_Ji_Mian_Ji_Tu)

[2.10　直方图](#2_10_Zhi_Fang_Tu)

[2.10.1　基本直方图](#2_10_1_Ji_Ben_Zhi_Fang_Tu)

[2.10.2　重叠直方图](#2_10_2_Zhong_Die_Zhi_Fang_Tu)

[2.10.3　层叠直方图](#2_10_3_Ceng_Die_Zhi_Fang_Tu)

[2.10.4　累积直方图](#2_10_4_Lei_Ji_Zhi_Fang_Tu)

[2.10.5　应用案例](#2_10_5_Ying_Yong_An_Li)

[2.10.6　参数解读](#2_10_6_Can_Shu_Jie_Du)

[2.11　饼图](#2_11_Bing_Tu)

[2.11.1　基本饼图](#2_11_1_Ji_Ben_Bing_Tu)

[2.11.2　环形饼图](#2_11_2_Huan_Xing_Bing_Tu)

[2.11.3　样式设置](#2_11_3_Yang_Shi_She_Zhi)

[2.11.4　应用案例](#2_11_4_Ying_Yong_An_Li)

[2.11.5　参数解读](#2_11_5_Can_Shu_Jie_Du)

[2.12　更多案例](#2_12_Geng_Duo_An_Li)

[2.13　Plotly对象概览](#2_13_PlotlyDui_Xiang_Gai_Lan)

[第3章　Plotly高级图形](#Di_3Zhang__PlotlyGao_Ji_Tu_Xing)

[3.1　时间序列](#3_1_Shi_Jian_Xu_Lie)

[3.1.1　使用方法](#3_1_1_Shi_Yong_Fang_Fa)

[3.1.2　时间范围约束](#3_1_2_Shi_Jian_Fan_Wei_Yue_Shu)

[3.2　滑动选择控件](#3_2_Hua_Dong_Xuan_Ze_Kong_Jian)

[3.3　表格](#3_3_Biao_Ge)

[3.3.1　入门案例](#3_3_1_Ru_Men_An_Li)

[3.3.2　添加链接](#3_3_2_Tian_Jia_Lian_Jie)

[3.3.3　使用Pandas](#3_3_3_Shi_Yong_Pandas)

[3.3.4　改变大小与颜色](#3_3_4_Gai_Bian_Da_Xiao_Yu_Yan_Se)

[3.3.5　表格与图](#3_3_5_Biao_Ge_Yu_Tu)

[3.4　多图表](#3_4_Duo_Tu_Biao)

[3.5　多个坐标轴](#3_5_Duo_Ge_Zuo_Biao_Zhou)

[3.5.1　双坐标轴](#3_5_1_Shuang_Zuo_Biao_Zhou)

[3.5.2　多坐标轴](#3_5_2_Duo_Zuo_Biao_Zhou)

[3.5.3　共享坐标轴](#3_5_3_Gong_Xiang_Zuo_Biao_Zhou)

[3.6　多子图](#3_6_Duo_Zi_Tu)

[3.6.1　双子图（方法一）](#3_6_1_Shuang_Zi_Tu__Fang_Fa_Yi)

[3.6.2　双子图（方法二）](#3_6_2_Shuang_Zi_Tu__Fang_Fa_Er)

[3.6.3　多子图（方法一）](#3_6_3_Duo_Zi_Tu__Fang_Fa_Yi)

[3.6.4　多子图（方法二）](#3_6_4_Duo_Zi_Tu__Fang_Fa_Er)

[3.6.5　分割视图区间](#3_6_5_Fen_Ge_Shi_Tu_Qu_Jian)

[3.6.6　子图共享坐标轴（方法一）](#3_6_6_Zi_Tu_Gong_Xiang_Zuo_Biao)

[3.6.7　子图共享坐标轴（方法二）](#3_6_7_Zi_Tu_Gong_Xiang_Zuo_Biao)

[3.6.8　子图坐标轴自定义](#3_6_8_Zi_Tu_Zuo_Biao_Zhou_Zi_Din)

[3.6.9　嵌入式子图](#3_6_9_Qian_Ru_Shi_Zi_Tu)

[3.6.10　混合图](#3_6_10_Hun_He_Tu)

[3.7　绘制SVG](#3_7_Hui_Zhi_SVG)

[3.7.1　线形图的绘制](#3_7_1_Xian_Xing_Tu_De_Hui_Zhi)

[3.7.2　线形图应用：创建图形的切线](#3_7_2_Xian_Xing_Tu_Ying_Yong__Ch)

[3.7.3　矩形图的绘制](#3_7_3_Ju_Xing_Tu_De_Hui_Zhi)

[3.7.4　矩形图应用：设置时间序列区域高亮显示](#3_7_4_Ju_Xing_Tu_Ying_Yong__She)

[3.7.5　圆形图的绘制](#3_7_5_Yuan_Xing_Tu_De_Hui_Zhi)

[3.7.6　圆形图应用：高亮显示散点图的聚集簇](#3_7_6_Yuan_Xing_Tu_Ying_Yong__Ga)

[第4章　Plotly与Pandas](#Di_4Zhang__PlotlyYu_Pandas)

[4.1　简单快速入门](#4_1_Jian_Dan_Kuai_Su_Ru_Men)

[4.1.1　基本线形图](#4_1_1_Ji_Ben_Xian_Xing_Tu)

[4.1.2　基本散点图](#4_1_2_Ji_Ben_San_Dian_Tu)

[4.1.3　基本柱状图](#4_1_3_Ji_Ben_Zhu_Zhuang_Tu)

[4.2　使用cufflinks绘图](#4_2_Shi_Yong_cufflinksHui_Tu)

[4.2.1　安装cufflinks](#4_2_1_An_Zhuang_cufflinks)

[4.2.2　快速入门](#4_2_2_Kuai_Su_Ru_Men)

[4.2.3　快速获取数据](#4_2_3_Kuai_Su_Huo_Qu_Shu_Ju)

[4.2.4　自定义绘图](#4_2_4_Zi_Ding_Yi_Hui_Tu)

[4.2.5　常见经典图形](#4_2_5_Chang_Jian_Jing_Dian_Tu_Xi)

[4.2.6　更多案例](#4_2_6_Geng_Duo_An_Li)

[第5章　金融绘图](#Di_5Zhang__Jin_Rong_Hui_Tu)

[5.1　快速绘制K线图](#5_1_Kuai_Su_Hui_Zhi_KXian_Tu)

[5.1.1　检查Plotly版本](#5_1_1_Jian_Cha_PlotlyBan_Ben)

[5.1.2　快速绘制OHLC（美国线）图](#5_1_2_Kuai_Su_Hui_Zhi_OHLC_Mei_G)

[5.1.3　快速绘制蜡烛图](#5_1_3_Kuai_Su_Hui_Zhi_La_Zhu_Tu)

[5.2　K线图的优化](#5_2_KXian_Tu_De_You_Hua)

[5.2.1　过滤非交易时间](#5_2_1_Guo_Lu_Fei_Jiao_Yi_Shi_Jia)

[5.2.2　设置形状、颜色和注释](#5_2_2_She_Zhi_Xing_Zhuang___Yan)

[5.2.3　添加技术指标](#5_2_3_Tian_Jia_Ji_Zhu_Zhi_Biao)

[5.3　使用自定义数据的金融绘图](#5_3_Shi_Yong_Zi_Ding_Yi_Shu_Ju_D)

[5.4　高级金融绘图](#5_4_Gao_Ji_Jin_Rong_Hui_Tu)

[5.4.1　入门案例](#5_4_1_Ru_Men_An_Li)

[5.4.2　综合案例](#5_4_2_Zong_He_An_Li)

[第6章　Matplotlib](#Di_6Zhang__Matplotlib)

[6.1　Matplotlib简介](#6_1_MatplotlibJian_Jie)

[6.2　安装Matplotlib](#6_2_An_Zhuang_Matplotlib)

[6.3　调整Matplotlib参数](#6_3_Diao_Zheng_MatplotlibCan_Shu)

[6.4　常用的API功能](#6_4_Chang_Yong_De_APIGong_Neng)

[6.5　线性函数](#6_5_Xian_Xing_Han_Shu)

[6.6　增加子图](#6_6_Zeng_Jia_Zi_Tu)

[6.7　确定坐标范围](#6_7_Que_Ding_Zuo_Biao_Fan_Wei)

[6.8　概率图](#6_8_Gai_Lu_Tu)

[6.9　散点图](#6_9_San_Dian_Tu)

[6.10　柱状图](#6_10_Zhu_Zhuang_Tu)

[6.11　更多扩展](#6_11_Geng_Duo_Kuo_Zhan)

[第7章　Plotly与网页开发](#Di_7Zhang__PlotlyYu_Wang_Ye_Kai)

[7.1　Plotly在Django中的应用](#7_1_PlotlyZai_DjangoZhong_De_Yin)

[7.1.1　安装环境搭建](#7_1_1_An_Zhuang_Huan_Jing_Da_Jia)

[7.1.2　安装环境测试](#7_1_2_An_Zhuang_Huan_Jing_Ce_Shi)

[7.1.3　入门案例一](#7_1_3_Ru_Men_An_Li_Yi)

[7.1.4　入门案例二](#7_1_4_Ru_Men_An_Li_Er)

[7.1.5　更多案例扩展](#7_1_5_Geng_Duo_An_Li_Kuo_Zhan)

[7.1.6　应用案例一](#7_1_6_Ying_Yong_An_Li_Yi)

[7.1.7　应用案例二](#7_1_7_Ying_Yong_An_Li_Er)

[7.2　Plotly在Flask中的应用](#7_2_PlotlyZai_FlaskZhong_De_Ying)

[7.2.1　安装Flask](#7_2_1_An_Zhuang_Flask)

[7.2.2　最小的Web应用](#7_2_2_Zui_Xiao_De_WebYing_Yong)

[7.2.3　模板渲染](#7_2_3_Mo_Ban_Xuan_Ran)

[7.2.4　入门案例一](#7_2_4_Ru_Men_An_Li_Yi)

[7.2.5　入门案例二](#7_2_5_Ru_Men_An_Li_Er)

[7.2.6　应用案例](#7_2_6_Ying_Yong_An_Li)

[第8章　Plotly与GUI开发](#Di_8Zhang__PlotlyYu_GUIKai_Fa)

[8.1　PyQt的安装](#8_1_PyQtDe_An_Zhuang)

[8.2　案例解读](#8_2_An_Li_Jie_Du)

[8.3　设置提升的窗口部件](#8_3_She_Zhi_Ti_Sheng_De_Chuang_K)

[8.4　Plotly_PyQt 5的使用](#8_4_Plotly_PyQt_5De_Shi_Yong)

[8.5　更多扩展（Plotly）](#8_5_Geng_Duo_Kuo_Zhan__Plotly)

[8.6　Plotly与PyQt 5.6的结合](#8_6_PlotlyYu_PyQt_5_6De_Jie_He)

[8.7　更多扩展（Matplotlib）](#8_7_Geng_Duo_Kuo_Zhan__Matplotli)

[8.8　应用案例：展示产品组合信息](#8_8_Ying_Yong_An_Li__Zhan_Shi_Ch)

[第9章　Plotly与机器学习](#Di_9Zhang__PlotlyYu_Ji_Qi_Xue_Xi)

[9.1　Plotly在Sklearn中的应用](#9_1_PlotlyZai_SklearnZhong_De_Yi)

[9.1.1　分类问题](#9_1_1_Fen_Lei_Wen_Ti)

[9.1.2　回归问题](#9_1_2_Hui_Gui_Wen_Ti)

[9.1.3　聚类问题](#9_1_3_Ju_Lei_Wen_Ti)

[9.2　PyTorch可视化工具](#9_2_PyTorchKe_Shi_Hua_Gong_Ju)

[9.2.1　Visdom简介](#9_2_1_VisdomJian_Jie)

[9.2.2　安装Visdom](#9_2_2_An_Zhuang_Visdom)

[9.2.3　Visdom与Plotly](#9_2_3_VisdomYu_Plotly)

[9.2.4　Visdom基本概念](#9_2_4_VisdomJi_Ben_Gai_Nian)

[9.2.5　Visdom经典案例](#9_2_5_VisdomJing_Dian_An_Li)

[9.2.6　Visdom与PyTorch](#9_2_6_VisdomYu_PyTorch)

[第10章　Plotly在量化投资中的应用](#Di_10Zhang__PlotlyZai_Liang_Hua)

[第11章　Plotly在其他语言中的应用](#Di_11Zhang__PlotlyZai_Qi_Ta_Yu_Y)

[11.1　Plotly在R语言中的应用](#11_1_PlotlyZai_RYu_Yan_Zhong_De)

[11.1.1　安装R语言](#11_1_1_An_Zhuang_RYu_Yan)

[11.1.2　安装Plotly模块](#11_1_2_An_Zhuang_PlotlyMo_Kuai)

[11.1.3　Plotly应用分析](#11_1_3_PlotlyYing_Yong_Fen_Xi)

[11.1.4　更多扩展](#11_1_4_Geng_Duo_Kuo_Zhan)

[11.2　Plotly在MATLAB中的应用](#11_2_PlotlyZai_MATLABZhong_De_Yi)

[11.2.1　下载与安装](#11_2_1_Xia_Zai_Yu_An_Zhuang)

[11.2.2　基础入门](#11_2_2_Ji_Chu_Ru_Men)

[11.2.3　经典案例](#11_2_3_Jing_Dian_An_Li)

[11.2.4　更多扩展](#11_2_4_Geng_Duo_Kuo_Zhan)

[11.3　Plotly在JavaScript语言中的应用](#11_3_PlotlyZai_JavaScriptYu_Yan)

[11.3.1　基础入门](#11_3_1_Ji_Chu_Ru_Men)

[11.3.2　散点图](#11_3_2_San_Dian_Tu)

[11.3.3　条形图](#11_3_3_Tiao_Xing_Tu)

[11.3.4　扇形图](#11_3_4_Shan_Xing_Tu)

[11.3.5　更多扩展](#11_3_5_Geng_Duo_Kuo_Zhan)

# 第1章　快速开始

## 1.1　Plotly简介

Pandas（潘达思）数据分析软件和Plotly互动式绘图模块可以称为Python数据分析和Python量化分析两大重量级模块库。

事实上，这两者的影响力早已超越Python语言领域。

● Pandas目前已经被业界公认是大数据工程一线最好的解决方案。

● Plotly被称为史上最好的绘图工具之一，是GitHub开源网站最“火”的两大新项目之一（另外一个是Netflix的Spinnaker云计算项目）。

为了更好地展示金融数据的复杂性，下面首先介绍 Plotly绘图模块。如图1-1所示是Plotly网站截图，网址是https://plot.ly。

Python量化的关键是金融数据可视化，无论是传统的K线图，还是现在的互动策略分析，都需要大量的可视化图表。具体到编程代码，就是各种Python绘图模块库，传统Python绘图模块库有Matplotlib、Ggplot、Seaborn、Bokeh等。

Plotly绘图底层使用的是plotly.js，plotly.js基于D3.js、stack.gl（WebGL组件库，由Plotly团队的Mikola Lysenko带领开发）和SVG，用JavaScript在网页上实现类似MATLAB和Python Matplotlib的图形展示功能，支持数十种图形，包括2D和3D图形，交互流畅，可以满足一般科学计算的需要。该项目成功后，开始向其他语言移植，目前已经有Python、MATLAB、R语言、Jupyter等多种版本的API接口。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303337929-309aabca-693a-46f3-89dd-fd77abbd9b75.jpeg)

图1-1　Plotly网站截图

Plotly项目的创始人是Alex Johnson，是哈佛大学物理博士，曾经做过燃料电池。该项目的参与者中有一位华裔女生，叫Baobao Zhang（张宝宝），是耶鲁大学政治学博士。Fernando Perez（IPython Notebook创始人）是该项目的顾问。

Plotly项目团队在2013年就已经拿到数百万美元的投资，并在加拿大蒙特利尔注册了公司，公司名称是科学数据云服务公司，号称是“首个科学数据平台”，提供线上和联机服务，方便用户使用分享、评论等功能，其投资商有MHS资本、西门子风险资本、Rho Ventures、Real Ventures和硅谷银行等。

Plotly公司有很多大牌客户，如西门子、Google、美国国家航天局（NASA）、美国空军、华盛顿邮报、美国国家卫生研究院等。

Plotly公司的联合创始人Jack Parmer这样说过：对于开发者来说，绘制出漂亮的、交互式的图表并将之分享是一件很容事的事，但是对于一般的用户则很困难。Plotly改变了这种局面，借助互联网的媒介、利用世界级的绘图分析工具，每个人都可以参与其中。

Hacker News（极客新闻）网站曾经专门讨论过各种图形模块库，如Matplotlib、MPLD3、Bokeh、Highcharts、Flotcharts、MetricsGraphics、Vega、Chartjs、FusionCharts和JSXGraph。相比而言，Plotly功能齐全，性能显著超过其他同类产品。

Plotly原本是收费的商业软件，幸运的是，2016年6月，Plotly绘图模块库提供了免费的社区版本，并新增了Python等多种编程语言的接口，以及离线模式支持，这对于广大中国用户而言，获得了现实的技术支持。

Python绘图模块库数不胜数，其中经典的有数十个。目前，Plotly作为新一代互动型量化绘图库，基本上可以说一统天下。如图1-2所示是Plotly绘图模块库部分内置的图形类型。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303338402-37bb6263-9f19-410a-b219-e6c90c89d4e0.jpeg)

图1-2　Plotly绘图模块库部分内置的图形类型

笔者在编写本书时，特别针对多种Python绘图模块库进行了测试，测试结果表明，Plotly绘图模块库的确是新一代Python绘图模块的王者之选，也是各种Web平台的优先选择绘图模块。

以笔者个人的测试感觉而言，Plotly绘图模块库既有Matplotlib绘图模块库的强大与灵活，又有Seaborn统计绘图模块库的现代配色组合与优雅报表形态。

Plotly绘图模块库可直接生成PNG等图像文件，与Bokeh绘图模块库和各种基于Web的JavaScript图表模块库类似，生成的是一个内置JavaScript脚本的HTML网页文件，虽然文件比Bokeh绘图模块库生成的文件略大，但在互动性方面，Plotly绘图模块库强大得多。

在3D图表方面，虽然笔者没有实际测试，但基于Plotly网站的案例可以看出，相对传统Python 3D图表模块库，无论在图表种类格式，还是色彩组合方面，Plotly绘图模块库都显得更加灵活和强大。

图1-3所示是Plotly绘图模块库绘制的K线图，支持互动功能，读者可以参考Top极宽量化社区的演示网页（http://www.ziwang.com/zwdemo.htm）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303338982-8491f213-7096-472f-8e8b-e52f5e46ccbc.jpeg)

图1-3　Plotly绘图模块库绘制的K线图

请注意，案例中没有使用任何图片，是纯 JavaScript脚本函数，所有的图形、数据和互动都是通过JavaScript函数完成的，这些JavaScript函数全部是通过Python自动生成的。

图1-3虽然是静止的，但在浏览器中，其实是纯JavaScript脚本的函数图形，支持各种互动功能，读者可以好好体会一下，并且看看网页源码。

Plotly原本是基于JavaScript的数据图表分析绘制模块库，在编程的灵活性和图表的丰富性方面非常强大，优点数不胜数。

● Plotly本身是一款独立的Web版数据可视化工具，界面友好，提供强大的互动性操作。

● 基于现代的配色组合和图表形式，相比Matplotlib、R语言的图表，更加现代和绚丽。

● 具有简单且强大的3D图表绘制功能，支持多种格式。

● 对图形参数的修改十分简单、直观，便于初学者使用。

● 有Python、R、MATLAB、Jupyter、Excel等多种版本的接口。

● 与 Pandas（潘达思）数据分析软件无缝集成，并提供了专门的Plotly绘图模块库，设计的图表非常吸引人，而且具有高度互动性，这得益于其完善的文档和简单的Python API，用户入门也很容易，

目前，Plotly绘图模块库支持的图表格式如下。

● 基本图表：20种。

● 统计和海运方式图：12种。

● 科学图表：21种。

● 财务图表：2种。

● 地图：8种。

● 3D图表：19种。

● 报告生成：4种。

● 连接数据库：7种。

● 拟合工具：3种。

● 流动图表：4种。

随着Plotly绘图模块库软件的升级与更新，未来会增加更多的图表格式。

Plotly底层使用的是plotly.js，支持Python、R、MATLAB、JavaScript这四种语言的扩展，由于Python正处于数据分析领域的领先地位，并且其重要性呈日渐上升之势，所以本书介绍Plotly时以Python语言（Python 3）为主，同时也会给出Plotly在其他语言中的一些应用。

Plotly发展很快，其应用的领域也非常广泛，不但应用在传统意义上的数据分析与处理上，而且在网页开发、程序 GUI、机器学习等多个方面也有重要的应用。由于这个原因，本书涉及的内容很广，除Plotly基础知识外不会做太多深入的介绍，仅进行入门介绍，读者可以结合基础知识部分进行更深入的研究，这对于绝大部分读者来说并不是什么难事。

对于本书前半部分的基础知识内容，并不需要读者对Python有太多的了解，没有学过 Python的读者只需要花费两个小时了解 Python的基础语法就可以了。本书后半部分的内容，读者可以按照自己的实际需求阅读相关的章节，然后稍微修改一下就可以进行实战，通过这种方式快速掌握这些技能。

## 1.2　安装与安装环境

安装Plotly的方法特别简单，直接用pip命令安装即可，代码如下。

pip install plotly

Plotly的Python包经常被更新，若需要升级到最新版，运行如下代码。

pip install plotly --upgrade

本书涉及的模块都是一些比较流行的模块，一般情况下都可以通过 pip命令进行安装。这里笔者建议使用Python 3.5的anaconda或winpython开发环境，因为目前笔者使用Python 3.6经常遇到一些bug，而使用Python 3.5则没有这些问题。下载anaconda或 winpython后，默认环境就是本书所依赖的环境，如果有些模块没有找到，可以通过pip命令安装。

## 1.3　在线初始化

Plotly提供了一个在线托管绘图结果的 Web服务平台，用户可以在网站（https://plot.ly）免费创建一个账号。用户所绘制的图表会保存在自己的在线 Plotly账户中，并且可以控制相应的权限。免费的托管方式是公共的，也就是自己的绘图结果其他人也能够看见。网站也提供私有的托管方式，不过是收费的，这里不推荐，有兴趣的读者可以去官网查看。

安装好Python和Plotly后，要使用Plotly，首先要设置自己的凭据，这个凭据在网站上注册一个账号就可以获取。当用户注册Plotly账号并进行登录后，在右上角可以找到自己的用户选项，单击其中的Settings选项，然后找到API Key选项，如图1-4所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303339621-7365e6c4-217d-42a0-9b2e-ac08d4b88e2d.jpeg)

图1-4　获取凭据

图1-4中的Username和API Key是笔者为编写本书注册的一个测试账号，读者可以通过注册自己的账号得到类似的结果。

下面我们把上面的Username和API Key记录下来，放入如下代码中，就完成了自己的凭据设置，由此，在线初始化完成。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303340004-52bf5e4f-3453-4497-abd7-4b406f7e1fe3.jpeg)

上面的初始化步骤会在当前用户目录中存放一个特殊文件.plotly/.credentials，这个文件内容看起来是下面这样的：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303340498-6a2d0c4d-b531-4269-afa7-a3b3db764fb3.jpeg)

## 1.4　在线绘图隐私说明

使用在线绘图，有三种不同的隐私设置类型：公有、私有和秘密。

● 公有

（1）任何人都可以查看用户的图表。

（2）显示在用户的个人资料中，可以被搜索引擎搜索到。

（3）用户不需要登录Plotly就可以查看这些图表。

● 私有

（1）只有自己才可以查看此图表。

（2）不会显示在Plotly的信息源、用户的个人资料和搜索引擎中。

（3）用户需要登录才能查看这些图表。

● 秘密

（1）任何拥有此秘密链接的人都可以查看此图表。

（2）不会显示在Plotly的信息源、用户的个人资料和搜索引擎中。

（3）如果它嵌入Web或Jupyter Notebook中，任何查看该网页的人都能够看到此图表。

（4）用户不需要登录就可以查看这些图表。

在默认情况下，所有图表都被设置为公有模式。免费账户（公有模式的账户）可以有一个私有图表。如果用户有额外的私有存储需求，就需要去官网升级产品服务，感兴趣的读者可以去官网查看。

## 1.5　开始在线绘图

在线绘图时，绘图和数据都保存在自己的云账户中。有两个方法可以实现在线绘图：py.plot()和py.iplot()。这两个方法的作用都是在自己的账户中新建一个网址并存储绘图结果。当然，这两个方法也有不同的地方。

● 使用py.plot()方法进行绘图会返回一个网址，可以选择是否打开这个网址，默认是打开的。

● 使用py.iplot()方法进行绘图会返回PlotlyDisplay对象，并以嵌入的形式在Jupyter Notebook中显示出来。

下面开始讲解我们的第一个案例（见文件Chapter01/first_start.py），只需运行如下代码。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303341090-f9c5522f-9fc1-4336-9d58-63a1244a6537.jpeg)

运行上面的代码会打开一个网页，需要稍等片刻才能渲染完成，我们会看到如图1-5所示的结果。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303341646-8186b5c3-6f6e-45b7-a661-0c099f2bd670.jpeg)

图1-5　案例运行结果

本书的第一个案例代码运行完成。

同样，在Jupyter Notebook（如果读者不知道什么是Jupyter Notebook，可以跳过这部分）中，我们也可以在 Spyder等 IDE里面完成相同的绘图操作，只需要把py.plot()改成py.iplot()就可以了（见文件Chapter01/first_start.ipynb），代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303342111-81543308-9441-4f4e-8a44-98f666d08c0f.jpeg)

运行上面的代码后，结果如图1-6所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303342564-9350c4d3-34af-4a5d-81df-0d518ae445d3.jpeg)

图1-6　案例运行结果

我们看到，这个案例在Jupyter Notebook中绘图成功。

注意

有些读者可能是第一次接触Jupyter Notebook，不知道如何导入.ipynb 文件，这里简单介绍一下。当我们打开Jupyter Notebook 后，默认情况下，在当前目录中找不到案例文件first_start.ipynb，可以按以下步骤导入这个文件。

打开Jupyter Notebook 网页后，单击“Upload”按钮，如图1-7 所示。这时会弹出一个文件管理器窗口，选择文件first_start.ipynb，然后再次单击“Upload”按钮，就会在当前目录下看到first_start.ipynb 文件，双击该文件打开即可。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303342930-becdd08a-8403-4540-b58d-b7b8bdc36179.jpeg)

图1-7　加载文件

## 1.6　使用离线绘图库

通过前面的案例，我们可以看到 Plotly的绘图结果虽然美观，但是绘图速度太慢，原因是Plotly的服务器在国外，国内用户使用Plotly的在线绘图会有网络延迟。如果仅有在线绘图，恐怕Plotly不会发展得这么快，一是如果用户都使用在线绘图，会导致官方的服务器压力增大，这样免费服务无法长久维持下去或体验越来越差；二是这种绘图速度国内用户是无法接受的，所以开源的动态绘图模块 Plotly支持离线绘图功能。

Plotly的离线绘图功能允许在没有网络的情况下绘图，并把图像保存到本地。有两种方法可以实现上述功能：plotly.offline.plot ()和plotly.offline.iplot ()。

● 使用plotly.offline.plot ()方法会在本地新建一个HTML文件，并可以选择是否在浏览器中打开这个文件。

● 使用plotly.offline.iplot ()方法会在Jupyter Notebook 中直接绘图，而不需要新建一个HTML文件。

案例代码如下（见文件Chapter01/first_offline_start.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303343623-68cc5550-a7ca-431e-9826-e25e801563ee.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303344198-ba7f7829-f69d-46cf-b446-28e7df570761.jpeg)

运行以上代码，结果如图1-8所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303344787-394d3ffd-0861-4a86-ab8c-611917f14f3c.jpeg)

图1-8　案例运行结果

在 Jupyter Notebook中需要注意的是，这里需要添加一个初始化步骤，在开始绘图之前要加入一行代码。

plotly.offline.init_notebook_mode()

详细代码如下（见文件Chapter01/first_offline_start.ipynb）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303345256-43ba3fb3-0cab-4968-82ea-d2d0e69a5bbb.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303345802-e6c593b1-e575-426e-857f-132f22fcca58.jpeg)

代码运行结果如图1-9所示，与上一个案例的输出效果一样。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303346265-a76140e7-ef47-4340-950f-b6ca9fd52180.jpeg)

图1-9　案例运行结果

由于在线绘图和离线绘图的绘图结果没有什么不同，所以对于在线绘图，读者可以自己动手修改代码。

## 1.7　参数解读

py.plot是绘制图形的主函数，其主要参数如下。

● show_link：默认为True，显示右下角的链接。

● link_text：右下角显示的文字，默认为Export to plotly.ly。

● validate：默认为True，确保所有关键字是有效的。但是当需要额外、非必需的关键字或plotly.js版本比graph_reference.json版本旧时，会忽略这部分内容。

● filename：设置绘图结果的存储路径，默认为temp-plot.html。

## 1.8　查看帮助

查看帮助的操作很简单，只需要如下简单的两行代码。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303346766-99682635-6955-4c7a-9af1-fc64d860e7ce.jpeg)

对于使用Jupyter Notebook的读者，可以使用如下代码查看帮助。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303347219-bbcb652a-8607-484e-bdbf-6d5725afee91.jpeg)

对于离线绘图模式，有如下两种查看帮助的方法。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303347795-f15b5175-2733-4b88-af42-801c7a7afb91.jpeg)

其中一个查看帮助的结果代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303348353-969c1339-86a7-49c0-9bea-dcfc7d15a7d7.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303348955-8f33fd16-7f4e-4e22-81fc-9afc00d26b7b.jpeg)

# 第2章　Plotly基础图形

Plotly绘图模块库支持的图形格式很多，其绘图对象包括如下几种。

● Angularaxis：极坐标图表。

● Area：区域图。

● Bar：条形图。

● Box：盒形图，又称箱线图、盒子图、箱图。

● Candlestick与OHLC：金融行业常用的K线图与OHLC曲线图。

● ColorBar：彩条图。

● Contour：轮廓图（等高线图）。

● Choropleth：等值线图。

● Line：曲线图。

● Heatmap：热点图。

● Histogram：直方图。

● Histogram 2d：2D平面直方图。

● Histogram 2d Contour：二维轮廓直方图。

● Pie：扇形图。

● Scatter：坐标分布图（包括线形图、散点图）。

本章将介绍最常用的几种图形格式：线形图、散点图、条形图、饼图、直方图、面积图、甘特图，以及金融行业常用的K线图等。

## 2.1　基础案例解读

下面通过案例介绍在Python语言中使用Plotly绘图模块库。由于使用在线绘图模式绘图速度较慢，而且使用在线绘图模式需要注册账号，所以这里只介绍离线绘图模式。

案例2-1的文件名是first_start_introduction.py，讲解使用Plotly绘图模块库进行最简单的绘图。

为了便于逐行讲解案例，此处采用直接截图的方式展示代码，如图2-1所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303349385-cfc25485-1b8c-4b07-b908-c5316f5b30ce.jpeg)

图2-1　案例2-1代码截图

案例2-1代码逐行说明如下。

● 第1行，说明该代码文件使用的是UTF-8编码格式，也是Python的例行文件头。

● 第2～4行，导入（import）所需的模块库。

● 第6行，定义一个名为trace0的变量，用于保存绘图数据；Plotly一般称一个绘图对象为 trace（画痕、画轨、画迹）；每个绘图对象都由 Plotly模块库里面的graph_objs（图像对象）子模块的Scatter（数据布局）对象定义；Scatter对象的输入数据与 Plotly绘图模块库中的许多函数和对象一样，都是字典格式，而且接受多种复杂的复合字典格式。

● 第7～8行，定义变量trace0的x和y坐标，坐标采用列表数据格式，坐标x、y的数据长度必须一样，不然会出现空缺坐标；其中的x、y字符是Plotly模块库Scatter对象的内部变量名称，类似关键字。

● 第10～12行，定义另外一条曲线trace1的坐标数据，细节参见第6～8行的说明。

● 第14行，定义一个变量名data，通过pygo模块库的Data函数，把代表两条曲线的变量trace0和trace1定义为一组图形数据，注意Data函数的输入参数是列表数据格式，所以要在变量trace0和trace1外面加上表示列表的“[]”符号。

● 第16行，根据data变量的数据绘制图形。若代码无误，正确运行后，程序会自动调用浏览器，打开生成的图形，并提供互动显示，运行结果如图2-2所示。

● 第20行，运行结束后，输出“ok”信息。本程序运行后，输出的图形是通过浏览器显示的，有时浏览器在后台，不知道程序运行已经完成，所以在程序最后增加了一行运行结束的提示信息。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303349969-17f97a73-4dcf-4b33-a4c3-0ccdb1a2b283.jpeg)

图2-2　案例2-1 运行结果

案例2-1的第17行和第18行代码表示不同的输出模式，下面详细说明。

第16行中的filename参数，文件名格式必须以“.html”为后缀，以“.htm”为后缀会出错，读者可以尝试一下。

运行第17行和第18行代码时，请先屏蔽第16行代码，以免混乱。

第17行不使用filename参数定义文件名，Plotly模块库会自动在当前代码目录下生成一个名为temp-plot.html的文件，并自动用浏览器打开。对于多个图形，Plotly模块库会生成多个HTML文件，再用浏览器自动打开，用户需要自己设置文件名，否则新的图形文件会覆盖旧的图形文件。

第18行使用image参数，设置输出的静态图片格式为PNG格式，image参数支持PNG、JPEG、SVG、WebP格式，默认是None（无）。

与其他绘图模块库不同，Plotly生成的不是图形文件，而是一个内置JavaScript脚本的HTML网页文件，最终的图像文件需要调用浏览器的渲染引擎才能生成。

用户设置image图形输出格式后，浏览器会弹出一个下载图片对话框，需要用户手动保存输出的图形，如图2-3所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303350439-31230c23-c993-4bbb-8262-94dbed4c1b9f.jpeg)

图2-3　下载图片对话框

可能因为Plotly绘图模块库重点是云端及商业用户，所以对离线用户有些限制，这也算是目前Plotly的一个小bug，希望未来的版本能够改进。

## 2.2　基本绘图流程

经过以上分析，使用Plotly绘图模块库进行绘图的完整流程应该包括以下命令。

● 添加图轨数据（add_trace），使用的是Scatter等函数命令。

● 设置画面布局，使用layout命令。

● 集成图形、布局数据，命令有Data、Figure。

● 绘制图形的输出，命令是offline.plot，自定义的短命令是pyplt。

这个绘图流程对绝大部分Plotly绘图案例都适用，接下来讲解Plotly的一些常见图形的绘制方法。

## 2.3　散点图

### 2.3.1　基本案例

线形图又称为曲线图，是最常用的图形类型。与传统的绘图软件不同，Plotly没有独立的线形图函数，而是把线形图与散点图全部用Scatter函数实现。

下面的代码（见文件scatter_basic_demo.py）是基本散点图的绘制方法，包括线形图与散点图两种图形的混合。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303350984-f4ccaacf-8e12-4b57-9de7-0320c4afc597.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303351367-66aa5f0f-650b-4ce3-9374-0a9c31737e37.jpeg)

代码运行结果如图2-4所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303351597-22de855c-8021-41cd-8c4f-d90b86db2a80.jpeg)

图2-4　代码运行结果

查看案例源码可以看出，markers、lines和lines+markers三个图形的输出格式不同，是因为Scatter函数中的mode参数不同：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303352064-792855d1-a162-4f1f-8e86-0d68a49b2741.jpeg)

### 2.3.2　样式设置

下面的代码（见文件scatter_style.py）用来设置点的大小和颜色，以及线条的大小和颜色。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303352645-2679fcfd-22a8-4733-9000-c4e09bfbf487.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303353134-f6330f66-5965-4e43-bb57-0945df406029.jpeg)

代码运行结果如图2-5所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303353663-6e17f4d8-0cc6-414e-81c9-12fa25ac7409.jpeg)

图2-5　代码运行结果

在这个案例中，重要的是marker参数的设置：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303354093-9b1f1751-19ac-4760-8643-7581344806c9.jpeg)

这里size设置的是点的宽度，width设置的是线条的宽度，第一个color设置的是点的颜色，第二个color设置的是线条的颜色，读者可以对这些参数进行修改，实际验证一下。

需要注意的是，Plotly中的这些参数在其他绘图函数中可以重复使用，这也是Plotly人性化的地方。

### 2.3.3　应用案例

本案例的文件名是scatter_apply.py，讲解Scatter函数的使用方法，绘制曲线图与散点图，以及曲线图与散点图的组合图，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303354639-16431536-fd4e-417e-828b-e22c5b13684d.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303355084-bdebd965-494d-487d-8e16-e3edce83b89b.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303355334-c48fbe4f-85db-4db7-a4fc-6b4e3efac55e.jpeg)

代码运行结果如图2-6所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303355686-1c6bafc8-9325-4227-89dd-a88a3c148084.jpeg)

图2-6　代码运行结果

### 2.3.4　参数解读

使用Scatter函数可以绘制线形图与散点图，主要参数如下。

● connectgaps：布尔变量，用于连接缺失数据。

● dx、dy：x、y坐标轴的步进值，默认值是1。

● error_x、error_y：x、y出错信息。

● fillcolor：填充颜色。

● fill：填充模式，包括格式、颜色等。

● hoverinfo：当用户与图形互动时，鼠标指针显示的参数，包括x、y、z坐标数据，以及 text（文字信息）、name（图形名称）等参数的组合，可使用+、all、none和skip（忽略）作为组合连接符号，默认是all（全部消失）。

● hoveron：当用户与图形互动时，鼠标指针显示的模式，包括points（点图）、fills（填充图）和points+fills（点图+填充图）三种模式。

● ids：在动画图表中，数据点和图形key键的列表参数。

● legendgroup：图例参数，默认是空字符串。

● line：线条参数，包括线条宽度、颜色、格式。

● marker：数据节点参数，包括大小、颜色、格式等。

● mode：图形格式，包括lines（线形图）、markers（散点图）和text（文本），使用+或none等符号进行模式组合。

● name：名称参数。

● opacity：透明度参数，范围是0～1。

● rsrc、xsrc、ysrc、tsrc、idssrc、textsrc、textpositionsrc：字符串源数组列表，可作为Plotly网格标识符，用于设置特殊图表所需的r参数、x参数、y参数、t参数、ids参数、text（文本）参数和textposition（文本位置）参数。

● r、t：仅用于极坐标图，r用于设置径向坐标（半径），t用于设置角坐标。

● showlegend：布尔变量，用于切换图标显示。

● stream：数据流，用于实时显示数据图表。

● textfont：文本字体参数，包括字体名称、颜色、大小等。

● textposition：“文本”元素的位置参数，包括top left（左上）、top center（中上）、top right（右上）、middle left（左中）、middle center（中心）、middle right（右中）、bottom left（左下）、bottom center（中下）、bottom right（右下）模式，默认是middle center（中心）模式。

● text：文本数据，设置与每个“（x，y）对”关联的文本元素和数组列表格式，默认是空字符串。

● type：数据显示模式，包括constant（常数）、percent（百分比）、sqrt（平方根）、array（数组）模式。

● x0、y0：坐标轴起点坐标。

● xaxis，yaxis：x、y 坐标参数。

● xcalendar、ycalendar：坐标时间参数的格式，默认是公历（gregorian），支持gregorian、chinese、coptic、discworld、ethiopian、hebrew、islamic、julian、mayan、nanakshahi、nepali、persian、jalali、taiwan、thai和 ummalqura 格式。

● x，y：设置x、y轴的坐标数据。

## 2.4　气泡图

气泡图的实现方法与散点图的实现方法类似，修改散点图中的点的大小，就变成了气泡图。

### 2.4.1　基本案例

下面的代码（见文件bubble_basic_demo.py）用来说明气泡图的基本绘制方法。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303356166-4f10aad9-3479-4fca-800c-c2d317e0e57e.jpeg)

代码运行结果如图2-7所示。

以上代码的核心代码如下，用来定义每一个点的大小：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303356396-f1d3ddc6-6ed0-4cc0-8761-6b3832a8b243.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303356742-2a698658-1a37-4ac4-80a6-cf61e871cd51.jpeg)

图2-7　代码运行结果

### 2.4.2　样式设置

下面的代码（见文件bubble_style.py）用来指定每个点的大小、颜色、悬浮文字和是否显示颜色条。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303357276-561d3dd2-194f-4ef1-b882-2cf8e823ceb7.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303357809-516eb3f3-cbe8-490f-94a5-1942599c373f.jpeg)

代码运行结果如图2-8所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303358313-15d0ffd8-ebc1-4a69-ae91-ec2f56998737.jpeg)

图2-8　代码运行结果

以上代码的核心代码如下，text指定每个点对应的悬浮文字（

表示换行），color指定每个点的颜色，opacity指定每个点的透明度，size指定每个点的大小，showscale=True表示显示右边的颜色条的大小。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303358862-1dc02468-459f-4dee-8d7c-63a488d0edb1.jpeg)

### 2.4.3　缩放设置

调节气泡尺寸的大小可通过sizeref参数进行设置，当sizeref值大于1时，将减小气泡的大小；当 sizeref值小于 1时，将增大气泡的大小，详情参考页面https://plot.ly/python/reference/#scatter-marker-sizeref。本案例代码（见文件bubble_scale.py）如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303359342-199558f2-16b1-4029-b37f-bab11abef46d.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303359756-335def55-a90e-40ad-bd43-25d355d417d5.jpeg)

代码运行结果如图2-9所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303360346-3af8070d-9314-40c0-8870-2108475e50c2.jpeg)

图2-9　代码运行结果

与之前的代码相比，多了如下参数内容：参数sizeref=2表示将气泡大小设置为原来的1/2；参数sizemode有diameter和area两个值，diameter表示按直径缩放，area表示按面积缩放，这里使用的是按面积缩放。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303360739-8d18ed47-0a44-404c-af13-2fa23e7171a5.jpeg)

### 2.4.4　参数解读

气泡图与散点图使用的是同一个函数，因此大部分参数在2.3.4小节已经介绍过了，这里对本节所涉及的参数进行补充说明。

● text：列表，元素为相应节点的悬浮文字内容。

● marker：数据节点参数，包括大小、颜色、格式等，有如下设置项。

➢ size：列表，元素为相应节点的尺寸大小。

➢ sizeref：缩放的比例，如设置为2，则缩小为原来的1/2。

➢ sizemode：缩放的标准，默认以 diameter（直径）缩放，也可选择以 area（面积）缩放。

➢ color：列表，元素为相应节点的颜色。

➢ showscale：默认为False，不显示右侧的颜色条，也可以选择True。

➢ opacity：列表，元素为0～1之间的数，表示相应节点的透明度。

## 2.5　线形图

### 2.5.1　基本案例

线形图的绘制在散点图的绘制中提及过，用Plotly绘制线形图使用Scatter函数。如图2-10所示是线形图的简单实现，见文件2.5_LineChart_1.py。本案例使用Pandas生成时间序列作为横轴标签，对浦发银行2017年3月1日—2017年4月28日的股价涨跌幅进行了展现，数据来源是Wind数据库。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303361078-b1d1ffa2-ae96-4306-b558-1b532a717255.jpeg)

图2-10　基本线形图

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303361550-dd8f83e5-13ce-4b74-9f9e-42054aa275fd.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303361878-d247e1bf-f424-443b-8940-ddbcdde532ca.jpeg)

### 2.5.2　数据缺口与连接

在实际应用过程中，数据集往往并不完美，可能有缺失的数据，在 Plotly中可以通过设置 Scatter函数中的connectgaps属性来显示这些数据缺口或对缺口进行连接。如图2-11所示是在官方案例的基础上进行的调整，包含了多条线形图的绘制、线条样式设置，以及数据缺口保留与连接的控制，见文件2.5_LineChart_2.py。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303362439-11a91466-c85d-4eb1-9a63-45ad291b464c.jpeg)

图2-11　线形图缺失数据展示与连接

该案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303362848-16611eb0-b909-49e8-aea7-7249770c1d3c.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303363179-e91bbd63-ad25-42ed-8976-4b40e9765311.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303363526-d8cf1d65-d585-43ce-ba25-0a530e9a98aa.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303363981-42b739ca-f868-4baa-8daf-79e722b4c276.jpeg)

在数据部分，原先的缺失数据被设置为None。在Scatter函数中，设置connectgaps属性为Fasle，表示不连接，显示数据缺口；设置connectgaps属性为True，表示连接缺失值左右相邻的数据点。在图2-11中，对“High 2014”线形图进行了连接，其他线条则采用显示缺口的形式。

Scatter函数中的line属性用于对线形图的样式进行控制；color用于设置颜色；width用于设置宽度；dash用于设置类型，dash表示由短线组成的虚线，dot表示由点组成的虚线，dashdot表示由点和短线组成的虚线。

### 2.5.3　数据插值

通过调整Scatter函数line属性中的shape值可以对插值的方法进行控制，完成数据点的插值设置。插值的方法简单来说就是根据已有的零散数据点，找到一条满足一定条件的曲线，使之经过全部的数据点。Plotly提供的插值方法有 6种，分别是'linear'、'spline'、'hv'、'vh'、'hvh'和'vhv'。例如，设置 shape='spline'，表示通过三次样条方法对数据点进行插值。图2-12所示为官方案例，展示了6种不同的插值方法，见文件2.5_LineChart_3.py。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303364528-d6a395f4-d235-4953-8529-b09d3cbbee25.jpeg)

图2-12　不同插值方法的对比

该案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303364926-17aa731b-ea5f-44ae-be8f-cb8329d42dd0.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303365816-c0a9a43f-5799-489d-b3f9-82d30a0c02f2.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303366156-4a555502-c2e5-4a03-bd84-25f2acf5faee.jpeg)

### 2.5.4　填充线形图

填充线形图是线形图的一种衍生，通过选择性地显示线条和对线条图进行填充来完成。如图2-13所示展示了恒宝股份、湘潭电化、大港股份的股票在一段时期内开盘的最高价与最低价，每条可见线条对应股票的开盘价，线条的上影线对应当天的最高价，线条的下影线对应当天的最低价，见文件2.5_LineChart_4.py。

要绘制这样一个可视化图形，先把其拆成两部分，一部分是对三条可见线条（开盘价线条）进行绘制，另一部分是对三条填充线条进行绘制。下面这段代码完成了这个操作。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303366448-f98a20eb-5b05-452e-a2ab-6db6a0af8365.jpeg)

首先，x + x_rev是从1到10、再从10到1的序列，y1_upper + y1_lower是从第1天的最高价至第10天的最高价、再从第10天的最高价至第1天的最高价的序列，注意这里的y1_lower已经在数据设置部分设置为逆序，由此可以得到两条线，通过对 fill属性的设置，即可对两条线之间的部分进行颜色填充，最后设置line中的color属性为'transparent'，对线条进行隐藏，运行结果如图2-13所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303366933-c8428ca6-1c85-4fec-9736-97474bb6dccd.jpeg)

图2-13　填充线形图

该案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303367502-37254e2c-99bd-43ec-8d79-9de74c80bdb1.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303368014-37297008-723c-4d90-8a72-23ac18dd0f6c.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303368510-8d45b4d7-4ee9-4672-bc3c-18a7a74f2fcd.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303368971-5892ddbc-b521-415b-8eaa-ec4b8c3d3bad.jpeg)

### 2.5.5　应用案例

新闻来源统计线形图案例的运行结果如图2-14所示，代码见文件2.5_LineChart_5.py。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303369605-8632abad-6316-476c-9172-b6c71e332182.jpeg)

图2-14　新闻来源统计线形图

该案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303370088-aced0ba5-4357-413a-b080-688d35e1889e.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303370528-84335775-0f24-45e8-a459-b568e99f0d5f.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303371051-49efa502-736f-4bd6-a568-cacc791bfcaa.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303371587-e574f0ec-2919-466c-9f96-3148265303ab.jpeg)

### 2.5.6　参数解读

由于线条图的绘制方法与散点图的绘制方法是一样的，都使用Scatter函数，所以它们的参数也是一样的，读者可以参考2.3.4节的相关内容。

## 2.6　柱状图

### 2.6.1　基本柱状图

使用Plotly绘制基本柱状图最重要的函数是graph_objs中的Bar函数，通过传递数据，可以设置柱状图的样式。在Layout中对barmode进行设置可以绘制出不同类型的柱状图。如图2-15所示是柱状图最简单的实现，见文件2.6_BarChart_1.py，该案例包括使用Bar函数传递数据和变量，以及在Layout中设置标题、x轴范围。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303372138-5ca3829e-798c-4cd9-a05a-36fe5fa63110.jpeg)

图2-15　基本柱状图

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303372689-3f5290f7-8cfa-4a03-a044-8bcdc7188171.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303373184-c7726132-f30e-4815-8071-bf7437483f47.jpeg)

### 2.6.2　柱状簇

除基本柱状图外，还有柱状簇，在基本柱状图代码的基础上加入多组数据即可实现柱状簇。图2-16所示为国际贸易板块中广东明珠、五矿发展与上海物贸这3只股票从2016年第三季度到2017年第一季度的净资产收益率（%）变化，数据来源是同花顺。

本案例见文件 2.6_BarChart_2.py。从纵向看，上海物贸三个季度的数据分别为4.12、3.65和2.15；从横向看，data1中的数据y = [4.12, 5.32, 0.60]是3只不同股票对应的资产收益率，通过这种配置数据的方式可以对柱状簇图进行实现。本案例通过柱状簇图对比了2016年第三季度、2016年第四季度与2017年第一季度3个不同时间段同一只国际贸易板块股票的资产收益率，而且对同一时间段不同股票的资产收益率的差异也进行了展示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303373704-a73e3ac2-4917-427d-bd6e-ef8376ca58c9.jpeg)

图2-16　国际贸易板块净资产收益率的对比

本案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303374240-a89799d6-b2fe-48e3-9aa7-5f2e0704ec45.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303374775-707ed5ab-a9d0-42e9-b66f-a3faf2a97b13.jpeg)

### 2.6.3　层叠柱状图

层叠柱状图的绘制与柱状簇图的绘制大同小异，相当于对同一簇的柱状图进行叠加，实现的方式是对Layout中的barmode属性进行设置，即设置barmode='stack'，其余参数与柱状簇图相同。图2-17所示的层叠柱状图展示了华夏新经济混合、华夏上证50、嘉实新机遇混合、南方消费活力混合和华泰柏瑞这5只基金的资产配置比例，数据来源是和讯网。

该案例见文件2.6_BarChart_3.py，通过设置barmode属性实现柱状图的层叠。通过层叠柱状图可以很清楚地看出不同基金的资产配置情况，如华夏新经济混合、华夏上证50、华泰柏瑞这3只基金有很大的股票投资权重。通过观察同一只基金的资产配置比例，可以对其风险属性有更具体的了解。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303375404-f4415d66-302a-46d7-b97e-2ff1ed6e70f4.jpeg)

图2-17　基金资产配置比例图

该案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303375842-ef79baf5-051d-4053-a293-5f17e2cd3b48.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303376327-370fd60b-a4bc-4cf5-a4d7-5335ad51342d.jpeg)

### 2.6.4　瀑布式柱状图

瀑布式柱状图是层叠柱状图的一种衍生，通过选择性地显示层叠部分来实现柱状图的悬浮效果。如图2-18所示的瀑布式柱状图展示了万科A股票在2016年的资产负债结构，其中非流动负债与所有者权益柱状图的悬浮效果通过设置trace0中的y值实现，如y=[0, 57999848, 0, 66899764, 0]，表示第1、3、5根柱状图从0开始显示，第2根柱状图从57999848开始显示，第4根柱状图从66899764开始显示，实现的方式是将trace1所表示的柱形颜色设置为白色，即color='rgb(255, 255, 255)'，起到选择性显示的效果，见文件2.6_BarChart_4.py。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303376725-220620a6-8e70-40d2-b722-c1ae732b9217.jpeg)

图2-18　万科A股票资产负债结构

该案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303377393-f6cf1c02-9a16-4804-b044-96a08a14612e.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303377910-1dfbf8e1-8fee-43c4-8cbb-05795286ad31.jpeg)

### 2.6.5　图形样式设置

对柱状图颜色与样式的设置通过下面这个案例来说明。图2-19所示的柱状图展示了有色金属板块AU、AG、SN、PB和CU这5种合约在某一个交易日的最高涨幅与波动率，柱形的宽度表示相对波动率的高低，柱形越宽，波动率越大；高度表示涨幅，红色柱状图突出了涨幅上升的商品期货，绿色柱状图突出了涨幅下跌的商品期货。

本案例见文件2.6_BarChart_5.py，包括设置柱状图的颜色样式、用line设置柱状图外围的框线、用width设置柱状图的宽度、用opacity设置柱状图颜色的透明度，以及设置Layout中的xaxis令x轴的标记旋转-45°。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303378514-cd6dbdfd-81e2-4f2d-84f7-c17cde495dd1.jpeg)

图2-19　有色金属板块主力合约日内最高涨幅与波动率图

本案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303379045-5c06e21f-2133-4ece-99db-7372afdff467.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303379550-aac2e025-1a0d-443d-94cc-6a676b2fc616.jpeg)

### 2.6.6　应用案例

经过对前面案例的学习，读者对柱状图的绘制已经很清楚了，在实际运用时，往往需要从dataframe中获取高频金融数据进行可视化，下面的案例讲解从导入CSV文件到做出成交量柱状图的过程，更加贴近现实中的应用，运行结果如图2-20所示，见文件2.6_BarChart_6.py。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303380023-815ab01e-6022-4060-95d1-8de3fa887dd5.jpeg)

图2-20　成交量柱状图

本案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303380546-5d06ead4-e82b-48f3-8e9f-6d1558ee85c1.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303381045-14615486-a953-40d7-9b0a-010592f490cc.jpeg)

### 2.6.7　参数解读

本小节对绘制柱状图所需 Bar函数的常用参数进行详细讲解，包括设置柱状图所需的数据和属性，常用参数如下。

● base：柱状图的起始参数。

● dx、dy：x、y坐标轴的步进值，默认值是1。

● error_x、error_y：x、y出错信息。

● hoverinfo：当用户与图形互动时，鼠标指针显示的参数，包括x、y、z坐标数据，以及text（文字信息）和name（图形名称）数据等参数的组合，使用+、all、none和skip（忽略）作为组合连接符号，默认是all（全部显示）。

● insidetextfont：内置文本的字体格式参数。

● legendgroup：图标参数，默认是空字符串。

● marker：数据节点参数，包括大小、颜色、格式等。

● name：名称参数。

● offset：坐标位移参数。

● opacity：透明度参数，范围是0～1。

● orientation：图形显示方向参数，包括v（垂直模式）和h（水平模式）。

● outsidetextfont：外置文本的字体参数。

● rsrc、xsrc、ysrc、textsrc、textpositionsrc、offsetsrc、basesrc、widthsrc：字符串源数组列表，作为Plotly网格标识符，用于设置一些特殊图表所需的r参数、x参数、y参数、text（文本）参数、textposition（文本位置）参数、offset（位移）参数、base（起点）参数、width（宽度）参数。

● r、t：仅用于极坐标图，r用于设置径向坐标（半径），t用于设置角坐标。

● showlegend：布尔变量，用于切换图标显示。

● stream：数据流，用于实时同步数据图表。

● textfont：文本字体参数，包括字体名称、颜色、大小等。

● textposition：“文本”元素的位置参数，包括top left（左上）、top center（中上）、top right（右上）、middle left（左中）、middle center（中心）、middle right（右中）、bottom left（左下）、bottom center（中下）、bottom right（右下）模式。默认是middle center（中心）模式。

● text：文本数据，设置与每个“（x,y）对”关联的文本元素，数组列表格式，默认是空字符串。

● type：数据显示模式参数，包括constant（常数）、percent（百分比）、sqrt（平方根）和array（数组）。

● visible：布尔变量，切换图形显示开关。

● width：柱状图的条形宽度。

● x0、y0：坐标轴起点坐标。

● xaxis、yaxis：x、y 坐标参数。

● xcalendar、ycalendar：坐标时间参数格式，默认是公历（gregorian）。

● x、y： x、y轴的坐标数据。

## 2.7　水平条形图

### 2.7.1　基本案例

使用 Plotly绘制水平条形图与绘制柱状图类似，只是需要在 Bar函数中设置orientation = 'h'，其余参数与柱状图相同，也可以通过设置barmode = 'stack'绘制层叠水平条形图与瀑布式水平条形图。本节对基本水平条形图与层叠水平条形图的绘制进行讲解。图2-21所示为基本水平条形图，展示了万科A、国农科技和世纪星源这3只股票在 2016年净资产收益率的对比，数据来源是 Wind资讯。本案例见文件2.7_HBarChart_1.py。

本案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303381533-d363f715-0ae0-4f29-8cf2-9f66d8ad329f.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303381931-c03004ae-2075-48b3-bb4b-e586a11a8720.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303382585-60991cdc-cb97-49ef-b0c2-803d3cb5b86e.jpeg)

图2-21　基本水平条形图

层叠水平条形图只需设置barmode = 'stack'即可，相应数据和样式设置与基本水平条形图类似，层叠水平条形图的案例如图2-22所示，见文件2.7_HBarChart_2.py。本案例展示了AU.SHF、AG.SHF、CU.SHF这3个期货品种对海通期货、永安期货及中信期货的多头持仓状况，数据来源是Wind资讯。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303383070-ab2df4ed-2be1-4551-92fa-5f9c16dd62a6.jpeg)

图2-22　贵金属期货持仓量对比

本案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303383653-b65c4cfe-4a8e-48b6-8968-77164e63aa97.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303384159-68f72b6d-4394-4067-83f9-050c66aad1e3.jpeg)

### 2.7.2　应用案例

本小节详细介绍Plotly官方网站提供的一个较复杂的应用案例，综合了水平条形图与折线图的绘制、不同标签的添加、不同标注文字样式的设置、画布样式的设置等。为方便介绍，将逐段详细讲解代码功能，完整代码见文件2.7_HBarChart_3.py，如图2-23所示为最终的绘图结果。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303384742-22da016c-173a-4376-9ec9-a41fc22241c7.jpeg)

图2-23　水平条形图应用案例

下面这部分代码的功能是加载工具包与数据，y_saving中的数据用于左侧条形图，数据大小反映了条形的长度；y_net_worth中的数据用于右侧折线图，每个数据对应折线中的数据点；x_saving与x_net_worth中的数据对应左侧坐标轴上的标签。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303385139-09efe648-a441-4ee1-956a-df20b33d7267.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303385523-9d3e855b-e870-4f8c-aa08-d29406f5c773.jpeg)

完成工具包与数据的加载后，在trace0中使用Bar函数对条形图进行数据与样式设置，在trace1中使用Scatter函数对折线图进行数据与样式设置。color属性用于设置图形的颜色，已经在代码部分加以注释，其他参数可参考2.6.7节柱状图的参数，这里不再赘述。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303385885-4612317c-6b09-4499-866a-7e59d8234263.jpeg)

下面的代码分别对条形图与折线图的样式进行设置，yaxis1与xaxis1分别对应左边条形图的 x轴与 y轴格式；showgrid表示是否显示纵向或横向网格；showline表示是否显示左侧或下方轴线；showticklabels表示是否显示坐标轴上的标注；domain限定了坐标轴范围；legend用于设置图例，代码中包括了其位置与显示字体大小的设置；margin用于对整张图的留白区域进行设置，其中 l表示 left，r表示 right，t表示top，b表示bottom，分别控制四个方向；paper_bgcolor用于设置整张图的背景颜色；plot_bgcolor用于设置画布的背景颜色。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303386263-ad2ad943-5a8b-4b10-9c8d-af2032703ea3.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303386743-5a4c8522-b954-4438-871e-ec3ebbe28d41.jpeg)

下面这部分代码对数据注释进行了设置，包括使用font设置标签字体、颜色与大小，使用text设置文字内容与样式，使用showarrow判断是否添加从标签到数据点的箭头等。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303387247-1a63a261-58fa-44d9-8a54-9d0e0c35d58d.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303387832-ab00c465-7146-43a5-8531-d62ca0fb2356.jpeg)

下面这部分代码是对整体画布进行布局，用rows = 1、cols = 2划分为左右两块，shared_xaxes与shared_yaxes用于设置左右两边的图是否共享同一个坐标轴。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303388348-6880b607-6ab6-4193-b766-ab2de2a08b32.jpeg)

### 2.7.3　参数解读

由于水平条形图是由柱状图修改一个参数orientation = 'h'而来的，所以它们的其他参数是一样的，可以参考2.6.7节的相关内容。

## 2.8　甘特图

### 2.8.1　基本甘特图

甘特图（Gantt Chart）又称为横道图，通过条形来显示项目的进度、时间的安排等与时间相关的情况。本节讲解的甘特图案例来自对Plotly官方网站案例的修改，通过对代码与图的解读来了解与绘制甘特图。绘制甘特图的函数是Plotly.figure_factory中的create_gantt，通过传递包含事件（Task）与开始、结束（Start、Finish）时间的数据来绘制图表。

下面的案例中包含三组数据，横坐标从左向右，时间不断延续，越接近于左侧的条形，其对应事件发生的时间越早；反之越晚。甘特图中条形的长度代表事件持续期的长短。本案例见文件2.8_GanttChart_1.py，如图2-24所示为基本甘特图。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303388872-79e09f8a-65ae-4c5a-88b8-cbfa4c64fcb4.jpeg)

图2-24　基本甘特图

本案例代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303389406-4500a3f7-9174-4f14-8298-ae19e564cbed.jpeg)

### 2.8.2　甘特图（按数字索引）

将传入甘特图的数据按数字索引可以方便地对任务进行分类，本节案例的数据中包含了6项工作，每项工作后的complete属性即为其对应的索引值，在create_gantt函数中设置 index_col='Complete'，则有相同索引值的条形会呈现出相同的颜色，右侧的颜色条可以帮助用户根据颜色来判断任务大概对应的索引值是多少，这个数字的范围是0～100，用来反映工作完成的进度，100表示全部完成，0表示没有进展。本案例见文件2.8_GanttChart_2.py，如图2-25所示为按数字索引的甘特图。

本案例代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303389932-d6327917-1c11-4271-a3ec-eb1de74ab363.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303390400-d85e4ad8-0f17-46fe-9b99-8c1f09c55f5f.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303390934-db5a95e5-e1ff-4176-b8c6-6e33c67b086f.jpeg)

图2-25　甘特图（按数字索引）

### 2.8.3　甘特图（按类别索引）

对甘特图的另一种索引方式是按照类别索引，本案例中包含8项工作，每项工作（数据）中的Resource代表此项工作所属的状态，状态分为Complete、Incomplete和Not Started三种，通过设置create_gantt函数中的index_col='Resource' 即可完成通过Resource类别索引的目的。color属性用于设置不同状态对应的颜色，注意需要以字典的格式传递给create_gantt。本案例见文件2.8_GanttChart_3.py，如图2-26所示为按类别索引的甘特图。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303391490-7c8623c1-19af-4356-a667-ee995cda055e.jpeg)

图2-26　甘特图（按类别索引）

本案例代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303392056-a3bcb0a6-e8e8-472f-9d64-d2b76c1c286c.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303392487-29a577fc-7a10-4de0-91b9-ff8bce3cf91f.jpeg)

### 2.8.4　应用案例

下面的案例是按类别索引的甘特图，注意此案例中任务起止时间的单位精确到了秒，并且对条形的样式进行了设置，使用color设置不同类别任务条的颜色，使用bar_width设置任务条的宽度，使用showgrid_x与showgrid_y设置是否显示横、纵坐标轴，以及使用 title设置标题。本案例见文件 2.8_GanttChart_4.py，运行结果如图2-27所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303393024-15537f85-4aa5-4aec-9a14-f7e115d1dcd1.jpeg)

图2-27　按类别索引的甘特图应用案例

本案例代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303393561-ff16a26c-ac8a-4a6e-b0b1-91fcbccae07a.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303394114-fa0f4605-4809-4876-a51f-5a5e82ca0e90.jpeg)

## 2.9　面积图

### 2.9.1　基本面积图

使用 Plotly绘制面积图与绘制散点图和折线图相同，都使用 plotly graph_objs中的Scatter函数，不同之处在于面积图对于fill属性的设置，相当于在折线图的基础上对图形进行填充。如图2-28所示为基本面积图，展示了两个不同交易策略的净值曲线，为了方便，策略的每日收益率非真实数据，而是根据NumPy随机生成的数字。在图2-28中，使用mode属性隐藏了面积图的边界线，见文件2.9_AreaChart_1.py。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303394572-6ca7b2eb-62f8-42aa-9617-18460e37746d.jpeg)

图2-28　基本面积图

本案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303394943-e4e1efa1-e69c-44ec-a969-7748bfcecc5d.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303395257-b59631f4-45d4-40ea-a4fa-cce9ee450e5e.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303395675-0dc88757-88c7-4786-9b05-3938547ee5d4.jpeg)

### 2.9.2　内部填充面积图

内部填充面积图仅填充两条曲线交叉所形成的面积部分，同样通过设置 fill属性来完成，只需在原面积图的基础上设置第一条曲线无填充效果，即fill = None，再设置第二条曲线的填充的效果为tonexty，即fill = 'tonexty'。如图2-29所示为内部填充面积图，该图是在图2-28的基础上，通过修改fill属性完成的。本案例见文件2.9_AreaChart_2.py。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303396206-5c6f2e2a-a34f-4db9-98d7-44e702248cee.jpeg)

图2-29　内部填充面积图

本案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303396756-4b9526fb-1f03-4b17-95b6-245e054f2b87.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303397255-272e59b1-3e01-4d92-8ab4-abacfaf00943.jpeg)

### 2.9.3　堆积面积图

堆积面积图与层叠柱状图类似，都展示了数据累加的效果，不同之处在于对数据的设置，下面讲解堆积面积图的绘制，以及与层叠柱状图绘制的不同之处。为了更好地展示可视化效果，在层叠柱状图的基础上对数据进行了调整，见文件2.9_AreaChart_3.py。下面将堆积面积图中data1到data4中的数据单独列出，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303397781-3a9ec044-19a1-4a95-b782-b8f3fd7e4fa4.jpeg)

可以看出，data1中的y表示基金1到基金5中股票投资占总体投资的比例，与层叠柱状图相同；data2中的y表示基金1到基金5中股票投资与其他投资之和占总体投资的比例，而层叠柱状图data2中的y则表示基金1到基金5中其他投资占总体投资的比例。由此可见，从数据层面上讲，堆积面积图需要的是累加数据，而层叠柱状图只需要每部分的真实数据即可。

读者需要注意，在绘制层叠柱状图时需要设置stack模式，而绘制堆积面积图则不需要设置，这一点就是堆积面积图需要累加数据的原因，在本质上，堆积面积图的堆积效果是在同一个图形中绘制多个面积图来实现的。

堆积面积图的绘制效果如图2-30所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303398258-0a5a4cb6-567c-4771-9aab-719b25c26503.jpeg)

图2-30　堆积面积图

本案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303398852-c1d53213-f63d-429f-8b9d-ecb6643c7d42.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303399299-e30b0d25-cb29-4d10-8a7a-c59fe715d23e.jpeg)

下面对代码中涉及的一些参数进行讲解。注意data中的line参数，这里的line用于设置折线的样式，只有在显示折线时才有设置的意义，即mode = 'lines'时。本案例中还设置了宽度（width）与颜色（color），Layout中的yaxis设置包含了y轴坐标的范围range是0～100，坐标间隔dtick是20，后缀符号ticksuffix是%。

至此，虽然已经可以对堆积面积图进行绘制，但是如果只知道原始数据，则需要计算出累积数据才能进行绘图，下面提供一个方法来完成累计数据的计算。

假设只知道4组原始数据yi_org，通过使用句内for循环来计算累计数据，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303399880-768a7832-b2b9-41b9-9a22-f13f16e63871.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303400333-b42ea51f-484c-4896-b3a6-9610fe2e4b1c.jpeg)

## 2.10　直方图

### 2.10.1　基本直方图

使用Plotly绘制直方图需要用到graph_objs包中的Histogram函数。将数据赋值给函数中的x变量，即x = data，即可绘制直方图；若将数据赋值给y变量，则绘制水平直方图。histnorm是Histogram函数的另一个属性，默认状态下表示直方图的纵坐标落入区间内的样本数目；若设定histnorm = 'probability'，则纵坐标变为落入区间内的样本频率。Histogram函数的其他常用属性将在后面的案例中提到。下面的案例使用　NumPy生成随机数，对基本的直方图进行实现，见文件2.10_HistogramsChart_1.py。

基本直方图的绘制效果如图2-31所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303400879-2dddddf9-236c-4e0d-861d-3eefdf94644c.jpeg)

图2-31　基本直方图

本案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303401377-dfd10fdf-3384-4f48-a028-1d9c4fd7f698.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303402023-f89a0963-e135-4f56-8640-7f9881e8f5b3.jpeg)

### 2.10.2　重叠直方图

下面介绍重叠直方图的绘制，需要在 Layout中设置 barmode属性，将其改为'overlay'，如果不对其进行设置，会出现Plotly默认将两个直方图的柱形宽度强制变窄的情况，以满足重叠部分显示的需求。与Bar函数等相同，Histogram函数中也有opacity等通用属性，这里不再重复介绍。下面的案例使用 NumPy生成分别服从正态分布（Randn）与卡方分布（Chisquare）的两组数据，并使用直方图的形式加以展现，见文件2.10_HistogramsChart_2.py。

重叠直方图的绘制效果如图2-32所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303402446-c0dc2599-6a8f-4afd-aa48-b386d43f28d1.jpeg)

图2-32　重叠直方图

本案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303402951-ecd04004-11ce-49a9-992f-a5dd3079c243.jpeg)

### 2.10.3　层叠直方图

绘制层叠直方图同样需要设置barmode属性，将其设置为'stack'。下面的案例使用NumPy生成两组相同的正态分布数据，trace0显示的是第一组数据，trace1显示的是第一组数据与第二组数据叠加的效果，见文件2.10_HistogramsChart_3.py。

层叠直方图的绘制效果如图2-33所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303403347-951755a2-c11b-435d-8e39-138d5d9a86ec.jpeg)

图2-33　层叠直方图

本案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303403972-184d4c12-786d-4136-aadb-efe13213d11d.jpeg)

### 2.10.4　累积直方图

累积直方图是直方图的累积形式，即第n+1个区间的展示数目是第n-1个区间的展示数目与第 n个区间中实际样本数目之和，通过设置 Histogram函数中的cumulative属性实现，即cumulative=dict(enabled=True)。如图2-34所示是累积直方图的绘制效果，使用NumPy生成随机数据，见文件2.10_HistogramsChart_4.py。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303404504-1fdf4584-9ce6-4974-aba3-bd3295237fbb.jpeg)

图2-34　累积直方图

本案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303405052-645ad062-676e-4796-b3c2-9fe914382831.jpeg)

### 2.10.5　应用案例

plotly.figure_factory包中的distplot函数将直方图与核函数估计可视化融合在一起，只需要将数据传递给distplot函数，即可完成相应的绘图。下面的案例使用NumPy生成分别服从柯西分布、泊松分布、Gamma分布和指数分布的4组数据，并使用distplot函数展现直方图及对应的核密度估计函数，见文件2.10_HistogramsChart_5.py。

直方图综合案例的绘制效果如图2-35所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303405485-fd21085f-cfaf-4bd5-b58d-c6672c719f45.jpeg)

图2-35　直方图综合案例

本案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303406069-bfef3c60-c817-4556-8aff-305f68c230d4.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303406631-be92092e-8d3d-4604-97f0-7d3cbcefdb65.jpeg)

### 2.10.6　参数解读

下面讲解直方图综合案例中使用的create_distplot函数和histogram函数的常用参数。

● histnorm：设置纵坐标显示格式，可选参数有""、percent、probability、density、probability density。若为percent或probability，则表示纵坐标显示样本占总体的百分比，所有矩形的高相加为100%；若为density，则每个小矩形的面积为所在范围内的样本的数量，所有矩形面积相加为样本总数；若为probability density，则每个小矩形的面积为所在范围内的样本占总体的比例，所有面积数值相加为1。

● histfunc：指定分组函数，可选参数有count、sum、avg、min、max。若为count，则按照统计样本落在区间内的个数操作；若为sum、avg、min、max，则依次对样本区间内的样本求和、取平均值、求最小值和求最大值。

● orientation：设置图形的方向，有v和h两个可选参数，v表示垂直显示，h表示水平显示。

● cumulative：累积直方图参数，有enabled、directio和currentbin三个关键字。其中，enabled是布尔型，设置为True会显示累积直方图，设置为False则不对频率或频数进行累积；direction用于设置累积方向，确定频率是从1～0（降序），还是从0到1（升序）；currentbin有三个选择，即include、exclude、half，为了防止偏差，一般选择half。

● autobinx：布尔型，是否自动划分区间。

● nbinsx：整型，最大显示区间数目。

● xbins：设置划分区间属性，有start、end、size三个关键字。start设置起始坐标，end设置终止坐标，size设置区间长度。

## 2.11　饼图

### 2.11.1　基本饼图

使用Plotly绘制饼图需要使用graph_objs中的Pie函数。Pie函数中最常用的两个属性一个是 values，用于赋给其需要可视化的数据；另一个是 labels，表示不同数据对应的标签。样式设置与前面几种图形的样式设置类似，这里不再赘述。如图2-36所示是饼图的绘制效果，展示了基金的资产配置结构，见文件2.11_PieChart_1.py。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303407228-4b3826e3-06c4-404d-a284-98e6c1602af3.jpeg)

图2-36　饼图

本案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303407775-f4c0a0fc-6458-4f90-8a82-af2adf74386d.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303408307-da26cec5-bc6b-4ea1-bcc0-854cb82ac855.jpeg)

### 2.11.2　环形饼图

绘制环形饼图，只需在Pie函数中设置控制环形中心空白大小的hole属性即可实现。Pie函数中的hoverinfo属性用于控制当用户将鼠标指针放到环形图上时显示的内容，设置为“label + percent”表示显示标签加数据所占的比例。如图2-37所示是环形饼图最简单的实现，展示了工作进度，见文件2.11_PieChart_2.py。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303408822-a1479bbb-b793-4686-8e12-171608349675.jpeg)

图2-37　环形饼图

本案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303409271-67908c01-e6d7-48c8-94cd-6bbee2696f25.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303409813-305504b9-f635-4781-9e7f-36c2478b19de.jpeg)

### 2.11.3　样式设置

对饼图颜色与样式的设置通过下面这个案例来说明。如图2-38所示的饼图展示了浦发银行五大流通股东的持股比例，本案例包括设置饼图的颜色、边框和标签等属性，见文件2.11_PieChart_3.py。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303410331-37f50721-5385-46f5-98d7-686586409b73.jpeg)

图2-38　浦发银行五大流通股东持股比例图

本案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303410847-c0f7c0e4-850c-45a6-a04c-e52bf59d95ee.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303411366-0b3ef329-e54b-48e1-9ee3-eeb8cc2e2017.jpeg)

下面对Pie函数中涉及的参数进行讲解。通过设置rotation参数可以对饼图进行旋转，其取值为0～360；opacity参数用于设置透明度；showlegend参数是布尔类型，True表示展示图例，False表示隐藏图例；pull参数用于设置组成饼图的各个扇形的突出程度，0表示不突出，本例中通过设置 pull参数为[0,1,0,0,0,0]，使其中一个扇形突出；textinfo参数用于设置显示在扇形上的是具体数值（value）还是比例（percent）；textfont参数用于设置所显示内容的样式，本例中设置了字体大小（size）和字体颜色（color）；marker参数用于设置每个扇形的样式，其中colors用于设置颜色，line用于设置扇形边框的样式。

### 2.11.4　应用案例

本节对饼图进行实战应用。如图2-39所示，包含4个饼图，展示了有色金属板块AU、AG两大合约的多空持仓状况。本案例包括绘制子图、添加标签、调整位置等，见文件2.11_PieChart_4.py。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303411931-c78208cd-535f-453c-91f3-f44a76210405.jpeg)

图2-39　饼图应用案例

本案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303412419-3973a7ff-445c-4a8a-a35a-33a44428c493.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303412937-9ff7173d-5718-4252-b25a-ece27baddfb9.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303413414-62df60d6-545c-45b2-8955-970222a4b0ac.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303413959-99ac0bf8-7bcf-4737-8e75-24f959ee50e6.jpeg)

data部分有四个大括号（{}），每个大括号代表一个子饼图，例如下面的代码就表示一个子饼图。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303414505-d342fef7-1c29-4988-8e32-f99fd1c03275.jpeg)

其中，values中是饼图的数据；labels包含饼图中每一块扇形的标签；domain表示饼图的位置；name是子饼图的名称；hoverinfo用于设置将鼠标指针移至扇形时显示的内容，包括每个扇形的标签、所占比例及所属子饼图的名称；hole用于设置圆环的大小；type用于声明是饼图。

除此之外，Layout部分的 annotations属性同样也包含了四个大括号（{}），每个大括号代表一个子饼图中心的文字设置，如下所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303415108-b38f653e-d6f6-478e-b1fb-2eb3512ded33.jpeg)

其中，font中的size属性用于设置文本的大小，showarrow用于设置是否显示箭头，text中可以输入展示的文本内容，x与y用于设置文本所在的位置。

### 2.11.5　参数解读

在Plotly模块库中使用Pie函数绘制饼图，常用属性如下。

● direction：饼图方向，有clockwise（顺时针）和counterclockwise（逆时针），默认值为counterclockwise。

● dlabel：饼图图标步进值，默认值为1。

● domain：范围，设置各个扇区的大小。

● hole：设置环形饼图内径孔的半径，范围是0～1，默认值为0，参数是与外径的比值。

● label0：生成一组扇区图标的起点数字，默认值为0。

● labels：每个扇区的图标字符串数组列表，一般用Pandas的时间索引值。

● legendgroup：图标参数，默认是空字符串。

● marker：数据节点参数，包括大小、颜色、格式等。

● name：名称参数。

● opacity：透明度参数，范围是0～1。

● pull：凸出扇区的比例，范围是0～1，默认值为0。

● pullsrc：各个扇区比例数组列表。

● rotation：扇区旋转角度，范围是0～360，默认值为0（12点位置）。

● showlegend：布尔变量，用于切换图标显示。

● sort：布尔变量，扇区排序开关。

● values：每个扇区的数值大小。

## 2.12　更多案例

前面详细介绍了Plotly基本的绘图方法，这些绘图方法基本可以满足用户在可视化应用中的大部分绘图需求。当然，Plotly中不止这些绘图方法，本章仅介绍一些最常用的。如果这些基本方法不能满足用户的需求，则可以登录官方网站（https://plot.ly/python/）查找，一般情况下都可以解决问题。

如图2-40所示是Plotly官方网站中的案例。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303415619-7a9d447c-3d29-4156-a197-3b4c9305d385.jpeg)

图2-40　Plotly官方网站中的案例

## 2.13　Plotly对象概览

经过前面的学习，读者对Plotly的基本绘图方法有了一些了解。本节介绍Plotly的对象（Objects），Plotly的对象除各种类型的图表外，还包括数据库连接和数据分析工具。

大体而言，Plotly的绘图对象包括以下类型。

● 2D平面图表。

● 3D立体图表。

● Maps，地图类型的图表。

● WebGL格式图表。

● Layout，画面布局函数。

● Axis，坐标工具，包括2D/3D平面坐标、立体坐标和极坐标（AngularAxis）。

● Annotation，图表注释工具。

● Error，误差调整工具，包括x、y、z三种坐标的误差修正。

● Figure，图形整合工具。

● Font，字体工具。

● Legend，图例工具。

● Margin，图表边缘间距工具。

● Marker，标记工具。

● 金融行业通用的OHLC数据格式工具。

● Pointcloud，点云工具。

● RadialAxis，纵横比调整工具。

● Array，数据坐标列表。

● Data，图表数据整合工具。

● Stream，实时图表数据流工具。

● Scene，场景工具。

1.2D平面绘图对象

Plotly的2D平面绘图对象如下。

● Angularaxis，极坐标图表。

● Area，区域图。

● Bar，条形图。

● Box，盒形图，又称箱线图、盒子图、箱图。

● Candlestick与OHLC，金融股票行业常用的K线图与OHLC曲线图。

● ColorBar，彩条图。

● Contour，轮廓图（等高线图）。

● Choropleth，等值线图。

● Line，曲线图。

● Heatmap，热点图。

● Histogram，直方图。

● Histogram 2d，2D平面直方图。

● Histogram 2d Contour，二维轮廓直方图。

● Pie，饼图。

● Scatter，坐标分布图（包括线形图、散点图）。

2.3D立体绘图对象

Plotly的3D立体绘图对象如下。

● Scatter3D，3D立体散点图（包括线形图）。

● Surface，表面图。

● Mesh3D，3D立体网格图。

● Pointcloud，点云图。

3.Maps地图

● ScatterGeo，基于GEO地图模式的散点图（包括线形图）。

● Choropleth，立体等值线图。

● Scattermapbox，基于地图的散点图。

4.WebGL格式图形

● ScatterGL，WebGL格式散点图（包括线形图）。

5.图表辅助工具

Plotly绘图模块库的辅助函数如下。

● Annotation，图表注释工具。

● Axis，坐标工具，包括2D/3D平面坐标、立体坐标和极坐标（AngularAxis）。

● Annotation，图表注释工具。

● Error，误差调整工具，包括x、y、z三种坐标的误差修正。

● Figure，图形整合工具。

● Font，字体工具。

● Legend，图例工具。

● Margin，图表边缘间距工具。

● Marker，标记工具。

● RadialAxis，纵横比调整工具。

● Array，数据坐标列表。

● Scatterternary，散点三元图。

● Data，图表数据整合工具。

● Stream，实时图表数据流工具。

● Scene，场景工具。

● XBins、YBins：x轴、y轴辅助参数。

● Layout，画面布局函数。

6.Layout画面布局函数

Layout画面布局函数功能强大，看起来很复杂，其实只要掌握了相关的参数，设置很简单，都是字典模式，如图2-41所示是 Layout画面布局函数官方文档的相关截图说明。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303416162-c84bf5b6-35e5-45cb-b7d3-cfbcbe302fc1.jpeg)

图2-41　Layout画面布局函数官方文档的相关截图说明

由图2-41可以看出，Layout画面布局函数的有关参数如下。

● 3D Axes，三维坐标（x轴、y轴、z轴）。

● Axes，平面坐标（x轴、y轴）。

● File Settings，文件设置。

● Horizontal Legends，水平标记。

● Images，插入图片，一般作为背景或地图数据。

● Inset Plots，插入图形。

● LaTeX，LaTeX专业排版数据。

● Legends，图例设置。

● Logos，绘制格式标志。

● Multiple Axes，多轴设置。

● Setting Graph Size，设置图形的大小。

● Setting the Title, Legend Entries, and Axis Titles，设置标题、图例条目和轴标题。

● Subplots，子图设置。

● Text and Annotations，文本和注释。

● Text and Font Styling，文本和字体样式。

读者可以使用help命令查看Layout函数的参数与属性，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303416692-18abdb50-a1cf-4494-91d4-74687dc45353.jpeg)

输入以上代码时，注意大小写，Layout画面布局函数的首字母是大写。

help函数输出的信息很多，其中开头部分的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303417107-cd60e1e0-2e3b-4437-89a7-e48f4c9abf68.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303417608-db2c4c99-5a60-430e-b873-4448a9e21e1d.jpeg)

其中，两个中括号之间的部分就是Layout画面布局函数的属性和参数。

Matplotlib绘图模块库和其他 Python模块库的内置函数，也可以使用这种方法查看有关函数的内置属性。

下面根据以上输出信息，简单介绍Layout画面布局函数的属性和参数。

● angularaxis，角轴。

● annotations，注释。

● autosize，自动调整大小。

● bargap，（条形图）柱间距。

● bargroupgap，（条形图）柱组间距。

● barmode，条形图模式。

● barnorm，条形图参数。

● boxgap，盒子图间距。

● boxgroupgap，盒子组间距。

● boxmode，箱型图模式。

● calendar，日历。

● direction，方向。

● dragmode，图形拖动模式。

● font，字体。

● geo，地理参数。

● height，高度。

● hiddenlabels，隐藏图标。

● hiddenlabelssrc，隐藏图标参数数组列表。

● hidesources，隐藏数据源。

● hovermode，鼠标指针悬停模式。

● images，图像。

● legend，图标。

● mapbox，地图模式。

● margin，图表边缘间距。

● orientation，方向。

● paper_bgcolor，地图背景颜色。

● plot_bgcolor，图形背景颜色。

● radialaxis，纵横比。

● scene，场景。

● separators，分离参数。

● shapes，形状。

● showlegend，图例显示。

● sliders，滑块。

● smith，smith参数。

● ternary，三元参数。

● title，标题。

● titlefont，标题字体。

● updatemenus，菜单更新。

● width，宽度。

● xaxis，x轴。

● yaxis，y轴。

Layout画面布局函数主要用于设置图形外观，比如标题、横纵坐标轴、图例、图形外边距等属性，这些属性包括字体、颜色、尺寸等，更多Layout画面布局函数的有关资料，请读者浏览 Plotly网站的在线文档，网址是 https://plot.ly/python/#layout-options。

7.Annotation注释函数

Annotation注释函数用于为图形整体和数据节点添加注解文本，主要属性和参数如下。

● align，对齐方式。

● arrowcolor，箭头颜色。

● arrowhead，箭头模式，共有9种模式。

● arrowsize，箭头大小。

● arrowwidth，箭头宽度。

● ax，x轴坐标参数。

● axref，x轴坐标辅助参数。

● ay，y轴坐标参数。

● ayref，y轴坐标辅助参数。

● bgcolor，背景颜色。

● bordercolor，边框颜色。

● borderpad，边框排列方式。

● borderwidth，边框宽度。

● font，字体。

● opacity，透明度。

● ref，辅助参数。

● showarrow，显示箭头开关。

● text，文本。

● textangle，文本角度。

● visible，注解显示开关。

● x、y：x轴坐标、y轴坐标。

● xanchor、yanchor：x轴坐标锚点、y轴坐标锚点。

● xref、yref：x轴坐标参考参数、y轴坐标参考参数；如果参考参数等于“paper”（画纸模式），则注释文字的x、y坐标分别以画纸左下角（0,0）为原点、以右上角（1,1）为坐标最大值，x、y采用小数形式；如果参考参数等于“x”、“y”，则表示使用x、y数据数组的坐标参数作为注释字符串的坐标。

8.Axis坐标轴参数设置

在绘制图形时，经常会根据实际情况调整坐标轴参数，Plotly绘图模块库中设置坐标的参数有：xaxis（x轴参数）、yaxis（y轴参数）、zaxis（z轴参数）。

有关坐标轴参数的属性说明如下。

● anchor，锚点。

● autorange，自动范围。

● autotick，自动刻度。

● backgroundcolor，背景颜色。

● calendar，日历模式。

● categoryarray，分类数据参数。

● categoryarraysrc，分类数据参数源。

● categoryorder，分类数据模式。

● color，颜色。

● domain，范围。

● dtick，分类数据坐标刻度步进值。

● exponentformat，指数格式。

● fixedrange，固定范围。

● gridcolor，网格线颜色。

● gridwidth，网格线宽度。

● hoverformat，鼠标指针悬停格式。

● linecolor，线条颜色。

● linewidth，线宽。

● mirror，镜像模式，包括true、ticks、false、all、allticks等属性。

● nticks，刻度之间的间隔数。

● overlaying，图层重叠。

● position，位置。

● range，范围。

● rangemode，范围模式。

● rangeselector，范围选择。

● rangeslider，范围滑块。

● separatethousands，千分位分隔。

● showaxeslabels，显示x轴图标开关。

● showbackground，显示背景开关。

● showexponent，显示指数开关。

● showgrid，显示网格开关。

● showline，显示线条开关。

● showspikes，显示异常开关。

● showticklabels，显示刻度数据数组列表。

● showtickprefix，显示刻度前缀数据数组列表。

● showticksuffix，显示刻度后缀数据数组列表。

● side，边缘参数。

● spikecolor，峰值数据颜色。

● spikesides，峰值数据滑块。

● spikethickness，峰值数据厚度。

● tick0，刻度数据锚点。

● tickangle，刻度数据角度。

● tickcolor，刻度数据颜色。

● tickfont，刻度数据字体。

● tickformat，刻度数据格式。

● ticklen，刻度数据长度。

● tickmode，刻度数据模式。

● tickprefix，刻度数据前缀。

● ticks，刻度数据显示模式，包括 outside（刻度外）、inside（刻度内）、""（空字符串，无刻度）三种模式。

● ticksuffix，刻度数据后缀。

● ticktext，刻度数据文本。

● ticktextsrc，刻度数据文本数组列表。

● tickvals，刻度数据参数值数组列表。

● tickvalssrc，刻度数据参数值数据源数组列表。

● tickwidth，刻度数据宽度。

● title，标题。

● titlefont，标题字体。

● type，类型。

● zeroline，零线参数。

● zerolinecolor，零线颜色。

● zerolinewidth，零线宽度。

9.Python对象属性提取技巧

前面笔者介绍过使用help命令查看Layout函数的参数与属性，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303418121-d9eaa736-1c06-4485-84f8-0d598e1cd4da.jpeg)

print(help( pygo.Layout))

Matplotlib绘图模块库和其他 Python模块库的内置函数，也可以使用这种方法查看有关函数的内置属性。

Layout画面布局函数的help命令的输出信息很多，其中开头部分的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303418688-6b014d29-4896-421b-8edc-d3319048a63f.jpeg)

其中，两个中括号之间的部分就是Layout画面布局函数的属性和参数。

在获取这些文本信息后，需要进一步整理排序，这里面有一些一线工程的操作技巧，笔者一般按如下步骤操作。

（1）打开一个类似UltraEdit的文本编辑器，粘贴以上属性和参数，只需要两个中括号之间的文本部分。

（2）把其中的“，”（逗号）用回车符号（一般是“^p”）代替，每个参数占一行。

（3）把其他多余的符号，包括空格、制表符（“^t”）、单引号、中括号全部用空字符代替。

（4）用编辑软件的排序功能，按字母顺序重新排列函数的属性和参数。

（5）把排列好的函数属性和参数文本复制到文档手册中。

（6）对于复杂的属性和参数，可以再复制一份，到百度翻译网页，使用“中英双语对照”模式翻译，再把翻译文本复制到文档手册中。

# 第3章　Plotly高级图形

## 3.1　时间序列

### 3.1.1　使用方法

Plotly对时间序列的支持比较友好，既支持字符串格式，又支持日期/时间格式，而且使用起来相当简单，代码（见文件timeSeries）如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303419202-10d586cc-fb67-453f-9bcc-c05c1a370019.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303419674-df546d3e-0a29-4c18-b9a1-07d3b373066f.jpeg)

运行结果如图3-1所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303420222-0fd9952b-5fc0-4b99-b4c6-7fc60cab489e.jpeg)

图3-1　代码运行结果

从代码中可以看出，只要传入的 x是日期或时间格式的字符串，Plotly就会自动识别为时间格式。

### 3.1.2　时间范围约束

有时候，我们只想展示部分时间范围内的绘图结果，这时通过传递一个 range参数即可实现这个功能，见文件timeRange.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303420715-6115aec2-b0dd-4428-a8f9-e7adda6f1bbd.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303421268-2cbe3021-0577-400a-a5e2-3354de6f5efc.jpeg)

输入结果如图3-2所示，可以看到，我们成功限制了输出结果的日期范围为2013.10.17—2013.11.20。

在上面的代码中，关键部分的代码如下，主要用到了坐标轴参数（xaxis）里面的range参数，它是一个长度为2的列表，如果传递的数据类型为datetime，那么其数值应该是1970年1月1日到传递时间的微秒数，to_unix_time函数就是做这个事情的。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303421536-38cd5dbb-a32d-47a3-aa1d-fc2bdf943ea0.jpeg)

图3-2　输入结果

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303421843-b3663136-dc55-41b4-a308-146dc2dd6636.jpeg)

如果想要恢复为默认的时间范围，可以单击界面右上角的Autoscale按钮，如图3-3示，就可以恢复成默认的时间范围。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303422270-8d68605c-a7c4-41a5-8101-111730ca6437.jpeg)

图3-3　Autoscale按钮

代码运行结果如图3-4所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303422518-c0767e8d-2e1c-42f4-8e86-dfb29627091b.jpeg)

图3-4　代码运行结果

## 3.2　滑动选择控件

对于金融时间序列的绘图，Pltoly提供了强大的可定义模板，可以通过简单的设置，轻松地实现图3-5和图3-6这两幅图中被圈出的功能。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303422879-11dd149a-e220-4945-bc63-7fa7f0aac946.jpeg)

图3-5　滑动选择控件1

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303423243-ec93691d-de9a-44aa-af2d-ce4e265f2de4.jpeg)

图3-6　滑动选择控件2

图3-5中是时间序列的滑块，可以通过拖动滑块左右临界点来调整时间范围；图3-6中是时间序列的选择器，可以通过单击不同的按钮来快速切换时间范围。这两种功能在 Plotly中都可以通过相对简单的代码实现，代码如下（见文件RangeSlide.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303423518-0583a4a4-3893-4065-95ff-1a1d361a8340.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303423934-712d5b45-704d-4094-9219-6bd7f7326360.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303424270-bc566fc0-c577-42a7-956f-497220c010c0.jpeg)

代码运行结果如图3-7所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303424563-9c40e3ab-56a1-491d-bce5-44c5c71e77a6.jpeg)

图3-7　代码运行结果

从图3-7可以看出，通过简单的代码就实现了时间序列滑块与选择器功能，而且效果相当漂亮，也非常好用。

滑块与选择器主要是通过 Layout布局函数来实现的。对于选择器，主要在xais.rangeselector.buttons中定义一些参数，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303425070-dae22d69-7491-48b6-b45e-b32e37ba247f.jpeg)

对上面的代码做如下解释。

（1）xaxis表示对x轴进行定义；rangeselector表示对x轴的选择器进行定义；buttons表示选择器的按钮，是一个列表形式，每个列表元素都是一个选择器按钮。

（2）“count=1,step='month'”表示这个选择器覆盖的时间长度是“1 × month”，即一个月。“label='1m'”表示选择器的标签为1m。

（3）stepmode有以下两种使用方法。

① 当stepmode='backward'时，表示从后往前推进count × step时间。例如，当count=1、step='year'时，表示时间范围将近一年。

② 当 stepmode='todate'时，一般只有一种用法，就是计算今年以来的时间。例如，当 count=1、step='year'时，表示时间范围从最后日期到最后日期所在的年初，而不是近一年。

## 3.3　表格

有时数据结构是一种表格结构，可以把这些数据展示出来，就像 Excel显示出来的效果那样。幸运的是，Plotly支持这种绘图方式，而且绘图效果非常美观。

### 3.3.1　入门案例

本案例见文件table_first.py，用来说明创建表格的基本方法，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303425393-05800914-11c7-4a65-b5cf-425dea2f0f30.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303425688-54fc7a28-834a-4182-93cf-4427b5f2b854.jpeg)

上面的代码没有太大的难点，有一点需要说明的是这段代码用到了figure_factory类，这个类存储了除之前讲的基础绘图方法外的一些高级绘图方法，本节创建的表格使用的就是其中的高级绘图方法之一。

代码运行结果如图3-8所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303426040-becda459-e883-407d-95f0-7f2d25963365.jpeg)

图3-8　代码运行结果

### 3.3.2　添加链接

Plotly支持对文字的链接，本案例见文件table_link.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303426394-68c4eb7e-bb7e-4bbc-abe6-0c733a6a2246.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303426659-01f07a9b-2a86-4a7a-8b40-461982b8a1b8.jpeg)

代码运行结果如图3-9所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303427084-20ffc1fe-42b4-4c4d-8471-d233ee4c3da8.jpeg)

图3-9　代码运行结果

单击第 1～第 3列中的内容，会弹出一个窗口，打开相应的网页。从上面的代码中可以看出，实现链接的代码非常简单，只需要简单地运用HTML语言中<a> 标签的href属性即可，代码如下。

'<a href="https://plot.ly/python/">Python</a>',

### 3.3.3　使用Pandas

在 Python语言中，进行数据分析离不开 Pandas。Pandas最初是 AQR Capital Management为解决数据分析任务而创建的一个模块，并在2009年开源。Pandas功能强大且容易上手，在笔者的实际经验中，90%的数据分析任务都会交给Pandas完成。

同时，Pandas的数据结构 DataFrame又是一种表格结构，如果可以直接使用Pandas数据结构进行绘图，那么利用Pandas的数据处理优势，数据呈现将会变得非常简单。幸运的是，Plotly的表格绘图支持Pandas的数据结构。

在Plotly中使用Pandas的代码如下（见文件table_pandas.html）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303427448-3fe730e3-d01b-4078-b0b0-9cde0130b58e.jpeg)

上面的代码看起来非常简单，只要把数据源换成Pandas的DataFrame数据格式即可（本例中为变量df_sample）。

table = FF.create_table(df_sample, index=True, index_title='Date')

上面代码中的index=True表示在图表结果中显示第1列的索引列，默认情况下是不显示这个索引列的。

需要注意的是，这里只显示20行数据，这是因为Plotly表格数据渲染速度比较慢，如果数据量太大，会影响程序运行速度，并且在业界，这种网页表格的渲染过程需要分成好多页，每次渲染其中的一页。用于显示数据行数的代码如下。

df_sample = df[100:120]

代码运行结果如图3-10所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303427805-ec686ee2-61ac-4fb2-81bc-99626540b06d.jpeg)

图3-10　代码运行结果

### 3.3.4　改变大小与颜色

使用Plotly的create_table函数修改图表字体的大小与颜色，以及图表的颜色非常方便，代码如下（见文件table_style.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303428205-f20c79a9-faf4-4fec-9431-434df53cb260.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303428733-444da439-e43e-4a03-b3b0-d8a3a5a73c06.jpeg)

代码运行结果如图3-11所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303429283-f8a14b83-4f05-41d0-9d7a-468d4ef1f1e8.jpeg)

图3-11　代码运行结果

上面的代码虽然简单，设计的内容却很复杂，以下几点是读者需要注意的地方。

（1）colorscale参数是一个列表，默认是[[0, '#66b2ff'], [.5, '#d9d9d9'],[1, '#ffffff']]。[0, '#66b2ff']表示表头（第一行和有索引的第一列）的颜色是'#66b2ff'（深蓝色）；[.5,'#d9d9d9']表示除表头外，表格的奇数行的背景颜色是'#d9d9d9'（浅灰色）；同理，[1,'#ffffff']表示偶数行的背景色是'#ffffff'（白色），这种颜色方案的效果如图3-11所示。

（2）fontcolors参数是一个列表，它既可以是一个元素的列表，表示所有表格的文字使用一种颜色（默认是['#000000']），也可以是三个元素的列表（如本案例），分别表示表头、奇数列、偶数列的文字颜色，甚至可以是一个与表格行数相同的列表，可以为每一行自定义一个颜色。

（3）下面的代码表示把表格的宽度设置为1000。

table.layout.width=1000

（4）下面的代码表示为每一个单元格的文字设置字体大小。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303429814-3ea436f9-aadd-46ee-af5e-9f168ec983a8.jpeg)

以上代码本质上是在修改Layout的annotations注释函数。虽然看起来有些复杂，实际上做的事情却非常简单。以 i=0为例（对应表格左上角的单元格），代码table.layout.annotations[i].font.size = 10 + (i % 50)*0.2的作用是把annotations由

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303430317-1e4ecdf0-94dd-4de1-8054-a1c5e7408fd1.jpeg)

变成

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303430840-898b01ee-d599-4a9e-ad93-a57eeade0339.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303431286-e67b5778-e300-45e0-b288-98ee6af11c59.jpeg)

也就是说，仅仅是把font关键字对应的字典{'color': '#FCFCFC'}变成了{'color':'#FCFCFC', 'size': 10}。

### 3.3.5　表格与图

在绘图时，有的数据适合以表格的形式展示出来，也有一些数据适合以图的形式展示出来，还有一些数据单独用表格或图都不能很好地展示，需要两者（表格和图）结合才能更好地展示出数据的特点。

本案例（见文件table_subplot.py）提供了解决这个问题的方法，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303431849-4ad59954-69de-4422-bf8d-d35fd0c2f5cc.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303432337-818f5c9d-0a20-4008-93b1-a54f0b7e59b0.jpeg)

代码运行结果如图3-12所示。

图3-12中的文字内容是笔者为了更好地说明问题杜撰的，读者不要当真。这个案例中有几点需要说明。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303432906-81d854ad-cedd-4fc6-a2a8-fd5d02d55423.jpeg)

图3-12　代码运行结果

（1）合并两幅图，本质上是对列表figure['data']添加新的元素，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303433367-a2f81851-d983-4c69-9f70-d2be4ddcb815.jpeg)

（2）对两幅图进行布局管理，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303433895-8a32dae8-c9c4-4df6-adaf-66b92144cdff.jpeg)

（3）设置第二幅图的 y轴与x轴对应。这样设置的结果是把字典 figure.layout.yaxis2由空值变为{'anchor': 'x2', 'title': '分值'}，其中{'anchor': 'x2'}的意思是yaxis2坐标轴是与xaxis2坐标轴对应的。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303434433-aec79543-b4f3-4a29-8040-03fb25765418.jpeg)

（4）设置figure的边界与标题，这里设置距离顶部（top）50个单位，距离底部（bottom）100个单位，还可以对关键字r（right）、l（left）进行设置。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303434924-67e7d76e-0882-4392-ae2c-c314b71bed56.jpeg)

上面是水平布局的多子图绘图方式，有时候也需要进行垂直布局，相对于水平布局，垂直布局的代码只需要进行简单的修改（见文件table_subplot2.py），代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303435465-3c59aa26-02da-48a4-8931-249ab48a0f64.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303435978-c01ddb5c-bca0-428f-a490-951540890808.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303436565-26dc36de-0e95-47de-b8e2-505c2f14d4d6.jpeg)

代码运行结果如图3-13所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303436954-3a9d5e7b-9fd2-460c-af8a-e7c23c2dc058.jpeg)

图3-13　代码运行结果

## 3.4　多图表

所谓多图表，就是在一幅图中出现多个图表，这种呈现方式实际上在前面的章节中已经讲过，为了方便读者查阅这种呈现方式的使用方法，本节以一个简单的案例进行说明。

案例文件见 multi_plot.py，说明如何在一副图中呈现多个不同类型的图形，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303437619-87ea7642-b57f-47ee-9420-d446618f3552.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303438048-577bb611-2f44-4cdd-a7c8-add8df2bfcba.jpeg)

代码运行结果如图3-14所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303438621-d82d49c4-5aac-4b0d-8f7e-6c3e65c829d2.jpeg)

图3-14　代码运行结果

## 3.5　多个坐标轴

有时，一幅图中多个图表的数值可能会相差很大，这样会导致数值较小的图表对坐标轴的变化不是很敏感，不能很好地体现图表的变化规律。因此，在绘图时就有多个坐标轴的需求。

### 3.5.1　双坐标轴

最简单的多个坐标轴就是双坐标轴了。使用 Plotly绘制双坐标轴非常容易，本案例见文件multi_yaxis.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303439183-83d1a11a-ce62-43d6-9e6b-09e544c45b46.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303439717-695d3e77-1540-4f66-8231-4dfce55bac28.jpeg)

代码运行结果如图3-15所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303440247-a33495ad-eb14-4b81-859e-e44524a7dc34.jpeg)

图3-15　代码运行结果

在上面的代码中，比较关键的是下面几行代码：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303440839-e1ee78f8-e420-4439-a4b0-1eac94eae889.jpeg)

titlefont用于设置标题格式，这里设置了yaxis2的标题颜色。

tickfont用于设置刻度格式，这里设置了yaxis2的刻度颜色。

overlaying是覆盖的意思，可以是"free"、"/^x([2-9]|[1-9][0-9]+)?$/"、"/^y([2-9]|[1-9][0-9]+)?$/"中的一种，本案例中参数为y，表示会覆盖y轴。

side的参数为 top、bottom、left、right中的一种，表示坐标轴的位置。本案例中为right，表示右坐标轴，即yaxis2为右坐标轴。

### 3.5.2　多坐标轴

相对于双坐标轴，Plotly更让人激动的是可以实现多坐标轴的效果，比如 3坐标轴、4坐标轴。这些坐标轴都是在二维平面上实现的，绘制方法也很简单，代码如下（见文件multi_yaxis2.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303441229-368b0a43-7f02-4bc0-aed0-f62fd056063f.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303441728-4d2296e2-5b24-4b56-a581-230ff4203b53.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303442290-3afb7472-9747-43e9-a0a2-7271128451f5.jpeg)

代码运行结果如图3-16所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303442854-0679ecdd-d2bb-4eff-94c8-6fc143bab292.jpeg)

图3-16　代码运行结果

可以看到，不同的坐标轴有不同的刻度及不同的颜色，很容易区分。

从代码上来看，实现上面的效果比较重要的是下面的几行代码。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303443318-ac471ab9-5eb3-4de0-a8fd-ee6c82804fac.jpeg)

anchor的取值可以是 free、"/^x([2-9]|[1-9][0-9]+)?$/"、"/^y([2-9]|[1-9][0-9]+)?$/"，表示需要绑定的坐标轴。如果设置为 free，则其坐标轴由 position的值指定，这里position=0.15表示在0.15这个位置的轴就是yaxis2所在的轴。

position用来指定轴的位置，仅在anchor='free'时该值有效。

### 3.5.3　共享坐标轴

有时会遇到这样的情况，X轴的几个子图数值相差不大，Y轴的几个子图数值相差较大，虽然可以像上例一样设置多个坐标轴，但是更想在一个坐标轴上呈现，所以就涉及到共享Y轴。本案例的代码如下（见文件multi_share_yaxes.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303443714-ac1a584b-9616-4802-92a5-39a07788add2.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303444362-aa7ad59f-b257-481d-a39e-fc25cb9bc0b4.jpeg)

代码运行结果如图3-17所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303444958-9e11cbe2-ff48-4bbd-abd0-8367abcec196.jpeg)

图3-17　代码运行结果

从图3-17中可以看到，在一个图里呈现出了三个不同数字区域的图形。本案例主要用到了如下参数：

domain=[0.66, 1]

domain参数用来指定坐标轴的区间范围，这里的设置为[0.66, 1]，表示 yaxis3的区间为0.66～1，所呈现出的结果为最上面的一条线。

可见，所谓共享Y坐标轴，是指不同的图表对整幅图在Y轴上的区域分割。

## 3.6　多子图

除多个坐标轴外，多个子图也是多个图表很好的呈现方式。

### 3.6.1　双子图（方法一）

最简单的多子图就属双子图了，为了方便在一幅图中呈现多个子图，Plotly封装了一个很好的方法make_subplots，这个方法的使用方式如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303445443-5bf62e9c-f99a-477b-a638-6afc2936fc1a.jpeg)

make_subplots的使用方法很简单，使用案例如下（见文件subplot_simple.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303445940-8f8cb314-de21-4226-afdf-1885efba025f.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303446356-574a73e2-cfda-4e3a-bf48-5d7d5f807502.jpeg)

代码运行结果如图3-18所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303446672-a11863f2-2fcc-467d-8667-815b8fcae2d4.jpeg)

图3-18　代码运行结果

### 3.6.2　双子图（方法二）

除上述方法外，在前面的内容中还使用过一种方法，那就是使用domain参数指定子图坐标轴在视图中的范围，这种方法的应用案例如下（见文件 subplot_simple2.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303447048-f2d4d52e-4537-469e-b114-ac991a9ec645.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303447425-fc190726-6d34-46a1-bf1d-58ff54b0adb3.jpeg)

代码运行结果如图3-19所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303447748-be01b81b-7e66-4282-b4d3-a6535017776f.jpeg)

图3-19　代码运行结果

### 3.6.3　多子图（方法一）

对于多个子图，绘制方法是一样的，以 make_subplots方法为例（见文件subplot_multi.py），案例代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303448107-7c666a52-6e7f-4580-be3c-e8bf86b1ced9.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303448461-b66e8547-47dd-4f76-8728-244cfabffa39.jpeg)

代码运行结果如图3-20所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303448804-6a0100f3-e7ed-4361-b0d6-bd5872dc29b2.jpeg)

图3-20　代码运行结果

### 3.6.4　多子图（方法二）

同样，也可以使用 domain参数定义每个子图的位置范围（见文件subplot_multi2.py），案例代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303449152-83958b98-c2c3-4d79-b541-2681355228f5.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303449510-700be923-4485-43f3-a7af-b19495061ce9.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303449807-efeb7d0d-5201-4f20-8b26-fc8cbafa02fc.jpeg)

代码运行结果如图3-21所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303450239-c32e5074-4bf5-466b-9557-bc793459861f.jpeg)

图3-21　代码运行结果

### 3.6.5　分割视图区间

有时想为每个子图定义自己的大小，这就涉及到视图区间的分配问题。make_subplots方法为解决这个问题专门封装了一个参数 specs，这个参数的简单使用方法如下（见文件subplot_specs1.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303450761-166da43d-236d-4115-a076-4497bd10237a.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303451307-0647d4d7-2961-4446-8243-31274b23ff71.jpeg)

代码运行结果如图3-22所示。

specs参数定义了如何分配视图区间，本案例中的“specs=[[{}, {}], [{'colspan': 2},None]]”表示第一行的两个子图平均分配区间，第二行的第一个子图占据 2列的区间，并且不存在第二个子图，分配的结果如图3-22所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303451848-185e27aa-9bc2-47ac-a79f-5810bb76aa2b.jpeg)

图3-22　代码运行结果

本案例介绍了使用make_subplots方法分割视图，其实还可以分割得更复杂一些（见文件subplot_specs2.py），代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303452281-be1959e5-8849-42bb-b2cb-a38adc82d609.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303452846-b8cd74a3-9055-4aa0-a3e1-10eff04ee09a.jpeg)

代码运行结果如图3-23所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303453369-cc6b403a-a73a-4579-a5af-826019b95b14.jpeg)

图3-23　代码运行结果

本案例展示了把5×2的视图区间分配给6个子图，更复杂的图形也可以通过这种方式进行分配。

### 3.6.6　子图共享坐标轴（方法一）

有时多个子图的X坐标轴区间范围基本一致，从视觉效果来看，这些子图共同使用一个坐标轴效果会更好一些，这就涉及到了本节的内容。对于共享坐标轴，在之前的章节已经有所涉及，本节要讲的是如何在多个子图之间共享坐标轴。

在 Plotly中，共享坐标轴很简单，用前面学过的知识就可以解决（见文件subplot_share_axes.py），代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303453824-3148fc56-4aa8-43c4-9408-b80c4d21d55f.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303454386-36f856ec-ff93-4ad4-ac45-f340d60dc928.jpeg)

代码运行结果如图3-24所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303454964-29f23457-b3a8-41e0-bb29-55dc4c748ade.jpeg)

图3-24　代码运行结果

### 3.6.7　子图共享坐标轴（方法二）

除上述方法外，make_subplots也提供了很好的解决方法，通过设置参数shared_yaxes和shared_xaxes就可以控制共享坐标轴。

简单的案例如下，以共享Y坐标轴为例（见文件subplot_share_yaxes.py），代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303455467-9856861e-8cb2-49c5-8007-f308e7dc647a.jpeg)

代码运行结果如图3-25所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303456047-1a22777c-5130-43e8-bdbd-a4b7ab846f51.jpeg)

图3-25　代码运行结果

当然，也可以设置两个坐标轴都共享，案例代码如下（见文件 subplot_share_xyaxes.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303456993-dfa00c38-463b-4288-8d0a-2b9d6b2d4566.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303457494-a9e3fcd2-9d8d-4724-b6ee-2bb0396ef74c.jpeg)

代码运行结果如图3-26所示。这个结果与3.5.3节共享坐标轴案例的结果一致，但是使用的是不同的方法。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303457942-b4099d80-aacc-438e-b3e6-07db92053906.jpeg)

图3-26　代码运行结果

### 3.6.8　子图坐标轴自定义

有时需要对每个子坐标轴进行自定义显示，这就需要用到本节的内容。在前面的学习中我们知道，在 Plotly中对已经定义好的绘图进行自定义显示，需要修改figure中的layout参数，在这里也不例外。

本案例代码如下（见文件subplot_custom_axes.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303458574-f680e0dc-787c-4d63-9140-0a25406b3603.jpeg)

代码运行结果如图3-27所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303459212-4599d722-a643-41a3-8a79-2b3257894e30.jpeg)

图3-27　代码运行结果

本案例的代码只定义了坐标轴的显示范围、坐标轴类型和是否显示网格，对于其他的画面布局，也可以通过这种方式进行定义。

### 3.6.9　嵌入式子图

有时需要在一幅图上显示一个大图和一个小图，看起来就像小图嵌入到大图中一样。对于这个需求，Plotly也可以满足。

显示的原理非常简单，就是利用 domain参数，案例代码如下（见文件subplot_insert.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303459679-3ee8a2ae-f87e-482f-9d68-b6cb4c98d108.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303460127-070f46e9-07f0-4330-b2f7-a99127b081db.jpeg)

代码运行结果如图3-28所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303460647-7a76f933-6b3e-4674-a8b4-8799a4f3c9f0.jpeg)

图3-28　代码运行结果

### 3.6.10　混合图

下面介绍多图组合，本案例绘图的呈现效果特别的炫耀，先看一下炫酷的效果，如图3-29所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303461210-91cc08a7-c4d9-4ebc-8e72-6187e110622c.jpeg)

图3-29　混合图效果

对于源代码，由于 3D绘图的内容本书并没有涉及到，因此这里就不进行解读了，对3D图感兴趣的读者可以去官方网站学习相关的知识。本案例的代码如下（见文件subplot_mixed.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303461750-9600950b-86d5-4862-95dd-189ef876d837.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303462241-0d5e9694-1080-487d-9e1f-f125a27708f0.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303462754-cf93d033-810a-48a8-9818-a90598a084fc.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303463284-2310115a-d50e-4a81-8bb1-3714c3153ccd.jpeg)

## 3.7　绘制SVG

SVG（Scalable Vector Graphics，可伸缩矢量图形）使用XML格式定义图形，主要用于绘制二维图像。可以通过编写代码来展示简单的或复杂的图形，例如直线、曲线等；也可以在矢量图形编辑程序中创建这些直线、曲线，然后让程序导出代码。

为什么要使用SVG？主要有下面几个方面的原因。

● 在浏览器中改变尺寸，SVG图形质量不会有所损失。

● 相比其他位图，SVG图形文件更小，可压缩性更强。

● SVG可以被记事本等阅读器、搜索引擎访问。

● SVG图形中的文本是可选的，同时也是可复制的。

● SVG图形可以与DOM、CSS和JavaScript交互。

● SVG可以制作成整体或局部动画。

虽然SVG有很多优点，但是本节并不是为了说明这些的，本节的主要任务是利用SVG的优点解决一些特殊的图形如圆、三角形、长方形等的绘制问题。

一般情况下，要绘制SVG，就要通过SVG代码来实现，Plotly对SVG进行了封装，可以用Plotly形式的语法来绘制SVG。

### 3.7.1　线形图的绘制

绘制SVG最简单的就是绘制线形图，本案例代码如下（见文件SVG_line.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303463847-e8fedeb9-37d6-47c0-bf2f-1ad96c22b41f.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303464445-f8335274-e76d-47cb-aca9-858fc435d0ef.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303464957-e18e9ebf-f658-4148-b3a9-b86e31c326dc.jpeg)

代码运行结果如图3-30所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303465292-f357e84d-9a30-4c05-aa7b-64a5aa86d95a.jpeg)

图3-30　代码运行结果

前面讲解的图形都是通过go.Scatter等函数进行绘制的，绘制SVG却不一样，完全是在layout中进行设置的。上面的代码理解起来非常容易，就以其中一条垂直线（破折号）来说，只需要定义它的起点与终点的位置就可以了，而不用考虑中间位置的情况，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303465880-764c2b43-7eca-4810-911f-84111744cddd.jpeg)

对于本案例的代码，需要注意下面两点。

（1）dash参数的使用。dash参数用于设置线形图结果的呈现方式，可选值有solid（本意是固体，这里指线条）、dot（点）、dash（破折号）、longdash（长破折号）、dashdot（点+破折号）和longdashdot（长点+破折号），默认是solid。

（2）xref（yref）参数的使用。该参数有两个值：paper和x（y）。如果值为x，则x0、x1对应的值为坐标轴的绝对值，比如“x0=0,x1=4”表示线的起点x0在0处、终点x1在4处；如果值为paper，则x0、x1对应的值为坐标轴的相对值，以本案例来说，“x0=0,x1=0.5”表示线的起点x0在0处、线的终点x1在0.5×8=4处。

### 3.7.2　线形图应用：创建图形的切线

本案例讲解如何为已有的图形添加切线，代码如下（见文件SVG_tangent_line.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303466274-b6341a18-89b2-4c6e-8065-1cf7c97c7a25.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303466583-58672130-01e4-456a-a56b-e44582d4350c.jpeg)

代码运行结果如图3-31所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303467054-a0834627-f258-44ba-a241-331ee651d463.jpeg)

图3-31　代码运行结果

上面代码的原理很简单，就是通过人工方法找出曲线f(x)=sin(x^2)+1在区间[1, 3]之间的几个极值点（区域最高点与区域最低点），然后根据这几个极值点绘制水平线。

### 3.7.3　矩形图的绘制

下面介绍矩形图的绘制，矩形图的绘制方法与线形图的绘制方法差不多，本案例代码如下（见文件SVG_rectangle.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303467568-a174bf61-1921-403d-95d1-30b951dd2a5c.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303468080-e0073970-802e-4b12-95ac-dd3197644da0.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303468634-471c31ac-3e8c-48d6-b948-a8e0bc88f1e7.jpeg)

代码运行结果如图3-32所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303469061-09433e14-4c6f-453a-8870-75b605851c58.jpeg)

图3-32　代码运行结果

与线形图的绘制案例一样，本案例同样提供了两种绘制方法，一种是一般的绘制方法（见图3-32的上半部分），另一种是有参考系的绘制方法（使用 xref、yref参数，见图3-32的下半部分）。本案例的绘制方法总体上与线形图的绘制方法一样，有两点需要读者注意。

（1）type参数的使用。参数值可以是 circle（圆）、rect（矩形）、path（路径）和line（线），默认是line。本案例使用的是rect。

（2）fillcolor参数的使用。设置填充的颜色，默认是“rgba(0,0,0,0)”（白色）。

### 3.7.4　矩形图应用：设置时间序列区域高亮显示

要实现时间序列区域的高亮显示，可以在原有的时间序列绘图基础上，通过layout布局函数绘制矩形，并用高亮的颜色填充，实现起来也非常简单（见文件SVG_timestamp_highlight.py），代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303469580-5e0de743-9d5b-4e9d-bc79-4f8792afefe7.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303470128-6943e62e-e68c-4be2-91aa-3f50fb71b4ec.jpeg)

代码运行结果如图3-33所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303470662-b691605c-e87e-4618-b4f4-47ebfa7eb476.jpeg)

图3-33　代码运行结果

### 3.7.5　圆形图的绘制

下面介绍圆形图的绘制，绘制圆形图与绘制线形图、矩形图没有太大的区别，最大的不同是将type参数设置为circle，本案例代码如下（见文件SVG_circle.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303471150-6499e7bc-74bd-4576-a7e3-762958c95746.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303471742-83921035-0f5f-484b-8f98-8ce6d451cb49.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303472196-52661f6b-9084-47cf-acdd-7b988f19cdab.jpeg)

代码运行结果如图3-34所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303472714-95de802f-8724-434e-9f4e-8a9dfbae09dd.jpeg)

图3-34　代码运行结果

注意

本案例中还设置了参数hight=width=800，这个参数的意思读者可以这样理解：如果参数hight != width，则按照我们自己的方式画出来的圆是一个椭圆，因为默认情况下hight=450、width=750、hight != width，呈现出的结果就是一个椭圆。

### 3.7.6　圆形图应用：高亮显示散点图的聚集簇

下面简单介绍圆形图的应用，首先绘制几个散点图的聚集簇，然后以这些聚集簇为核心，绘制几个高亮显示的圆（见文件SVG_clusters.py），代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303473264-306c8c05-6ac9-4123-a31b-c8083041bd54.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303473786-5e841b7c-76ed-4406-b2ac-2b8acc91d2dd.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303474342-ed74b685-a3b6-48ba-8639-61b2bb5ff003.jpeg)

代码运行结果如图3-35所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303474844-1e258a2c-ad29-41dc-aae7-8b1eb8026df9.jpeg)

图3-35　代码运行结果

# 第4章　Plotly与Pandas

Pandas是Python语言的一个数据分析包，是由AQR Capital Management在2008年4月开发的，并于2009年年底开源，目前由专注于Python数据包开发的PyData开发组继续开发和维护，属于PyData项目的一部分。Pandas最初是被作为金融数据分析工具而开发的，并为时间序列分析提供了很好的支持。从Pandas这个名称就可以看出，它是面板数据（Panel Data）和Python数据分析（Data Analysis）的结合。在Pandas出现之前，Python数据分析的主力军只有NumPy；在Pandas出现之后，它基本上占据了Python数据分析的霸主地位，在处理基础数据尤其是金融时间序列数据方面非常高效。

由于Pandas在数据分析中占有特殊地位，因此Plotly为Pandas绘图进行了专门的处理。

## 4.1　简单快速入门

在前面章节的案例中，已经或多或少使用过Pandas。Pandas使用起来很简单，Plotly可以自动识别Pandas数据格式，下面介绍一些简单的案例。

### 4.1.1　基本线形图

由于 Plotly可以识别 Pandas数据格式，所以如果数据是 Pandas的 DataFrame或 Series结构，就可以直接传递给 Plotly，不用转换成 list数据格式。由于 Pandas在数据读取与处理方面非常高效，所以Plotly与Pandas的无缝结合使绘图步骤更简单。以基本的线形图为例，代码如下（见文件basic_line.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303475449-c09aa722-7a9c-42bf-9df6-259361fb32a6.jpeg)

代码运行结果如图4-1所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303476021-0a3a9e3f-7831-4a40-9199-8d41254de06f.jpeg)

图4-1　代码运行结果

### 4.1.2　基本散点图

散点图的绘制也非常简单，既可以用上一个案例中的go.Scatter，也可以使用简单的字典格式（go.Scatter本质上也是建立数据的字典对象）。本案例代码如下（见文件basic_scatter.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303476552-7cd68272-ad1b-4f3e-b7a4-6a3461d254e9.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303477121-98cfc301-24ec-42ff-8d54-83a5e0708325.jpeg)

代码运行结果如图4-2所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303477564-c47c21c5-26f1-4cf1-91db-f3cea3fa59bd.jpeg)

图4-2　代码运行结果

### 4.1.3　基本柱状图

绘制基本的柱状图也非常简单（见文件basic_bar.py），代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303478100-4c83b774-6918-4341-bc54-c413406ec582.jpeg)

代码运行结果如图4-3所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303478599-5beee41b-64bc-4b57-b326-74fa214131d3.jpeg)

图4-3　代码运行结果

## 4.2　使用cufflinks绘图

### 4.2.1　安装cufflinks

本章一开始提过，为了方便绘图，Plotly为Pandas做了特殊的封装，这个封装模块就是cufflinks。cufflinks的作用是改变Pandas绘图的默认呈现方式。Pandas绘图默认的呈现方式是 Matplotlib，cufflinks把这种呈现方式改为 Plotly。cufflinks的安装方法很简单，用pip命令安装即可，代码如下。

pip install cufflinks

注意

需要注意的是，cufflinks 目前对Pandas 的支持仅局限在Jupyter Notebook 中，因此本节的代码全部是.ipynb 文件，读者需要打开Jupyter Notebook 运行这些文件。

### 4.2.2　快速入门

使用cufflinks绘制线形图非常简单，与使用Pandas绘图并没有什么不同（见文件cufflinks_demo.ipynb），代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303479099-bf10d900-b556-4a24-ac86-5da8b249b8b5.jpeg)

代码运行结果如图4-4所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303479558-42de7753-4a85-4077-ad40-5306f51743d3.jpeg)

图4-4　代码运行结果

cufflinks并不影响Pandas的使用方式，只是在底层把Pandas绘图结果的呈现方式由Matplotlib变为Plotly，我们平时怎么使用Pandas，现在还怎么使用Pandas。一般情况下，使用cufflinks改变Pandas的绘图呈现方式需要做如下几个步骤的工作。

（1）导入cufflinks

导入cufflinks的代码如下。

import cufflinks as cf

（2）设置Pandas的输出模式

设置Pandas输出模式的代码如下。

cf.set_config_file(offline=True, theme='ggplot')

本案例使用离线绘图，并使用R语言中大名鼎鼎的ggplot主题。cufflinks已经为我们封装好了多种非常流行的主题，包括polar、pearl、henanigans、solar、ggplot、space和white等，可以通过cf.getThemes()方法获取当前版本所支持的所有主题。

注意

cf.set_config_file()是一个全局变量函数，也就是说这个函数会改变当前.ipynb文件的所有Pandas 绘图环境，所以在一个文件中，这个函数只出现一次就可以了。但是为了便于理解，在每个案例中都重新运行一下这个函数，这样做的好处是每个案例都是一个独立的个体，方便测试代码。

（3）绘制图形

绘制图形的代码如下。

df.iplot(kind='scatter', filename='tmp/cf_line.html')

cufflinks只支持iplot的绘图函数，不支持plot的绘图函数，这点需要读者注意。我们可以通过输入“df.iplot?”查看其中的帮助文档，能够发现 iplot函数与Pandas默认的“df.iplot?”帮助文档已经发生了根本性的改变，具体来说就是添加了好多Plotly的参数，如图4-5所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303480129-bdbe8a8a-b261-41f5-a0e7-bd3cc16360b5.jpeg)

图4-5　帮助文档

### 4.2.3　快速获取数据

一般情况下，读者在学习数据处理与绘图的过程中，获取数据是一个很大的问题。有些读者的NumPy和SciPy水平比较高，可以通过NumPy和SciPy快速生成自己所需的数据；有些读者习惯使用外部数据，如通过df=pd.read_csv()方式获取数据。本节将介绍一种更方便地获取数据的方法，那就是通过cufflinks快速生成所需要的数据，在学习Pandas数据处理与绘图的过程中非常高效。

快速获取数据案例的代码如下（见文件cufflinks_demo.ipynb）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303480676-80139979-359e-4161-9992-dda5092b2e01.jpeg)

代码运行结果如图4-6所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303481154-592ec49c-b174-481d-aa17-f2b66d3bf770.jpeg)

图4-6　代码运行结果

这里主要介绍下面的函数：

df = cf.datagen.scatter() # 生成散点图数据

cf.datagen是cufflinks封装好的生成Pandas数据的模块，里面包含了常见的绘图（如bar、pie、scatter、ohlc）数据所需要的函数，本案例使用了scatter数据。读者可以通过dir(cf.datagen)命令查看可用的数据。在绘图过程中使用这些数据非常方便。

### 4.2.4　自定义绘图

cufflinks的绘图函数df.iplot功能强大，当然参数也比较多，本案例主要讲解其中常见且高效的一些参数的使用方法，以实现更丰富的绘图功能。

本案例的代码如下（见文件cufflinks_demo.ipynb）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303481689-a34edeb3-50e2-4e85-b1b0-d7795dd2fe9f.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303482122-6ca5b789-7ce9-4ed7-b8a8-f32f2c9860d0.jpeg)

代码运行结果如图4-7所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303482698-e3694cae-cdfe-499c-a9c3-763873dcaf25.jpeg)

图4-7　代码运行结果

上面的代码虽然简单，但是实现的功能还是挺强大的，实现了如下功能。

（1）自定义数据源，定义数据生成的长度和每条数据的名称

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303483168-96765310-3ddf-4eed-9762-fb106637e5b4.jpeg)

（2）自定义每条线的颜色、类型和宽度

colors = ['red', 'blue', 'black'] # 自定义每条线的颜色

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303483776-5ef08883-4333-4ecf-86df-c50e60919249.jpeg)

（3）自定义图与坐标轴的标题

xTitle='日期',yTitle='数量',title='自定义绘图'

经过以上操作，基本上完成了一幅图的常见设置。

### 4.2.5　常见经典图形

前面主要介绍了线形图和散点图，接下来介绍其他常见的经典图形（见文件cufflinks_demo.ipynb），代码如下。

1.柱状图

绘制柱状图的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303484384-c74578b7-dd5c-4b04-8c66-012d6c87d30d.jpeg)

代码运行结果如图4-8所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303484883-fbae19ec-b4e2-46f5-af5d-0d326e93ea89.jpeg)

图4-8　柱状图

2.层叠柱状图

绘制层叠柱状图的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303485383-67fd2a27-f111-4af1-9c0d-e28b27af706b.jpeg)

代码运行结果如图4-9所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303485946-22816da0-b4d4-4809-a6c6-c83f172f59b0.jpeg)

图4-9　层叠柱状图

3.散点图

绘制散点图的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303486402-cee36143-dd97-4347-8fd4-b5cc69a46912.jpeg)

绘图结果如图4-10所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303486944-f47ef693-8bb8-413c-84a8-d0b4ec96698e.jpeg)

图4-10　散点图

4.价差图

绘制价差图的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303487413-936b9466-cc2a-4464-8dd2-165a415cdeab.jpeg)

绘图结果如图4-11所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303487966-f35aed28-3897-418a-bf4e-505014bc40ff.jpeg)

图4-11　价差图

5.直方图

绘制直方图的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303488477-4043cfa0-3158-4e5f-81a3-28a42c12e9e3.jpeg)

绘制结果如图4-12所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303489022-cc12b563-8ed3-4329-ba99-9d8b71e05852.jpeg)

图4-12　直方图

6.时间序列子图

绘制时间序列子图的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303489543-f05ddb7c-10b6-486a-bdad-06eabef45a55.jpeg)

绘图结果如图4-13所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303490088-c044dc5d-4b9a-48c6-8254-537a33699cf0.jpeg)

图4-13　时间序列子图

7.3D散点图

绘制3D散点图的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303490570-47eaa877-254c-4a71-8d94-ace7a30f7168.jpeg)

绘图结果如图4-14所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303491118-179f97bb-6ffd-4c07-b98e-b1fbfb2fb698.jpeg)

图4-14　3D散点图

### 4.2.6　更多案例

cufflinks是一个非常简单且易用的模块，读者若想对这个模块有更多的了解，可以参考下面的内容。

（1）想要获取cufflinks的源代码或最新版本的信息，可以在下面的网址中找到：https://github.com/santosjorge/cufflinks。

（2）想要获取 cufflinks的更多案例代码，可以在上面打开的网页中选择 Chart Gallery链接，也可以在上面打开的网页中下载文件 Cufflinks Tutorial - Chart Gallery.ipynb并打开，在本地计算机中查看。

（3）想要获取 cufflinks高级一些的案例代码，可以在上面打开的网页中选择Pandas Like Visualization链接，也可以在上面打开的网页中下载文件 Cufflinks Tutorial - Pandas Like.ipynb并打开，在本地计算机中查看。

# 第5章　金融绘图

K线图在金融绘图领域中有着重要的地位，而Plotly在金融绘图领域有着自己独特的优势。本章主要讲解如何把Plotly更好地应用在金融绘图领域中。

## 5.1　快速绘制K线图

### 5.1.1　检查Plotly版本

导入Plotly绘图模块库后检查一下版本是否为最新，截至2017年11月17日，Plotly最新版本为2.2.1。

检查Plotly版本的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303491512-0b5dd42a-0328-4dc5-adc9-1629bef96e32.jpeg)

### 5.1.2　快速绘制OHLC（美国线）图

Pandas是金融领域中非常好用且高效的数据分析与处理模块，借助Pandas处理数据的便利性，绘制K线图简直不费吹灰之力。

快速绘制OHLC图（见文件first_ohlc.py）的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303492112-f778a83c-98dc-466c-9e03-646442745296.jpeg)

在上面的代码中，最核心的是下面的函数。这个函数看起来很简单，基本没有介绍的必要。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303492696-0fe14c8d-efff-43f0-9f9e-0983ff0c3ba7.jpeg)

绘图结果如图5-1所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303493260-f8416a0e-ac34-441d-b553-6bde00bdbe79.jpeg)

图5-1　绘制OHLC图

从图5-1可以看出，go.Ohlc函数绘制的K线图效果非常不错，而且还在K线图下面封装了滑块，方便切换时间。go.Ohlc函数是Plotly为了方便用户使用，专门为绘制K线图封装的一个对象。笔者之前学习Plotly时，绘制OHLC图使用的是如下代码（见文件first_ohlc_old.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303493802-45a04db0-d0a5-4089-842c-a758bed7ad50.jpeg)

绘图结果如图5-2所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303494352-91e780fc-85ab-4d15-b0d0-8b19f5f6a30a.jpeg)

图5-2　没有滑块的OHLC图

可见，除了没有滑块，绘图结果是一样的。

### 5.1.3　快速绘制蜡烛图

下面编写代码绘制蜡烛图（见文件first_candlestick.py），代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303494848-2a1e754f-9dcc-43a2-b831-d5e9053a30c9.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303495337-4075beea-65ab-4ddb-b208-b1a8367c24ec.jpeg)

以上代码只是把“Ohlc”换成“Candlestick”而已，绘图结果如图5-3所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303495838-2615014c-3ac7-4700-bfd5-03082ae538d2.jpeg)

图5-3　绘制蜡烛图

同样的，给出以前版本绘制蜡烛图的代码（见文件first_candlestick_old.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303496335-e3c0da59-0c8a-40d3-886e-77ea3cdbbd83.jpeg)

绘图结果如图5-4所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303496881-bdd9d84d-43a2-4be1-acbb-a09b508cb780.jpeg)

图5-4　以前版本绘制的蜡烛图

注意

go.Ohlc 函数与go.Candlestick 函数使用起来虽然简单明了，效果也不错，但是有一个致命的缺陷，那就是绘图结果中包含了所有的日期信息（例如非交易日，图中的9 月9 日—9 月12 日），这个问题会放到下一节去解决。

## 5.2　K线图的优化

### 5.2.1　过滤非交易时间

过滤非交易时间属于对X轴的操作，这个工作需要在布局管理中进行。我们通过go.Ohlc函数返回的对象本质上是一个data，需要对这个data添加布局，形成一个完整的fig（见文件ohlc_filter_time.py），代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303497423-6fe701ae-6bcc-46a7-a578-ea2de9c122a3.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303497964-7370c1db-d882-4e6f-ba58-f816159f2cc6.jpeg)

绘图结果如图5-5所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303498480-33759e50-8cc6-4c75-9bc7-22f36c07ab71.jpeg)

图5-5　过滤非交易时间的K线

在上面的代码中，最关键的是如下两行代码：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303498951-8ec65d95-7222-425f-bd15-2c5ceb3aa3b7.jpeg)

这两行代码的意思是，把 X轴的元素看成分类的元素（type='category'），并对其进行升序排序（categoryorder="category ascending"）。既然元素的属性为类别，不是时间，也就没有过滤非交易时间的问题了。

对于categoryorder参数，默认是“trace”，即以默认的df.index进行排序。它可以是升序（category ascending），也可以是降序（category descending），甚至可以自定义顺序（array），不过这时需要额外的参数支持（categoryarray），用来传递自定义的index。

对于蜡烛线来说，其过滤方法也是一样的，代码如下（见文件candlestick_filter_time.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303499496-4a1a2ad3-f8e0-46a3-9cc3-d479cf1e36cf.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303499995-c4617c09-3cd4-4eb9-b988-8af34365aca7.jpeg)

绘图结果如图5-6所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303500515-331bb5f5-589f-4c57-855e-797326780225.jpeg)

图5-6　过滤非交易时间的蜡烛线

### 5.2.2　设置形状、颜色和注释

设置K线图的标题、形状、颜色和注释并没有什么特别之处，代码如下（见文件 candlestick_style.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303500902-cd5e0567-ee9c-4132-a883-ffbcb0855208.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303501509-4dd7ab78-1f41-4e56-a774-4aa262944292.jpeg)

绘图结果如图5-7所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303501914-f93d0f51-bbe3-4d3f-ba00-212e6492ab14.jpeg)

图5-7　绘图结果

对于颜色，将价格上涨设置为红色，将价格下跌设置为蓝色，这样的设置更符合我国用户的习惯，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303502316-8906f7a9-14ba-4ff6-940b-d8c93b9da543.jpeg)

对于标题，可以在layout中进行设置，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303502608-a1f396c3-cc20-4456-9bdc-e5ef0e376e6b.jpeg)

设置形状与注释的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303502959-e1bf1257-6673-4cc2-b2b8-a9717a4265fe.jpeg)

读者需要理解xref与yref这两个参数，这两个参数在本书3.7节“绘制SVG”中介绍过。为了方便读者更好地理解，这里再次说明一下。

xref（yref）参数有 2个值：paper和 x（y）。如果值为x，则x0、x1对应的值为坐标轴的绝对值，比如“x0='2016-08-22'，x1='2016-10-05'”表示 shapes（layout的一个参数，见代码 ohlc_style.py）的 X轴起点在 x0='2016-08-22'处、终点在x1='2016-10-05'处；如果值为paper，则x0、x1对应的值为坐标轴的相对值。以本案例来说，“y0=0，y1=1”表示shapes的Y轴起点在y0=0处、终点在y1=1处。

对于OHLC图，其绘制方法是一样的（见文件ohlc_style.py），代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303503239-20107f4a-296f-4612-983a-987d11276877.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303503734-70d0ad4e-0947-434b-8b60-9d333a7f2501.jpeg)

绘图结果如图5-8所示。

注意

这里绘制的OHLC 图没有开盘价与收盘价，这应该是Plotly 的bug，希望在下一个版本中Plotly 可以解决这个问题。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303504084-8a651aee-c72f-492b-9fbb-a9f85b1b273f.jpeg)

图5-8　OHLC图绘图结果

### 5.2.3　添加技术指标

在实际工作中，K线图往往是需要结合其他技术指标进行判断的，因此我们需要绘制一个复合的K线图。本节主要介绍K线图与5日均线结合的方法，对于其他的技术指标如 MACD、RSI、KDJ等，可以根据这个方法进行扩展，代码如下（见文件candlestick_add_avg.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303504673-4fb2dddc-3fca-4712-bf9b-e46a4c577c2f.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303505093-b1d89651-d417-4dcb-bdd6-427cc7200482.jpeg)

绘图结果如图5-9所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303505436-a30d5377-895a-44e0-b837-39f459f79fa4.jpeg)

图5-9　K线图与5日均线结合

本案例的要点如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303505859-d1883b2d-7531-48f4-aef9-a10008dd0f03.jpeg)

可以看出，绘制方法与之前所学的知识一样，这里不再赘述。

对于OHLC图，绘制方法相同（见文件ohlc_add_avg.py），代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303506268-5d6bf012-7d90-4607-801c-dbd4eef8e6dd.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303506796-aab33a81-10c1-46ba-abce-e2c483c57626.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303507184-9437bf3a-79a3-4860-87ac-961ed0fb3759.jpeg)

绘图结果如图5-10所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303507505-0f5564f9-1e93-42cf-b3ac-1a21664ec8d6.jpeg)

图5-10　OHLC绘制结果

注意

与之前的情况一样，这里绘制的OHLC 线仍然没有开盘价与收盘价，这应该是Plotly 的bug，希望在下一个版本中Plotly 可以解决这个问题。

## 5.3　使用自定义数据的金融绘图

创建K线图不一定要使用标准的OHLC价格图，可以使用自定义的数据，方法非常简单（见文件ohlc_custom_data.py），代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303507862-08272be0-67c7-48fb-bdba-05d99785eb2d.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303508238-04b778cd-90e7-4928-9620-6e482333688a.jpeg)

绘制结果如图5-11所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303508561-4f0d3fe0-9bbd-4aa7-a5af-368db436db67.jpeg)

图5-11　使用自定义数据绘制价格图

对于蜡烛图，代码如下（见文件candlestick_custom_data.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303508926-6b5f3231-6f6a-4c29-a671-e808594d8874.jpeg)

绘图结果如图5-12所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303509312-fab0efa7-ea29-4489-a54a-821b82d15f6a.jpeg)

图5-12　使用自定义数据绘制蜡烛图

## 5.4　高级金融绘图

前面讲解了手工添加技术指标的方法，这种方法比较笨，虽然可以利用talib等技术指标的专业模块来搞定这些问题，可是对于新手来说还是比较困难的。幸运的是，cufflinks开发团队已经帮我们解决了这个问题：从cufflinks的v0.11版本开始，增加了QuantFig函数，使用这个函数能让金融绘图更加方便。

### 5.4.1　入门案例

QuantFig函数的使用非常简单，与一般cufflinks函数的使用方法相比，只加了一行代码，见文件“高级金融绘图.ipynb（ 5.4.1 入门案例）”，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303509596-15f1113a-0659-468e-9e6c-182ba6853da9.jpeg)

绘图结果如图5-13所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303510010-d74a5c34-d06e-4d83-9f04-919de9f16f0d.jpeg)

图5-13　高级金融绘图结果

从绘图结果可以看出，我们以很简单的方式绘制了K线图并在K线图上添加了布林线。

这个案例的关键代码是下面这一行：

qf=cf.QuantFig(df,title='高级金融绘图',legend='top',name='QF')

这行代码的作用是把传统的DataFrame对象转换成QuantFig对象，从而方便我们绘图。

### 5.4.2　综合案例

在实际工作中，要添加更多的指标也非常简单，见文件“高级金融绘图.ipynb（5.4.2 综合案例）”，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303510362-1f896384-bf2e-46f2-94f1-600a3e9d74c0.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303510706-6015c7eb-35e3-481d-bf51-06422f91cd7d.jpeg)

绘图结果如图5-14所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303511061-cdd7d62c-3fef-4952-999e-e09380f790c1.jpeg)

图5-14　添加更多指标的高级金融绘图结果

由此可见，我们通过简单的几行代码就创建了 K线图的多种技术指标，如MACD、RSI、布林线等。这些指标都在 QuantFig中封装好了，我们只需要调用就可以了。QuantFig函数还能自动添加子图，总体效果看起来非常不错。

# 第6章　Matplotlib

## 6.1　Matplotlib简介

Matplotlib是Python的一套基于NumPy的绘图工具包，并且是Python中最著名的绘图包之一。Matplotlib提供了一整套和MATLAB相似的命令API，十分适合交互式绘制图表，并且Matplotlib可以方便地将API作为绘图控件，嵌入到GUI应用程序中。

Matplotlib功能完善，其风格跟MATLAB相似，同时也继承了Python简单明了的语法风格，可以很方便地设计和输出二维和三维的图表，对于常见的坐标系，如笛卡儿坐标系、极坐标系、球坐标系、三维坐标系等都能够很好地支持。

虽然Matplotlib最初是在模仿MATLAB图形命令时被设计的，但是它的底层使用的却是Python语法风格和面向对象的方式，与MATLAB没有太大的关系，两者是相互独立的。为了提高处理大量数据的性能，Matplotlib大量使用了NumPy和其相关的扩展代码。为了方便快速绘图，Matplotlib通过 pyplot模块提供了一套和MATLAB类似的绘图API，我们只需要调用pyplot模块所提供的函数，就可以实现快速绘图及设置图表的各种细节。

为了将面向对象的绘图库包装成只使用函数的调用接口，pyplot模块的内部保存了当前图表及当前子图等信息。

另外，pylab是 Matplotlib面向对象绘图库的另一个接口。pylab的语法和MATLAB十分相近，主要的绘图命令和MATLAB对应的命令也有相似的参数。pylab接口由matplotlib.pylab提供函数集，允许用户使用非常类似于MATLAB绘图的方式快速创建绘图。

由于 Matplotlib功能强大，所以受到绘图工作者和科研工作者的青睐。下面从绘图的第一步：安装Matplotlib开始介绍。

## 6.2　安装Matplotlib

想要绘图，就需要下载并安装 Matplotlib。笔者推荐用 pip命令来安装，进入CMD窗口中，通过pip install matplotlib命令进行安装，系统会自动下载安装包，如图6-1所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303511444-6d7a3ece-d54a-4ed1-bb84-c43262011648.jpeg)

图6-1　系统自动下载安装包

正常情况下，系统还会下载其他的关联安装包并完成安装，最后系统会提示用户Matplotlib已经安装成功，如图6-2所示。

进入Python IDLE中，运行“import matplotlib”，如图6-3所示，就可以开始使用Matplotlib了。如果不想自己安装Matplotlib，可以下载Anaconda等Python的集成工具。Anaconda是一个开源的 Python发行版本，包含了 Conda、Python等 180多个科学包及其依赖项。因为包含了大量的科学包，所以Anaconda的下载文件比较大（约500 MB）。Anaconda提供了很多用于科学计算的模块，常见的包括NumPy、SciPy和Matplotlib。Anaconda官方下载地址为https://www.anaconda.com/download/，选择相应的版本下载并安装即可。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303512130-83ad01f2-0835-40a3-bdcc-ef41e65c49af.jpeg)

图6-2　下载关联安装包并提示安装成功

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303512523-6e56aa75-0fdf-4409-8800-dabfc0de4708.jpeg)

图6-3　运行“import matplotlib”

## 6.3　调整Matplotlib参数

安装好Matplotlib后，要为绘图项目设置Matplotlib参数。

在代码执行的过程中，有以下两种方式可以调整参数。

1.使用参数字典

使用参数字典调整参数的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303513128-9f6bed94-33b8-4bca-9395-1764113ab0c7.jpeg)

打印参数，由于参数众多，所以我们把输出的参数进行简化，得到如下参数。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303513721-936c077e-fb81-48e8-a751-13ff2a758498.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303514230-5115560f-db98-4e6f-ada9-9f858524c7bc.jpeg)

在以上参数中，常用的参数解释如下。

● axes：设置坐标轴边界、颜色、坐标刻度值大小和网格的显示。

● figure：设置边界颜色、图形大小和子区（subplot）。

● font：设置字体、字号和样式。

● grid：设置网格颜色和线型。

● legend：设置图例和其中的文本的显示。

● lines：设置线条（颜色、线型、宽度等）和标记。

● savefig：对保存的图形进行单独设置。

● xtick和ytick：为X、Y轴的主刻度和次刻度设置颜色、大小、方向和标签大小。

接下来，调用matplotlib.rc()命令，通过传入关键字修改参数，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303514784-2b738199-2c25-49be-91b0-9cf0d0e9ea4f.jpeg)

2.修改配置文件

可以用matplot.matplotlib_fname()命令查找当前用户的配置文件目录，从而修改Matplotlib的文件参数，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303515270-6b5254a0-42b4-4112-bf44-746195ffd84d.jpeg)

获取配置文件的路径，笔者的配置文件的计算机路径输出为：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303515833-7a4b81f3-4980-41ea-abec-ef68d926521e.jpeg)

找到上述路径，再找到matplotlibrc文件，用编辑器打开，即可修改配置参数，参数截图如图6-4所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303516298-0b692ee7-fed3-47d4-91a1-3947a84c26bb.jpeg)

图6-4　配置参数

## 6.4　常用的API功能

下面列出matplotlib.pyplot的一些常用函数，需要注意的是，假设我们已经通过代码import matplotlib.pyplot as plt导入了Matplotlib，并且下面的所有函数都省略了“plt.”，例如我们看到的figure()函数实际上是plt.figure()函数。

● figure()：多次使用figure命令生成多个图时，图片号按顺序增加。

● text()：添加文字说明，可以在图中的任意位置添加文字，并支持LaTeX语法。

● xlable()、ylable()：用于添加X轴和Y轴标签。

● title()：用于添加图的标题。

● axis([xmin, xmax, ymin, ymax])：用于确定坐标范围。

● xlim(xmin, xmax)和ylim(ymin, ymax)：用来调整坐标范围。

● annotate()：文本注释，在数据可视化的过程中，图片中的文字经常被用来注释图中的一些特征。使用 annotate()方法可以很方便地添加此类注释。在使用annotate()时，要考虑两个点的坐标，即被注释的地方xy(x, y)和插入文本的地方xytext(x, y)。

● xticks()、yticks()：设置轴记号，人为设置坐标轴刻度显示的值。

● subplot()：设置子图，例如subplot(2,3,1)表示把图分割成2×3的网格，也可以简写为subplot(231)。其中，第一个参数是行数，第二个参数是列数，第三个参数表示图形的标号。

● axes()：在Matplotlib中，整个图像为一个Figure对象。Figure对象中可以包含一个或多个axes对象。每个axes对象都是一个拥有自己坐标系统的绘图区域。

## 6.5　线性函数

Matplotlib中最基础的模块是pyplot。下面从最简单的点图和线图开始讲解，比如有一组数据，还有一个拟合模型，通过编写代码来实现数据与模型结果的可视化。

假设一个线性函数具有形式y=f=ax+b，自变量为x，因变量为y，Y轴截距为b。下面用简单的数据来描述线性方程（见文件simple_line.py），代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303516810-cb634b3f-cee3-4e81-b891-e4db4688c321.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303517338-eac76f08-aa4d-4be0-8486-b3cb4be040d9.jpeg)

绘图结果如图6-5所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303517868-b13cc0da-1637-40b3-8cac-8b9138b02acc.jpeg)

图6-5　线性函数绘图结果

## 6.6　增加子图

1.案例1

在绘图时，有时需要把几幅图放在一张图表中。在 Matplotlib中，一个 Figure对象可以包含多个子图（axes），可以使用subplot()函数快速绘制，其调用形式如下：

subplot(numRows, numCols, plotNum)

整个绘图区域被分成numRows行和numCols列，plotNum参数指定创建的axes对象所在的区域，如果numRows＝2、numCols＝2，那么整个绘图区域为2×2的图片区域，用坐标表示为（1，1）、（1，2）、（2，1）、（2，2）。本案例见文件 subplot_1.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303518418-6da1b79f-7e6f-4e20-9d50-62b4cd464cdd.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303518916-c932cf9a-8279-4a6c-ad11-c8c6e6c6e36f.jpeg)

绘图结果如图6-6所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303519449-486f873e-9bac-48db-a8d3-e306fb849ba2.jpeg)

图6-6　增加子图绘图结果1

2.案例2

本案例见文件subplot_2.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303519962-14a6b41c-2522-4ea3-a543-12be254bb009.jpeg)

绘图结果如图6-7所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303520437-9a182b10-cd47-4c6e-a8a9-277865b757d3.jpeg)

图6-7　增加子图绘图结果2

## 6.7　确定坐标范围

在 Matplotlib中，使用 xlim(x,y)和 ylim(x,y)函数可以确定坐标范围（见文件axis_limit.py），代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303521083-30685a39-70a5-4f2a-9337-97d20fe109fe.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303521559-d209bb3f-51a8-4747-a92b-c71ee3b39fbb.jpeg)

绘图结果如图6-8所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303521931-9709002f-ee67-4f3b-b149-d7a872832b46.jpeg)

图6-8　确定坐标范围的绘图

## 6.8　概率图

概率图模型是图灵奖获得者 Pearl提出的用图来表示变量之间概率依赖关系的理论。概率图模型的理论分为概率图模型表示理论、概率图模型推理理论和概率图模型学习理论。

正态分布（Normal Distribution），也称为常态分布，又名高斯分布（Gaussian Distribution），是一个在数学、物理及工程等领域都非常重要的概率分布，在统计学的许多方面有着重大的影响力。正态分布最早由A.棣莫弗在求二项分布的渐近公式中得到。正态曲线呈钟形，两头低，中间高，左右对称，因其曲线呈钟形，所以人们经常称之为钟形曲线，其形状如图6-9所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303522511-6008c55a-5786-4060-8184-6f6d0a9f97ed.jpeg)

图6-9　正态分布曲线

在实际应用中，经常使用的是正态概率密度函数normpdf。normpdf的语法格式为：normpdf（X,mu,sigma）。其中，X为一个向量，mu为均值，sigma为标准差（本案例见文件probability_density.py），代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303523088-a817a14e-c22d-47be-85be-034e615dd04b.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303523611-303fb4f1-835c-41ed-83a2-24d5b470491f.jpeg)

绘图结果如图6-10所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303523990-1dd91a0c-54a4-438c-ae78-0e2f546b9f23.jpeg)

图6-10　正态分布曲线绘图

## 6.9　散点图

1.散点图一

散点图是指在回归分析中，数据点在直角坐标系平面上的分布图。散点图表示因变量随自变量变化的大致趋势，据此可以选择合适的函数对数据点进行拟合。

用两组数据构成多个坐标点，考察坐标点的分布，用来判断两个变量之间是否存在某种关联或用来总结坐标点的分布模式。散点图将序列显示为一组点，值由点在图表中的位置表示，类别由图表中的不同标记表示。散点图通常用于跨类别的聚合数据。

本案例见文件scatter_1.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303524324-9463bbaf-2fc5-449f-8b52-cb5cb6a3b787.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303524704-267b2114-c0b5-4f03-a9da-dd817d259a09.jpeg)

scatter函数的用法是 scatter(x, y, s=None, c=None, marker=None, cmap=None,norm=None, vmin=None, vmax=None, alpha=None, linewidths=None, verts=None,edgecolors=None, *, data=None, **kwargs)

scatter函数中比较常用的参数解释如下。

● x,y：形如shape(n,)的数组，可选值。

● s：点的大小（也就是面积），默认值为20。

● c：点的颜色或颜色序列，默认为蓝色，其他如c = 'r' (red)、c = 'g' (green)、c = 'k'(black)、c = 'y'(yellow)。

● marker：形状，可选值，默认是圆。

绘图结果如图6-11所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303525079-61da210c-194a-41d8-bd63-b80f4ce31839.jpeg)

图6-11　散点图一绘图结果

2.散点图二

本案例见文件scatter_2.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303525658-bc1d00d6-fb96-4890-83cf-bb75b3591265.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303525972-2012295e-a359-4d91-b3d7-161fe6409023.jpeg)

绘图结果如图6-12所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303526777-03394f9d-e235-47a7-93d8-b706c3b469de.jpeg)

图6-12　散点图二绘图结果

## 6.10　柱状图

1.柱状图一

柱状图是一种以长方形的长度为变量的表达图形的统计报告图，由一系列高度不等的纵向条纹表示数据分布的情况，用来比较两个或以上的价值（不同时间或不同条件）。如果只有一个变量，则通常用于较少的数据集分析。柱状图也可横向排列，或者用多维方式表达。

本案例见文件bar_1.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303527407-1890ab8f-6026-4cf1-b96b-029a5f6ae0f4.jpeg)

bar函数的使用方法是：bar（left, height, width, bottom=None, **kwargs）。

事实上，left、height、width、bottom这四个参数确定了柱体的位置和大小。默认情况下，left为柱体的居中位置（可以通过align参数改变left值的含义），即：

● （left - width / 2, bottom）为左下角位置；

● （left + width / 2, bottom + height）为右上角位置。

绘图结果如图6-13所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303527907-0ad0924d-3bbc-4119-affb-8cb5e5652771.jpeg)

图6-13　柱状图一绘图结果

2.柱状图二

本案例见文件bar_2.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303528424-9200a334-9364-4e32-b2d5-d436c049bfc8.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303529008-da880cab-a40a-4a09-a762-02de36abab6c.jpeg)

绘图结果如图6-14所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303530007-f081c470-c2d6-48d7-aeae-2e941e9ead08.jpeg)

图6-14　柱状图二绘图结果

## 6.11　更多扩展

读者可以打开网址https://plot.ly/matplotlib/，获取Matplotlib与Plotly结合的所有官方案例（如图6-15所示）。与标准的 Plotly实例相比，内容少了一些，但是胜在可以和 Matplotlib无缝结合，而且绝大部分绘图类型都能找到，特别适合对Matplotlib熟悉的读者。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303530482-de361fe0-1bc5-49de-9809-6b66c9637e5e.jpeg)

图6-15　官方案例

# 第7章　Plotly与网页开发

## 7.1　Plotly在Django中的应用

Django是用Python语言开发的一个免费开源的Web框架，用于快速搭建高性能、优雅的网站，通过Django可以建立一个高性能的Web应用而只花费最少的时间和精力。

Django中提供开发网站经常用到的模块，常见的代码都为用户写好了，通过减少编写重复的代码，用户能够专注于Web应用上关键性的东西。为了达到这个目标，Django提供了通用Web开发模式的高度抽象和频繁进行编程作业的快速解决方法，并为“如何解决问题”提供了清晰明确的约定。Django的理念是DRY（Don't Repeat Yourself），鼓励用户快速开发！

对于本章内容，首先假设读者已经对Django和Plotly有了一些基本的了解，本章内容的重点是把Plotly嵌入到Django中，并不会过多地介绍Django与Plotly的具体细节内容。

### 7.1.1　安装环境搭建

Django的安装配置非常简单，如果本地计算机已经安装了Django，则不再进行安装；如果没有安装，则可以通过下面的命令安装最新版本的Django，只需要简单的一行代码：

pip install django

### 7.1.2　安装环境测试

安装好Django安装包以后，需要测试安装环境是否搭建成功。首先，可以通过下面的命令创建一个新的Django项目，此处命名为ploty_and_django，代码如下。

django-admin startproject plotly_and_django

运行完上面的命令后，会得到下面的层级结构。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303530950-cb58d6aa-8da3-4984-95ef-fc67f80e1465.jpeg)

这些文件的具体含义如下。

（1）manage.py：这是项目交互的命令行实用程序，是 django-admin.py工具周围的薄型包装，不需要编辑此文件。

（2）plotly_and_django/：用户的项目文件夹，包含以下文件。

● __init__.py：一个空的文件，用来告诉Python把这个文件当作Python的包对待。

● settings.py：用于调整项目的设置和参数。

● urls.py：用来储存项目中的URL，Django会通过正则表达式来匹配URL。

● wsgi.py：里面包含了通过WSGI方式运行Django项目的一系列参数。

接着，在本地计算机上通过下面的命令运行测试服务器：

python manage.py runserver

注意

确保已经进入项目的文件夹，如果没有运行这条命令，则会直接运行后面的命令：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303531161-5de8c3eb-0bb9-470e-8cdb-8faed9f2d1c3.jpeg)

这时会看到类似下面的输出结果：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303531508-6caf801e-1e79-4ea1-950e-dbf9df701090.jpeg)

打开浏览器，在地址栏中输入 http://127.0.0.1:8000/，如果一切正常，就会看到Django欢迎页面，如图7-1所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303532020-1231c718-a7c6-4de2-8eea-afd83d5e06b7.jpeg)

图7-1　Django欢迎页面

于是，我们成功配置了Django的安装环境。

注意

本案例不需要和数据库连接，如果今后的项目需要和数据库连接，请确保每次修改数据表格定义时使用下面的命令：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303532465-24c449ce-c8f7-43a6-aa3d-b2a0fdd5f1c5.jpeg)

执行上面的命令后，就会看到类似下面的输出：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303533052-492eeee9-d045-4216-bf7c-b430db665e6b.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303533583-54d805bc-f4e7-48a9-b5e5-9ba10cf7dba8.jpeg)

### 7.1.3　入门案例一

下面把Django和Plotly进行简单的结合，具体的原理是在前端访问服务器时，Django会在服务器端生成包含Plotly绘图结果的HTML文件，然后返回给浏览器，从而实现数据的可视化，具体步骤如下。

（1）新建一个应用

通过下面的命令在项目中新建一个应用，命名为visual_plotly。

python manage.py startapp visual_plotly

这时项目文件夹中会多出一个名称为visual_plotly的文件夹。一个Django项目可以有多个应用，每个应用都有一个这样的文件夹与之对应。visual_plotly文件夹中会自动生成下面的文件目录结构：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303534099-bdbadeca-4a50-4cd5-8214-b0a53740a7b4.jpeg)

对上面的目录结构解释如下。

● migrations：这个文件主要包含该应用和数据库相关的所有变化。Django记录这些变化，就能保证数据库与Django同步更改。

● admin.py：在该文件中可以决定应用是否在Django的Admin页面注册，Django的Admin页面是Django自带的一个管理平台，功能比较强大，也很好用，这里不做过多说明。

● models.py：用于定义应用中用到的模型，模型实际上就是一些数据表格，这些表格能和数据库的表格一一对应。Django通过这种方式提供了统一的接口，这样即使更换了数据库，比如从MySQL到Oracle，项目中的代码都可以不用该数据表格，只要模型没有改变。

● tests.py：可以添加一些测试代码用来测试应用。

● views.py：存放处理HTTP请求的内容，本案例将会在这里添加Plotly代码，实现返回HTML页面。

（2）创建templates文件夹

在　plot_and_djano文件夹下面创建　templates文件夹，然后打开plot_and_django/settings.py文件，修改里面关于 TEMPLATES的部分，这里只需要修改关于“DIRS”的那一项。为了便于比较，整段代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303534461-1efa4160-e5b5-4295-9957-80226b52f375.jpeg)

在templates文件夹中新建index.html文件，并输入下面的代码：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303534754-ede0c425-8706-44b1-b3ef-eea79b0c3814.jpeg)

（3）修改urls.py文件

对plotly_and_django/urls.py文件做如下修改：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303535171-014f71a3-6c3e-4ef9-aa97-408d750bd5cc.jpeg)

这里把首页指向了新建的 visual_plotly应用，其实完全可以对某个特殊的地址进行绑定，在这里不做过多介绍。

（4）新建urls.py文件

在visual_plotly中新建urls.py文件，并添加下面的代码：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303535516-461fc4d0-bc0d-448a-982a-23540c2458ae.jpeg)

对于分配到的请求，调用views文件里面的plotly_view函数。

（5）修改views.py文件

修改visual_plotly/views.py文件，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303535753-3e9c6116-3f84-4b67-99c3-18eef14577ca.jpeg)

在这个函数中可以嵌套不同的 Plotly绘图代码，无论数据是从数据库动态调取的，还是结合其他复杂逻辑的，比如分情况生成不同的图，这种框架都能将 Plotly绘图嵌套在网页中。

（6）启动本地测试服务器

在命令行窗口输入如下代码：

python manage.py runserver

打开浏览器，在地址栏中输入网址 http://127.0.0.1:8000/，就会看到通过 Plotly生成的网页，如图7-2所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303536185-7397febc-0b0f-4393-86e1-e181c211ab11.jpeg)

图7-2　通过Plotly生成的网页

由此，我们实现了把Plotly嵌入到Django网页开发的第一个应用。

### 7.1.4　入门案例二

前面我们完成了简单的入门案例，注意这个案例有一个缺点，那就是传入的div参数有点大，约有2MB。如果一个网页中只有一两个这种绘图，用这个案例的方法是可以接受的，但是如果有多个绘图，用这个案例的方法就不太现实了，因为会导致页面数据量太大而给服务器造成很大的压力，下面来看一下出现这个问题的原因。

首先，要分析一下传递的div参数是什么。打开test_memory1.py文件并运行，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303536565-c183608c-8c77-47fc-a582-47f769480a0a.jpeg)

输出结果如下：

参数div占用内存大小为 2341594 bytes

这个div参数非常大，约有2MB，它本质上是plotly.js与调用plotly.js绘图代码的结合体，打开div1.txt就可以看到这个文件前面的内容是plotly.js文件，后面的几行内容才是绘图的代码。我们实际需要的是后面的代码，对于前面的plotly.js，只需要在HTML文件中引用一次，没必要每次绘图都重新引用。

因此，需要剥离 plotly.js，方法很简单，只需要在原来的基础上加上参数include_plotlyjs=False就行了，代码如下（见文件test_memory2.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303536828-12aa034b-147c-4ba4-bfe6-792594f6c865.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303537348-33cdf22b-bdfb-439f-b432-ab15bbb0e3f3.jpeg)

运行结果如下：

参数div占用内存大小为 695 bytes

打开div2.txt文件，会看到如下内容：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303537882-353967ef-920d-46ff-a0be-b573622b4d95.jpeg)

这才是Plotly真正的代码，实际上我们只需要在HTML文件中引用这段代码就行了，plotly.js可以通过其他方式导入。

下面讲解如何将剥离plotly.js后的div嵌入到Django中。我们这次的案例建立在“入门案例一”的基础上，只需要进行一些改动，步骤如下。

（1）复制plotly.min.js文件

在plotly_and_django目录下新建文件夹static，复制plotly.min.js文件（笔者的Python环境目录为：d:\Anaconda3\Lib\site-packages\plotly\package_data\plotly.min.js）到static文件夹，目录结构如下：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303538375-d6d101a6-c0fc-480a-b587-d8449bead072.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303538858-5c5a7d71-b77b-4af5-ba47-f3301adb3653.jpeg)

（2）修改setting.py文件

修改plotly_and_django/settings.py文件，添加static文件路径，方便Django查找plotly.min.js，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303539340-774d64ce-9c52-47fb-9d47-19c5d340fc51.jpeg)

（3）修改urls.py文件

修改　visual_plotly\urls.py文件，添加如下信息（意思是新建一个页面如http://127.0.0.1:8000/demo2，指向plotly_view2），代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303539874-7de7cf86-bd45-4188-be38-8928b5c58821.jpeg)

（4）修改views.py文件

修改visual_plotly/views.py文件，添加如下函数：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303540344-fb9068a4-774a-40a1-b403-45c7c0ec7846.jpeg)

（5）修改index.html文件

修改templates/index.html文件，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303540860-38006042-9439-450e-937c-abffd72f8e5a.jpeg)

与之前的index.html文件相比，添加了如下代码：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303541448-2005d0d8-3e30-457c-82ce-3a8faea4d804.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303541933-01697f18-f2ba-41c2-8109-8bbcd034d0ae.jpeg)

（6）运行测试

在命令行窗口输入如下代码：

python manage.py runserver

打开浏览器，在地址栏中输入http://127.0.0.1:8000/demo2，将会看到通过Plotly生成的新页面（如果输入http://127.0.0.1:8000，打开的页面就会和原来的页面一样），如图7-3所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303542495-f47a785a-7c27-424f-89e4-811110663f6b.jpeg)

图7-3　通过Plotly生成的新页面

至此，我们成功地把脱离plotly.js后的div嵌入到Django中，这种嵌入方式所嵌入的 div内容比较小且逻辑清晰，比较贴近实际，因此后续讲解的案例都会以这种方式为主。

### 7.1.5　更多案例扩展

上面的案例虽然看起来简单，却解决了Plotly与Django交互时最大的难题，成功地把Plotly嵌入到Django中。这里建立了Plotly嵌入到Django中的简单框架，从Plotly的角度来说，如果想要把更多的Plotly绘图嵌入到Django中，则需要修改Plotly对应的代码；从Django的角度来说，如果想要在网页中呈现更多的内容，则需要调整网页的结构，这就需要对Django对应的代码进行调整。本节内容重点讨论前者，下一节会进一步讨论后者。

从前面的内容可以看出，Plotly部分的代码主要放在visual_plotly/views.py文件中，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303543037-521dd45e-4955-4d15-8af8-eda6d5477484.jpeg)

上面的代码我们非常熟悉，基本上与本书之前讲解的Plotly绘图部分的内容相同。在这些代码中，最关键的部分是下面几行代码：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303543682-aa086790-1ba7-4ed5-a9cc-50b933e1f004.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303544080-37ca0747-95ea-4a3a-98b9-35d1e5fabf31.jpeg)

这几行代码实现的功能是把Plotly的离线绘图结果存储到一个 div参数（pyplt返回的结果）里面，这个变量的内容是调用plotly.js进行绘图，我们把它放在context字典里，传递给Django的index.html模板，最后在index.html模板中显示这个绘图结果。

与之前Plotly的绘图函数不同的是，我们这里把结果以.js的形式存储到一个变量div里面（output_type='div'的作用），并设置默认不在网页中打开（auto_open=False的作用），同时输出结果中不包含plotly.js（include_plotlyjs=False的作用）。

从上面的代码中可以看出，我们完全可以修改上面的绘图代码，换成本书前面章节所讲过的绘图代码和自己喜欢的Plotly绘图代码，从而把更多的Plotly嵌入到Django中。这些事情对读者来说并不是太难，读者可以自行完成。

### 7.1.6　应用案例一

接下来要做的事情就是在网页上呈现更多的信息，最简单的应用案例是在index.html模板中添加一些信息，组成一个简单的网页。本案例用一个简单的网页实现对房价的绘图分析，这个案例相对于前面的案例主要修改的是 index.html文件，其代码（见文件plotly_django_app1/templates/index.html）如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303544550-609cc1a5-75d4-4bce-a010-b2c6bf6db888.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303544919-ed387bfa-6a01-4134-a0b5-bb7baebe7846.jpeg)

运行python manage.py runserver，在浏览器的地址栏中输入http://127.0.0.1:8000，结果如图7-4所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303545246-f6a56717-4659-44f2-bc23-03516b79dcc3.jpeg)

图7-4　应用案例一的绘图结果

这只是一个简单的应用案例，这个案例虽然简单，但是对于复杂的案例，这种方法同样适用。接下来为读者介绍一个相对综合的案例。

### 7.1.7　应用案例二

在实际生产环境中，我们所涉及的模板 templates/index.html与静态文件static/plotly.min.js是很复杂的，并且也不止一个，但是Django调用模板的原理是一样的，不会因为其复杂而改变调用它们的方法，因此在真实的生产环境中，Plotly嵌入到Django中的方法与之前的方法相比没有什么不同。

由于真实的Plotly商业案例特别复杂、难以理解，并且涉及商业机密，因此不适合作为新手的入门案例，本书选择了相对简单的应用案例。幸运的是，笔者在网上找到了一些适合Plotly实战应用的HTML模板，这些模板完全可以满足我们实际的需求，因此拿来做案例再好不过。Web开发并不是本书的重点，本书重点内容是Plotly在Web开发中的应用，因此本节只介绍Plotly嵌入Web的相关内容。

本案例见文件plotly_django_app2，主要目录结构如下（删掉部分是不重要的文件结构）：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303545645-220b7f6f-0035-4d5d-b63b-c128e0645aa5.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303546062-b343c535-7105-4784-ab7f-2f1e66d1d844.jpeg)

本案例的文档结构看上去复杂，其实在实际调用中与之前的案例方法是一样的，与之前的案例内容相比，无非是urls.py、view.py内容多了一些，并且template模板的HTML代码多了一些而已，下面重点介绍其中的变化。

（1）在plotly_django/urls.py文件中，将每个URL作为一个请求传递给views.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303546629-eb155524-bab6-4041-b403-b87da9d57575.jpeg)

其中，需要注意的是最后一个URL：

url(r'', views.start), # 除上面的规则外，其他规则都会指向views.start

这个 URL表示除上面的规则外，其他规则都会指向 views.start。views.start是一个页面跳转的代码，不是直接返回某个HTML模板，这一点会在随后的views.py文件中说明。

（2）在plotly_django_app2/view.py文件中，针对每个请求，返回相应的HTML模板或跳转到指定的URL，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303546881-33b909e8-b1b5-45c9-9f14-d36a8be3d927.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303547112-4698fec0-9119-4860-914e-f0651fab3061.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303547382-92553f56-f78c-489f-bcdf-48e83582e6f9.jpeg)

这里需要注意以下3点。

① ChartPlot是 plotly_django_app2/chart_plot.py文件中的类，类中的每个函数都是Plotly的一个绘图函数，其返回值是一个去掉plotly.js的div参数。

② start函数返回的redirect是一个页面跳转的函数，表示如果触发该请求，则把它跳转到index.html页面。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303547653-6689c3ea-cb90-49ff-9709-42ba170787d7.jpeg)

③ 我们只对charts.html与index.html这两个模板文件的绘图代码进行修改，稍后可以检测这两个图修改后的效果。

（3）按照之前的方式修改templates/index.html与templates/charts.html文件，传递div参数。以index.html为例，主要的工作是在原来的模板上添加如下代码。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303547894-4666a12f-50d3-4ef3-8159-8deb8f4030ef.jpeg)

{% endif %}

这种方法和之前学习的内容没有什么区别。

运行下面的代码，8001表示端口号为 8001（默认为 8000，注意与之前的端口号不同）。

python manage.py runserver 8001

打开网页http://127.0.0.1:8001/index.html，会看到如图7-5所示的页面。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303548152-0d5a7a49-12b1-41e5-ae06-d0c97143a4bd.jpeg)

图7-5　index.html页面

图7-5中第一个时间序列的图就是Plotly的绘图效果。

打开网页http://localhost:8001/charts.html，运行效果如图7-6和图7-7所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303548389-f971c290-2514-4b6e-9dc0-a819551b70ed.jpeg)

图7-6　charts.html页面1

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303548810-c02efadc-8155-424e-88ca-fefc33883a2e.jpeg)

图7-7　charts.html页面2

由于其他页面的效果与 Plotly没有太大的关系，因此读者可以通过如图7-8所示的方式自行研究。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303549128-c8bda7aa-b69b-4988-bdb7-5b2b8bc32fde.jpeg)

图7-8　查看其他页面

至此，Plotly嵌入到Django中的案例就介绍完了。本章的重点是提供解决实际应用问题的关键案例，基本上可以满足我们在Web开发中的业务需求，对于实际使用中的其他细节（如模板设计、权限管理、连接数据库等），需要读者在实际应用中进一步探索，希望本节内容对读者有所帮助。

## 7.2　Plotly在Flask中的应用

本节介绍Plotly在Flask微服务框架中的应用。Flask是一个非常优秀的Web应用框架，有着众多的拥护者，它文档齐全、社区活跃度高、功能强大。本节的内容建立在官方文档（http://docs.jinkan.org/docs/flask/quickstart.html）的基础上，再加上Plotly开发，从框架的建立开始，由浅入深地讲解Flask加载Plotly离线文件。

Flask是一个使用Python语言编写的免费的轻量级Web应用框架，其WSGI工具箱采用 Werkzeug，模板引擎则使用 Jinja2，如图7-9所示。Flask也被称为“microframework”，因为它使用简单的核心，用extension增加其他功能。Flask没有默认使用的数据库、窗体验证工具。

Flask处理一个请求的流程是：首先根据URL决定由哪个函数来处理，然后在函数中进行操作，取得所需的数据，再将数据传给相应的模板文件，由Jinja2负责渲染得到HTTP响应内容，最后由Flask返回响应内容。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303549452-7c3c9d40-9a04-49e1-8bfa-94d850679b75.jpeg)

图7-9　Flask示意图

Flask底层使用 werkzeug来做路由分发，在实际应用中，不同的请求可能会调用相同的处理逻辑。有着相同业务处理逻辑的HTTP请求可以用同一类URL来标识，比如在论坛站点中，对于所有获取Topic内容的请求而言，可以用“topic/&lt;topic_id&gt;/”这类URL来表示，这里的topic_id用以区分不同的topic，接着在后台定义一个get_topic（topic_id）函数，用来获取topic相应的数据，此外还需要建立URL和函数之间的一一对应关系，这就是Web开发中所谓的路由分发，如图7-10所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303549800-de7b27fa-8c2a-4636-a908-84e672f92723.jpeg)

图7-10　Web开发中的路由分发

Flask使用Jinja2模板渲染引擎来做模板渲染，通过业务逻辑函数得到数据后，接下来需要根据这些数据生成HTTP响应（对于Web应用来说，HTTP响应一般是一个HTML文件）。Web开发中的一般做法是提供一个HTML模板文件，然后将数据传入模板，经过渲染后得到最终需要的HTML响应文件。

一种比较常见的场景是，请求虽然不同，但响应中数据的展示方式是相同的。仍以论坛为例，对于不同的主题而言，其具体主题内容虽然不同，但页面展示的方式是一样的，都有标题栏、内容栏等。也就是说，对于主题来说，我们只需提供一个HTML模板，然后传入不同的主题数据，即可得到不同的HTTP响应，这就是所谓的模板渲染，如图7-11所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303550426-091bf3b1-ddb1-429e-9c68-7229fd191276.jpeg)

图7-11　模板渲染

### 7.2.1　安装Flask

安装Flask的方法特别简单，直接用pip命令安装即可：

pip install flask

### 7.2.2　最小的Web应用

新建项目目录plotly_and_flask_demo1，在该目录下新建一个hello.py文件，具体代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303550997-a46fd061-70d2-4093-9f80-b048e8418962.jpeg)

然后运行以下hello.py脚本，访问http://127.0.0.1:5000/，就会看见Hello World问候语，如图7-12所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303551463-dd6dcff8-8cc9-4b1e-8b2d-a172274bda27.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303552009-351c2f0c-e2e0-4c90-85e8-2548ca3eb1f0.jpeg)

图7-12　显示Hello World问候语

在本例中，使用route()装饰器告诉Flask什么样的URL能触发我们的函数。这个函数的名称也在生成URL时被特定的函数采用，这个函数返回想要显示在用户浏览器中的信息。

最后用run()函数让应用运行在本地服务器上，其中“if __name__== '__main__'”确保服务器只会在该脚本被Python解释器直接执行时运行，而不是作为模块导入时运行。

### 7.2.3　模板渲染

现在的网站很少有全静态页面了，而动态页面靠的就是模板的渲染。Flask默认的模板引擎是Jinja2，它有一套自己的模板语言。

在plotly_and_flask_demo1目录下新建文件夹templates，在该文件夹中保存模板文件。建立一个简单的模板文件index.html，这个模板文件应该放在主脚本的同目录下的templates目录中，具体代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303552576-6ade3812-1722-47f5-aa82-bec34b71d180.jpeg)

在plotly_and_flask_demo1目录下新建主文件并命名为template.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303553090-c3c86a89-f3d2-48ad-b0b5-ea03cb47827b.jpeg)

从上面这段代码中我们可以看出以下几点。

（1）路由可以不是固定的，用<变量名>的形式可以制作动态路由。

（2）函数的第一个参数只写了模板的文件名而不是模板的路径，这就是把模板放在固定的templates目录下的意思。

Flask会在 templates目录里寻找模板。所以，如果用户的应用是一个模块，则这个文件夹应该与模块同级；如果它是一个包，则这个文件夹作为包的子目录。本案例中的脚本结构如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303553478-94d00121-97fd-417a-b200-1a164d22e7bb.jpeg)

/index.html

（3）一个响应函数可以关联多个路由，使这几个路由都定向到这个函数。

在命令行窗口运行template.py脚本，代码如下。

python template.py

然后打开浏览器，在地址栏中输入 http://127.0.0.1:5000/hello，就可以看到网页渲染的模板文件了，如图7-13所示。

如果请求的URL带参数，则会得到不同的结果，比如访问http://127.0.0.1:5000/hello/wangwu，会得到如图7-14所示的结果。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303553734-17e55f40-f5f0-4ca2-9b61-78300e460cb8.jpeg)

图7-13　网页渲染的模板文件

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303554064-0f4d715f-72d0-425d-a70c-8d6a2aa54b77.jpeg)

图7-14　URL带参数的模板文件

### 7.2.4　入门案例一

前面介绍了 Flask的模板渲染，其实很简单，就是在网页中替换特定的变量。本节将讲解在Flask框架中使用模板渲染图形，将Plotly生成的渲染后的内容以div方式嵌入到HTML文档中，其实就是在网页中插入一段包含HTML的网页，具体步骤如下。

（1）在plotly_and_flask_demo1项目目录下新建主脚本 template2.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303554596-7ddee814-5676-4469-aa26-f93a60a4ecc2.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303555072-f05d81db-dcb9-475b-a0cd-6eae077cb9f8.jpeg)

以上代码非常简单，就是使用 Plotly离线生成渲染的内容，然后保存在字典context中，最后使用render_template()函数渲染网页。

（2）建立模板文件index2.html，保存在templates目录下，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303555537-29d173aa-e663-47f6-b021-48c5032a9e2c.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303556078-8f649f69-1c12-444a-ba42-010de478e8ef.jpeg)

注意，为了让 HTML正常解析这些标签，需要对 HTML进行转义，添加 safe参数即可，代码如下。

<h1> {{context.graph |safe }} </h1>

当前项目的目录结构如下：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303556324-82979569-f123-4425-803c-ee21f370e09a.jpeg)

（3）启动本地测试服务器。

在命令行窗口运行template2.py脚本，代码如下。

python template2.py

然后打开浏览器，在地址栏中输入 http://127.0.0.1:5000，网页中就会插入一段Plotly生成的离线渲染内容，如图7-15所示。

### 7.2.5　入门案例二

前面介绍了简单的入门案例，但是这个案例有一个缺点，与“7.1.3入门案例一”遇到的问题一样，就是传入的div参数有点大，约有2MB。如果一个网页中只有一两个这种绘图，用这个案例的方法是可以接受的，但是如果有多个绘图，就会导致页面数据量太大而给服务器造成很大的压力，下面来看一下出现这个问题的原因。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303556678-33824bbb-8161-49b1-83db-06bf0ee132e9.jpeg)

图7-15　网页中插入的Plotly生成的离线渲染内容

注意

这个问题的解决方案与“7.1.4 入门案例二”中所使用的方法一样，考虑到有些读者只对Flask 熟悉而对Django 不熟悉，为了照顾这部分读者，在本节中，这个问题的解决方法会与前面的部分内容重复。

首先分析一下我们传递的div参数是什么。打开template2.py文档并运行，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303557201-3dae6e68-ca55-4d67-b387-329d6930090e.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303557736-b684d19a-f01e-45ac-885d-263d27cb8447.jpeg)

输出结果如下：

参数div占用内存大小为 2343823 bytes

这个div参数非常大，约2MB，它本质上是plotly.js与调用plotly.js的绘图代码的结合体，我们打开div1.txt就可以看到这个文件前面的内容是plotly.js源文件，后面的几行内容才是绘图的代码。我们实际需要的是后面的代码，对于前面的plotly.js，只要在HTML中引用一次就行，没必要每次绘图都重新引用。

打开div1.txt，会看到如图7-16所示的内容。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303558320-410c52e6-8857-4d3b-bc02-39d0101c0324.jpeg)

图7-16　divl.txt的内容

图7-16中下面的阴影部分才是Plotly真正的代码，实际上，我们只要在HTML中引用这段代码就行了，plotly.js可以通过其他方式导入。

下面来看一下如何将剥离 plotly.js后的 div嵌入到 Flask中。这个案例建立在“7.2.4入门案例一”的基础上，只需要进行一些改动就行了，步骤如下。

（1）修改template2.py文件，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303558831-b6441d13-d490-4dfa-92c5-5f4f6a6dfd0f.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303559462-c93f5cf8-46e7-4576-9f8d-cbed6587c52e.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303559967-6718c188-41f1-49cd-8b4a-34e812f2afc7.jpeg)

以上代码实现的功能是把Plotly的离线绘图结果存储到一个div参数（pyplt返回的结果）里面，这个变量的内容是调用plotly.js进行绘图，我们把它放在context字典里，传递给Flask的index2.html模板，最后在index2.html模板中显示这个绘图结果。修改的核心代码如下：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303560387-a9b665f9-5084-4da6-8fa7-dfdac118db9d.jpeg)

与之前Plotly的绘图函数不同的是，我们这里把结果以.js的形式存储到一个变量div里面（output_type='div'的作用），并设置默认不在网页中打开（auto_open=False的作用），同时输出结果中不包含 plotly.js（include_plotlyjs=False的作用）。最后一项include_plotlyjs=False是最重要的修改，只有添加了这一项后，我们渲染的Plotlyjs图形才不包括plotly.js文件。如果没有include_plotlyjs=False这一项, Plotly渲染的图形默认是包括plotly.js的，如图7-17所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303560965-b48a0e7f-1d6e-4c0b-8886-b8b11b365167.jpeg)

图7-17　修改函数代码

（2）修改templates/index2.html文件，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303561388-243e9d1e-ebfc-416a-87bc-9ec58d50267f.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303561886-ec6a0831-2f72-47d6-bc49-6ad48150a313.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303562429-60b8c40d-9c1e-420a-9fe0-9fceee711877.jpeg)

与之前的index2.html文件相比，添加了如下内容：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303562973-ff7b8f83-dade-4c5f-8051-b5a6df770838.jpeg)

我们使用url_for()函数静态加载/static/js目录下的plotly.min.js文件。使用Flask框架只写一行代码就可以使页面动态加载JavaScript，非常方便，从这一点可以看出Flask框架代码的简单和功能强大，Flask的设计也很人性化，不愧为Web开发的“神器”，读者可以将其作为Web入门级框架来学习，有兴趣的读者可以深入研究Flask框架。

（3）复制plotly.min.js文件。

在plotly_flask_demo1目录下新建文件夹static，在static目录下新建js目录，复制plotly.min.js文件（笔者的Python环境目录为：d:\Anaconda3\Lib\site-packages\plotly\package_data\plotly.min.js）到js目录。项目目录结构如下：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303563460-b7fbe1cf-d1b6-4a4c-b8a8-fa0c84425c36.jpeg)

（4）启动本地测试服务器，代码如下。

python template2.py

打开浏览器，在地址栏中输入 http://127.0.0.1:5000，显示的效果和“入门案例一”的效果是一样的，但是后台输出的结果是：

参数div占用内存大小为 804 bytes

传入的div参数只有804字节，大大减轻了服务器加载页面的压力，达到了优化页面的目的，使用这种方式不管我们加载多少个 Plotly图形，最后在模板页面中加载的都是Plotly实际渲染的HTML图形。

### 7.2.6　应用案例

为了便于读者入门，本节介绍相对简单一些的应用案例。与 Plotly 在 Django中的应用一样，笔者在网上找到了一些适合 Plotly实战应用的 HTML模板。由于Web开发并不是本章的重点，本章的重点内容是Plotly在Web开发中的应用，因此本节只介绍Plotly嵌入Web的相关内容。

我们接下来要做的事情就是在网页上呈现更多的图形信息。新建工程目录并命名为 plotly_flask_demo2，在该目录下新建展示的图形页面，在这里新建两个页面bar.html和charts.html，其他页面还使用原来的模板页面，其他页面不是本节介绍的重点，请读者自行查阅。

在bar.html页面添加一个柱状图图形。

在charts.html页面添加四个图形（曲线图、柱状图、条形图和饼图）。

plotly_flask_demo2的项目结构如下：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303564046-456e8b16-ef8a-4326-989f-5c182c7a412d.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303564553-671fe275-23ad-4970-97c7-629d1319d96a.jpeg)

这个案例的文档结构虽然看上去复杂，但在实际调用中与之前的案例方法是一样的。与之前的内容相比，只是增加了static目录，并且模板的HTML代码多了一些。各个目录的作用如下。

● /static/css：存放工程需要的页面样式文件。

● /static/font：存放工程需要的页面字体文件。

● /static/img：存放工程需要的图片文件。

● /static/js：存放工程需要加载的 plotly.js文件。

● /templates：存放工程需要的模板文件。

● chart_plot.py：封装Plotly渲染图形的逻辑。

● plotly_flask.py：是Flask Web框架的骨架，保存页面的映射路径。

chart_plot.py 封装了 Plotly渲染图形的业务逻辑，主要有四个图形（曲线图、柱状图、条形图和饼图），以其中的饼图为例，其代码样例如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303565055-db0ec9f0-c26c-4091-a6c5-bda7e38307c4.jpeg)

plotly_flask.py针对每个请求，返回相应的HTML模板或跳转到指定的URL，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303566131-cbd342c3-fc0b-4e7e-afda-0dd50e7c3acc.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303566562-d6f47d0b-3f07-4ad8-9fe7-cbcf4be147c4.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303567319-e2648eaa-1176-475e-8fc3-dc1e1e1c3f63.jpeg)

/templates/chars.html是整个案例最复杂的一个模板页面，这个模板页面中包含四个Plotly图形。加载模板文件用到的样式文件和plotly.js文件的核心代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303567784-10397289-eef3-41c3-9702-49eee9a93bac.jpeg)

/templates/chars.html模板页面导航栏的核心代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303568251-2fb580a2-e519-4fe5-a5bc-b38cca8d37a0.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303569209-7de0f0b5-7e36-4be0-98e5-2f47a4678950.jpeg)

/templates/chars.html模板页面保存Plotly图形的核心代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303569793-b4a752ee-463b-493e-b260-313d0e58864c.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303570286-b3fd407d-e063-4dd1-823a-d823ef435e6d.jpeg)

启动本地测试服务器，代码如下。

python plotly_flask.py

打开浏览器，在地址栏中输入 http://127.0.0.1:5000，显示的效果如图7-18～图7-21所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303570862-3875a97d-3aa0-4bf5-b0d8-890fd866653b.jpeg)

图7-18　显示效果1

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303571327-34fcd2c6-be17-4d21-aa8a-39e31e176c18.jpeg)

图7-19　显示效果2

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303571835-6925b911-e369-45a1-a0f3-84605a959207.jpeg)

图7-20　显示效果3

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303572543-7b36ed3b-5e8f-4684-926b-52eb5ff72263.jpeg)

图7-21　显示效果4

至此，Plotly嵌入到Flask的案例就介绍完了，从这个应用案例可以看出，Flask不愧是一个轻量级的Web开发框架，用到Flask的整个开发文档只有plotly_flask.py，相比Django确实非常精简。本节只提供了Plotly嵌入到Flask的基本样例，只起到抛砖引玉的作用，对于实际过程中的实战应用还需要读者结合本节的案例不断摸索。

# 第8章　Plotly与GUI开发

Plotly本质上是基于JavaScript的图表库，因此Plotly在网页开发方面非常有效。如果想要让Plotly嵌入到GUI上，那么GUI开发框架必须要支持JavaScript，即一定要有Web模块。另外，由于plotly.js框架比较新，因此也要求GUI开发框架相应的Web模块更新速度能够跟得上。最后，从开发者的角度来说，我们希望GUI的开发框架使用起来足够简单且好用。

首先，我们需要对Python的GUI框架有一个基本的了解。从Python语言诞生之日起，就有许多优秀的GUI框架被整合到Python中，使得Python也可以在图形界面编程领域大展身手。随着 Python的流行，许多应用程序都是用 Python结合这些优秀的GUI框架编写的。下面分别介绍Python GUI编程的各种实现（内容来自维基百科）。

1.Tkinter

Tkinter是绑定了Python的Tk GUI框架，就是Python包装的Tcl代码，通过内嵌在Python解释器内部的Tcl解释器实现。将Tkinter的调用转换成Tcl命令，然后交给Tcl解释器进行解释，实现Python的GUI。Tk和其他语言的绑定，比如PerlTk，是直接由Tk中的C库实现的。

Tkinter是Python事实上的标准GUI，在Python中使用Tk GUI框架的标准接口，已经包含在Python Windows安装程序中，著名的IDLE就是使用Tkinter实现GUI的。

2.wxPython

wxPython是Python对跨平台的GUI框架wxWidgets（用C++编写）的包装，作为Python的一个扩展模块来实现。

wxPython是比较流行的Tkinter的一个替代品，在各种平台上都表现良好。

3.PyGTK

PyGTK是Python对GTK+GUI库的一系列包装。

PyGTK是比较流行的 Tkinter的一个替代品，GNOME下许多著名应用程序的GUI都是使用PyGTK实现的，比如BitTorrent、GIMP、PyGTK和Gedit都是实现的方式之一。PyGTK在Windows平台上似乎表现不太好，这一点也无可厚非，毕竟使用的是GTK的GUI库。

4.PySide

PySide由Qt官方维护，目前最新版本是1.2.2，完成了对Qt 4.8版本的完整实现。PySide是Python对跨平台的GUI框架Qt的另一个包装，捆绑在Python中。

PySide是比较流行的Tkinter的一个替代品，拥有LGPL 2.1授权许可，允许进行免费的开源软件和私有的商业软件的开发。

在上面的所有图像开发库中，前三个由于没有Qt Designer（一个UI制作工具，它可以通过可视化操作创建UI文件，然后通过工具快速编译成.py文件，因此也可以把它视为一个代码生成器），因此所有的代码都需要手工输入，学习曲线非常的陡峭；而第四个PySide本质上也是Qt的Python封装，只是支持的Qt版本比较旧，最新版才支持到Qt 4.8，而且官方已经停止维护这个库，最近一次更新在2015年10月14日。所以，对于Python使用者来说，使用PyQt进行GUI开发是最好的选择。

另外，从Plotly的角度来看，PyQt可以使用其中的QWebEngineView类进行网页开发，并且QwebEngineView类使用的是Chromium内核，Chromium内核是Chrome浏览器使用的内核，利用Chrome浏览器的优势可以完美解决其与plotly.js兼容的问题。

综上所述，本章将PyQt与Plotly结合，详细说明如何把Plotly嵌入到PyQt里面，但是不会对PyQt的基础做过多的介绍，因为这并不是本书的重点，仅仅是PyQt的基本使用就足够写一本书了。

在阅读本章之前，读者需要对PyQt的基础知识有一些基本的了解。如果对PyQt不太感兴趣，也可以略过本章的内容。

## 8.1　PyQt的安装

由于QWebEngineView类目前只支持PyQt 5的PyQt 5.7（包含5.7）以上版本，所以本章的内容使用PyQt 5的最新版即可。PyQt 5的安装方法很简单，安装命令如下。

pip install PyQt5 -i https://pypi.tuna.tsinghua.edu.cn/simple

虽然 PyQt 5的安装比较简单，但是其依赖的一些工具文件如 qtdesigner.exe、uic.exe等却需要以其他的方式安装，这里推荐使用 Python的集成开发环境WinPython（网址是https://sourceforge.net/projects/winpython/files/，建议选择下载量最大的那个安装包进行下载），里面已经集成了PyQt 5所需的所有依赖文件。

注意1

本章的内容建立在读者已经具备了PyQt 的一些基本知识的基础上，包括能看懂PyQt 5 最基本的代码，并知道如何运行PyQt 5 的文件；Qt Designer 的基本使用；把.ui 文件编译成.py 文件等。

如果读者不知道这些知识，也可以试着把本章的程序运行一遍，说不定会有意外的收获。

注意2

本章要求PyQt 5.7 版本，但是在Windows 7 下这个版本会导致Spyder 运行不正常（运行Spyder 后会出现一个黑色的界面），而在Windows 8 和Windows 10 系统中则没有这个问题，因此另一个非常好用的集成开发环境Anaconda 默认使用的PyQt 依然是5.6。如果读者使用的是Windows 7 系统，建议使用WinPython 这种便携的开发环境，而不建议升级Anaconda 的PyQt 版本，因为那样会导致系统的Spyder 不能用。

## 8.2　案例解读

在打算把Plotly嵌入到GUI开发中之前，笔者一直想要在Plotly官网中找到相关的线索，遗憾的是，在Plotly的帮助文档中并没有找到与PyQt结合使用的具体方法。经过笔者的实践，发现可以通过PyQt的QWebEngineView类封装Plotly所生成的绘图结果，从而实现Plotly与PyQt的交互。

这里使用了QWebEngineView类，这个类从PyQt 5.7版本才开始引入。引入这个类的最主要原因是PyQt 5.6及以前版本中使用的是QWebView类，QWebView类使用的是自己开发维护的WebKit内核，这个内核比较陈旧，对JavaScript的一些新生事物（如Plotly）的支持性不好。而QWebEngineView类使用的是Chromium内核，利用Chrome浏览器的优势可以完美解决其兼容性问题。但是QWebEngineView类有一个比较大的缺点，就是启动速度比较慢，相信在日后的发展中，PyQt团队会慢慢解决这个问题。

需要提醒读者的是，本案例使用的是PyQt 5.7及以上版本，本书8.6节会讲解使用PyQt 5.6及以前版本与Plotly进行间接交互的方法，不过其支持的图表会有限制。

QWebEngineView类与 Plotly交互非常简单，本案例文件名为 demo_plotly_pyqt.py，详细代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303572935-f3598c99-dcea-4457-9339-e2dcbad26c15.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303573456-0c4a6a3f-2a66-44fb-baef-f86664719bdb.jpeg)

本案例的核心代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303573927-3ec98a47-65ad-4618-a7e3-bff43734487c.jpeg)

以上代码表示新建一个QWebEngineView类，以及在QWebEngineView类中载入文件。

请注意，if_hs300_bais.html是用Plotly生成的HTML本地文件，经过前面章节的学习，读者对利用Plotly生成这种文件应该比较熟悉了。我们先看一下程序运行结果，如图8-1所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303574544-ba23724c-07c3-4ed5-83fb-87f418e7c6c2.jpeg)

图8-1　程序运行结果

可以看到，这个图非常漂亮，可以动态显示当前时间的价格。在Plotly的绘图结果上也可以找到一些其他方法，依次单击右上角的几个按钮就可以使用这些方法。此外，若想查看区间图，可以按住鼠标左键向右拖动，如图8-2所示。想要恢复成初始图，单击右上角的“autoscale”按钮即可。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303575110-b6fd9af5-02c7-4bac-97e5-67bddcab5125.jpeg)

图8-2　区间图

## 8.3　设置提升的窗口部件

本节内容属于PyQt中Qt Designer的一个高级功能，阅读本节内容需要读者已掌握Qt Designer的基本用法，如果读者对阅读这节内容感到吃力或对这节内容不感兴趣，也可以略过。之所以要介绍这节内容，是因为这节内容是使用Qt Designer把Plotly嵌入到PyQt中的关键。

所谓提升的窗口部件，是指有些窗口部件是用户自己基于PyQt定义的复合窗口部件，这些窗口部件在Qt Designer中没有直接提供，但是可以通过提升的窗口部件这个功能来实现，具体方法如下。

从Container导航栏中找到QWidget并拖入主窗口中，然后对其右击，从弹出的快捷菜单中选择“promote to（提升）”，打开“Promoted Widgets（提升的窗口部件）-Qt Designer”对话框，如图8-3所示，按照图中所示进行输入。

单击“Add（添加）”按钮，会发现“Promoted Classes（提升的类）”框中多了一项，如图8-4所示。

选中多出来的这一项，然后单击“Promote（提升）”按钮，会在对象查看器中看到如图8-5所示的内容，说明已经成功地在Qt Designer中引入了QWebEngineView类。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303575614-50cbd8ea-b594-4af1-b351-f52cdf616734.jpeg)

图8-3　“Promoted Widgets-Qt Designer”对话框

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303576166-accfed86-2545-4ced-9a9c-30378a23910f.jpeg)

图8-4　单击“Add”按钮后的“Promoted Widgets-Qt Designer”对话框

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303576618-57cde664-71bd-49b2-bcf9-0defeae2bab2.jpeg)

图8-5　对象查看器

将widget重命名为“qwebengine”，这样就基本完成了对提升的窗口部件的操作，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303577188-4ed509ad-be76-4668-b633-45c606f41902.jpeg)

至此，已经实现了QWebEngineView类在Qt Designer中的引用。

提升的窗口部件是PyQt中非常简单、实用而又强大的功能，利用该功能并通过Qt Designer可以实现PyQt与Python的一些强大的模块之间的交互，可以充分利用PyQt和Python的优点快速开发程序。

## 8.4　Plotly_PyQt 5的使用

通过学习前面的案例已知QWebEngineView类只需接受Plotly生成的HTML文件路径就可以实现PyQt 5与Plotly的交互，因此本案例的主要作用就是通过Plotly生成HTML本地文件，并返回该HTML文件路径（见文件Plotly_PyQt5.py），代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303577665-7255be08-a4c3-41f9-ae32-e70a05200ef7.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303578193-83389a0b-da28-4674-b84f-808a2b11c0d2.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303578697-d1e65233-c874-4ebc-97c0-7408bd66556f.jpeg)

对于本案例，需要注意以下几点。

（1）文件绘图使用的是离线模式，而不是在线模式，代码如下。因为离线模式的绘图速度非常快，在线模式绘图由于服务器的原因会比较慢。

import plotly.offline as pyof

（2）禁止自动在浏览器中打开，需要设置auto_open参数为False，代码如下。

pyof.plot(fig, filename=path_plotly, auto_open=False)

（3）绘图完成后在本地保存绘图结果，然后在函数里面返回这个路径，最后让QWebEngineView类调用这个路径就实现了PyQt与Plotly的交互，代码如下。

return path_plotly

对于pyqt的主程序，代码如下（见文件plotly_pyqt.py）。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303579168-87a18776-7255-4577-a92b-99cbc63d1719.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303579794-7d21a672-5878-42d7-913d-d449e21b8c7d.jpeg)

其核心代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303580258-3e734eba-ea6e-4833-8200-886dc2fc83bf.jpeg)

这几行代码的作用类似于前面提到的以下代码：

self.qwebengine.load(QUrl.fromLocalFile('\if_hs300_bais.html'))

运行结果如图8-6所示，与图8-1所示的结果没什么不同。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303580826-a1aa6b5c-a049-409a-9b9a-1ca91ea4d9bb.jpeg)

图8-6　程序运行结果

注意

我们这里使用很笨的方法，首先在Plotly 中绘图，把结果保存到本地，然后通过QWebEngineView 类加载这个本地文件，这样就产生了硬盘的写入与读取问题，显然有些拖累程序的运行速度。

针对这个问题，笔者也曾经尝试直接通过QWebEngineView 类来渲染Plotly生成的JS 代码（见文件PyQt_plotly_js.py），但遗憾的是没有成功，原因是QWebEngineView 类对于太大的JS 代码不能很好地支持，这个属于PyQt5 的bug，希望日后这个问题能够完美地解决。所以，本章提供的解决方案虽然不是最完美的方案，但却是目前笔者知道的最好的方案。

## 8.5　更多扩展（Plotly）

读者如果需要了解更多的案例，可以查阅本书的章节内容，也可以访问官方网站https://plot.ly/python/，如图8-7所示。

读者需要做的仅仅是对相关案例的代码进行修改，并修改 get_plotly_path_if_hs300_bais函数，使之支持要实现的绘图结果，就是这么简单！

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303581321-4c205d43-294c-4e6a-9ba4-b54a2bd01a25.jpeg)

图8-7　官网案例

## 8.6　Plotly与PyQt 5.6的结合

由于Plotly所采用的JavaScript框架比较新，所以PyQt 5.6及以前版本对它的支持性不是很好。笔者经过不断摸索，找到了一种QWebView支持Plotly的间接方案——先用 Matplotlib进行绘图，然后用 Plotly渲染结果，最后将其与 QWebView进行结合。在所有的公开信息中，本书应该是第一个给出这种解决方案的，在这之前还没有见到能够实现PyQt 5.6及之前版本与Plotly进行交互的案例。

既然这种方案可以解决PyQt与Plotly进行交互的问题，那么为什么不采用这种方案呢？原因有以下三点。

（1）这种方案严重依赖Matplotlib的图表库，如果有些图表在Matplotlib中无法实现，那么 Plotly也就无法对其进行渲染了。也就是说，对于一些 Plotly拥有而Matplotlib中却没有的图表，该方案无能为力。

（2）这种方案所渲染的Plotly图表与Plotly的原生图表在外观上有一些不同，Plotly的原生图表相对好看一些。

（3）有些自定义的 Matplotlib图表无法通过 Plotly进行渲染，笔者曾经对双坐标轴的Matplotlib图表进行Plotly渲染，但是无论如何都没有结果。可见，使用Plotly渲染Matplotlib图表的兼容性还有待提高。

接下来要说明如何使用QWebView与Plotly进行交互，幸运的是，Qt Designer默认为我们提供了QWebView类，所以在此就不用设置提升的窗口部件了。使用方法是：在Qt Designer界面左侧的“Display Widgets”导航栏中选中QWebView并拖动到主窗口中，结果如图8-8所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303581895-66618984-48e7-4b21-83cd-ca93a79f2600.jpeg)

图8-8　选中QWebView并拖到主窗口中

下面给出案例。注意，这个案例需要在PyQt 5.6及之前版本中运行，需要读者自行配置相应的PyQt环境（见文件plotly_matplotlib_pyqt.py），代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303582580-dbfedeae-3f26-4faf-bc16-2b0a8776dfac.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303583118-a933a1e1-1ae1-41d5-baf7-7acbcad539f4.jpeg)

其核心代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303583975-9318cea9-c9ac-43fa-851a-12cfa3553047.jpeg)

在这里，QWebView的使用方法和前面介绍的QWebEngineView的使用方法一致，把最重要的结果封装到Plotly_PyQt5类的get_plot_path_matplotlib_plotly函数中。下面看一下这个函数的使用方法，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303584978-ad12acc9-3935-4b7c-affe-f70822590635.jpeg)

读者需要注意如下几点。

（1）这个案例使用的是plot_mpl函数，而不是plot函数。plot_mpl函数的作用是把Matplotlib形式的绘图结果转换成Plotly形式的绘图结果。

（2）所传递的第一个参数是Matplotlib图表，而不是Plotly生成的图表。

（3）resize=True，表示允许Plotly重新定义图表的大小，默认为False。从图8-9可以看出，绘图结果的尺寸发生了变化。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303586091-1421f8cb-6925-4bdb-8862-358be5a2036e.jpeg)

图8-9　绘图结果

可见，我们实现了 Plotly对 Matplotlib图表的渲染并且修改了原有图表的大小（默认的Matplotlib图表不会有这么大的宽度）。

## 8.7　更多扩展（Matplotlib）

读者可以从官方网站（http://matplotlib.org/gallery.html）获取Matplotlib的案例（如图8-10所示），并修改 get_plot_path_matplotlib_plotly函数来间接地实现 PyQt（QWebView）与Plotly的交互。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303586769-957b7f3e-d3d7-4e93-b5cb-eb2744b8b5e1.jpeg)

图8-10　官网案例

## 8.8　应用案例：展示产品组合信息

本节以金融行业的一个案例来介绍Plotly在PyQt中的应用。

机构可以从自己的产品信息数据库中筛选出一些优质标的（也就是基金产品），但是对于投资者来说，他们不像机构那么专业，并不能很准确地识别某一种基金产品的好坏，也没有那么多的时间和精力去市场上寻找适合自己投资的基金产品。一边是投资者想要找出适合自己投资的基金产品，另一边是投资者没有能力找出适合自己投资的基金产品，于是就产生了信息堵塞，其表现就是市场上的一些信息无法有效传递到投资者手中。而机构正好掌握了大量这种信息，具有信息优势，于是机构就可以利用这种信息优势给投资者提供服务，并从中收取服务费。

服务的方式很简单，对于投资者来说，他们其实并不知道适合自己的产品是什么类型的，但是可以预期自己的风险和收益。于是就产生了另一个问题：给定投资者的预期收益与风险的范围，为他们提供最优的投资方案。考虑到风险分散的原则，这个最优的投资计划最好是几种产品的组合。

我们先看一下案例结果，如图8-11所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303587217-a46482b6-56d1-4956-b0b8-7fe0a4995aac.jpeg)

图8-11　绘图结果

结果分为两部分，上面的部分是让用户选择预期收益、预期风险及偏好的策略类型，如图8-12所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303587658-64f2abff-846d-408b-82e6-67cb1412e244.jpeg)

图8-12　用户选择部分

下面的部分是从数据库中选取数据，并通过算法找出最优的产品组合及各自的权重，然后用图表展现出来。

提示

出于安全性考虑，这里只提供GUI 的实现逻辑，而不提供基金产品的数据库，也不提供找出最优产品组合的算法。

对于使用Qt Designer进行界面设计这部分内容，这里不再介绍，读者可以参考combination.ui文件自行研究。

本案例涉及的代码逻辑并不复杂，当用户输入预期收益和预期风险范围之后，单击“开始”按钮，就会触发唯一的信号槽机制。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303588184-55bcf63c-9fc7-49dc-834d-fca398c025b0.jpeg)

self.check_check_box()函数用来检测用户选中的策略是否符合要求，其内容如下，意思是在strategy_list中放入已经选中的checkBox的名称。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303588738-4e591779-7eca-4eb2-8d1c-6aa06f41d2a2.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303589327-de9a6bcd-70c4-4e81-89f1-e1fc3e2930bf.jpeg)

下面的内容对于有金融背景的读者来说，理解起来应该没有问题；若没有金融背景，不能理解，则可以略去这部分内容。

当所选择的产品分类数大于3和小于1时都不合适，会弹出警告框，并视为无效。原因是多个产品分类（大于 3）的组合由于产品之间的多重共线性，会导致分类的模型在数学上没有最优解，即使用计算机暴力算法找出最优解，其权重非零的个数一般也不超过3个。所以经过综合考虑，限制产品分类数为1～3是最合适的，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303589734-83b7762b-9e43-429d-88a2-3bd0f889edb5.jpeg)

接下来设置控件的大小和获取参数信息。由于这里并不准备把参数信息导入数据库中，所以只是简单地输出参数信息，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303590788-0755338c-643b-47dc-b5a8-3556f7de5d20.jpeg)

现在假设我们已经从数据库中找出组合最优的3种产品，分别为昆仑三十六号、时时安稳健1号和长城国瑞证券恒通23号，它们的组合权重分别为0.4、0.2和0.4，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303591132-20f04fa6-7ddb-4921-8917-b868d7580fdc.jpeg)

最后就是绘图了，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303591823-d4916467-7fa6-49ae-b9f1-e8a9c7a38592.jpeg)

上面的绘图函数 self.plotly_pyqt5.get_plotly_path_monte_markovitz对应的图相对有些难度，下面简单介绍一下。

通过建立随机的权重进行蒙特卡洛模拟收益率和方差，然后依次计算出 sharp比，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303592397-2373f6e9-3577-40e7-ac24-b5be6a0b8128.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303592941-630e5770-c2cc-4b83-9f42-63a1f1b26077.jpeg)

接下来对收益率和风险进行绘图，不同的 sharp比对应不同的颜色，即颜色是可变的，并添加colorbar，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303593407-02a1d5a3-2ef1-4e5d-b7b8-8fa9eee33f8d.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303593966-808e2908-832f-471b-b189-4d555fab85f5.jpeg)

打开这个程序，然后运行，结果中使用QWebEngineView类所绘制的图表是如此的美丽，这种美丽的动态渲染图在其他GUI程序中很少能够见到，而且它的设计又是那么简单。由此，在内心深处对PyQt有了特别的喜爱。

# 第9章　Plotly与机器学习

## 9.1　Plotly在Sklearn中的应用

本章以讲解案例的方式简单介绍Plotly在Sklearn中的应用，包括机器学习中的三大问题：分类、回归和聚类结果的可视化。每个部分详细介绍一个案例，重点讲解如何制图，而对于机器学习的算法仅在必要时作简单说明。读者在阅读本章时不必纠结算法层面的问题，Sklearn是已经封装好的机器学习包，不需要自己编写程序实现的具体算法。

### 9.1.1　分类问题

本案例使用SVM对经典的IRIS数据集（鸢尾花）进行分类，选择鸢尾花的两个特征作为自变量，其类别作为因变量，分类可视化结果如图9-1所示，代码见文件plotly_SVM.py。

上述可视化结果的实现包含两部分，一个是绘制热力图，即背景图；另一个是绘制样本点。绘制样本点与本书前面绘制散点图相同，需要注意的是将颜色与分类标签挂钩，即color=Y，保证同类样本显示同样的颜色，然后使用colorscale = cmap给不同的标签填上不同的颜色。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303594489-3321ca1f-9c44-401c-a0a5-84b865c31613.jpeg)

图9-1　使用线性核函数SVM算法三分类结果图

在绘制热力图时，需要使用plotly.graph_objs中的Heatmap函数，函数中的x、y、z三个参数分别对应图像的X轴坐标、Y轴坐标，以及由X轴线与Y轴线相交所得的每个小方块的颜色。如果传递给x参数的矩阵大小是a，传递给y参数的矩阵大小是b，那么z参数就需要大小为a×b的矩阵，这也是对z参数做reshape操作的原因。案例中传递给heatmap函数中参数x、y的是x_与y_，均为等差数列，起始点是第一个特征的最小值-1（第二个特征的最小值-1），终点是第一个特征的最大值+1（第二个特征的最大值+1），步长为0.02；传递给z参数的则是分类得到的结果矩阵，大小为 220×280。实际上背景图就是由 220×280个已经着色的小矩阵组成的，由于分类的结果不同，因此呈现的颜色也不同，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303594990-ed831b2b-7b33-42e3-a378-bb726055b478.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303595481-9b40d6f5-7dab-411d-be6d-4a8ab95c487e.jpeg)

### 9.1.2　回归问题

回归的可视化相比分类要简单很多，本案例使用三种模型（RBF、Linear、Polynomial）进行回归实践，并可视化结果，数据使用NumPy随机生成。上述可视化结果的实现包含两部分，一个是对原始数据点的可视化，另一个是对回归曲线的可视化。在本案例中我们将原始点的x与y值传递给p1，将RBF拟合的结果传递给p2，把线性模型拟合的结果传递给p3，把多项式模型拟合的结果传递给p4，再将这4张图叠加就可以绘制出如图9-2所示的回归结果。本案例见文件plotly_SVR.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303596108-57263193-3b19-4990-b260-4e21e4c1cc48.jpeg)

图9-2　三种算法的回归结果

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303596520-df735921-798b-4dae-b2d3-f4137cb8b169.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303597008-5e304a8b-908a-4a24-9d4f-259162de19bd.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303597518-6222514b-e33b-4cb8-91ba-9580221ccce9.jpeg)

### 9.1.3　聚类问题

本案例介绍聚类问题的可视化，案例中比较了K-means算法和MiniBatchKmeans算法的差异，画图部分与9.1.1节有相同之处。聚类结果可视化一般分为两部分，一个是画出聚类中心点，另一个是将同一个类别的数据绘制为同一种颜色。这里仍然使用Scatter函数完成，详细代码见文件plotly_Kmeans.py。

本案例代码分为三部分，第一部分产生聚类所需的数据；第二部分分别使用K-means算法与MiniBatchKmeans算法训练模型；第三部分绘制三张图片，第一张图片是K-means分类结果，第二张图片是MiniBatchKmeans分类结果，第三张图片突出了两种分类结果的差异。下面详细讲解每个部分。

在第一部分中，需要说明一下scikit中的make_blobs方法，这种方法常常被用来生成聚类算法的测试数据，会根据用户指定的特征数量、中心点数量、范围等生成几类数据，使得数据可用于测试聚类算法的效果。make_blobs函数中包含4个参数，n_samples是待生成的样本的总数，n_features是每个样本的特征数，centers表示类别数，cluster_std表示每个类别数据的方差。

在第二部分中，使用生成好的数据调用K-means和MiniBatchKmeans模型进行聚类，并记录运行时间。

第三部分是绘图部分，首先设定三种类别对应的颜色，然后获取cluster_centers_中的聚类中心点，并使用pairwise_distances_argmin函数获取每个数据距离中心点的最短距离。在获取完所需的可视化样本后，使用make_subplots生成一个一行三列的画布，并指定标题，这样就可以在绘制完每一幅图后把图片更新到对应的画布位置。在代码中，绘制一幅图后的代码“fig['layout']['xaxis1'].update”就是在做把图片更新到画布上这件事情。生成画布后，使用 k循环每次完成一个类别的绘制，kmeans1中绘制所有同一个类别的样本点，而 kmeans2中绘制类别的中心点，最后 fig对应的（1,1）在画布上其实是6张图片的叠加，有三张图片依次绘制了三种不同的类别，另外三张图片依次绘制了各个类别的中心点，MiniBatchKmeans算法结果的可视化与k-means算法结果的可视化相同。最后一张图片是对算法结果的差异展示，首先通过逻辑判断找出两种聚类算法结果不同的样本点并在difference2中绘制，然后使用numpy.logical_not方法选出相同的样本数并在difference1中绘制。最后三幅图的绘制结果如图9-3所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303598132-496f66cc-3a6d-46a6-a198-4d02f6ced9d9.jpeg)

图9-3　K-means算法与MiniBatchKmeans算法差异比较图

本案例代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303598650-1d1482da-e45f-4431-8f9c-38707e8791d0.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303599333-a303fcde-015b-462d-984b-ac439e4051a7.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303599650-a514497e-48f5-47ec-beef-737ed39d983d.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303600224-2800680e-77fb-4f8e-aa60-d0e184797452.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303600576-fc458461-4c99-4cc3-8554-a2a2a2d09d1d.jpeg)

## 9.2　PyTorch可视化工具

### 9.2.1　Visdom简介

Facebook的 FAIR项目组发布了 Visdom，这是一款可以在 Torch、PyTorch和NumPy上实现交互式数据可视化的工具套件。FAIR项目组表示，他们已经在内部使用了一段时间，认为这款工具非常有助于研究。Visdom创作者为FAIR项目组的Allan Jabri、Zeming Lin和Laurens van der Maaten。其中，Allan Jabri 承担了绝大部分研发工作。

Visdom的绘图底层使用的是Plotly的JS接口，所以它可以使用Plotly创建基本的图表。Visdom支持使用Torch和NumPy。Visdom可视化工具如图9-4所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303600864-9792e39c-5844-4b76-a1ec-ef3d8295858f.jpeg)

图9-4　Visdom可视化工具

Visdom是一个创造可视化数据的工具，它已经被 Facebook开源了，感兴趣的读者可以访问Visdom的GitHub网址https://github.com/facebookresearch/visdom。

### 9.2.2　安装Visdom

在Python 3环境下，使用pip命令安装Visdom非常简单，直接用pip命令安装即可，代码如下。

pip install visdom

启动服务器，代码如下。

python -m visdom.server

一旦启动服务器，就可以通过在浏览器的地址栏中输入 http://localhost:8097来访问 Visdom，localhost可以换成Visdom的云主机地址，如图9-5所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303601294-b3b144d8-f133-46ea-bdaa-cb74c5ecb8b1.jpeg)

图9-5　访问Visdom

如果环境配置成功，则可以看到一个空白的窗格，当前的会话环境为main。

### 9.2.3　Visdom与Plotly

Visdom底层虽然用的是Plotly.js，但是与Plotly的呈现方式却不同：Plotly的绘图结果是一个绘图使用一个网页，而 Visdom则是把所有绘图结果封装在一个统一的界面去管理，并且可以任意调整每个绘图的大小与位置，这样就可以很方面地管理历史绘图信息，比如可以删掉一些无用的绘图结果，只保留有效的绘图结果。这一点在机器学习中具有比较重要的意义，通过这种方式我们可以查看同一种训练方法传递不同的参数后所得绘图结果的前后对比，这也是PyTorch使用Visdom进行绘图的原因。

### 9.2.4　Visdom基本概念

Visdom用JavaScript在网页上实现了类似MATLAB和Python Matplotlib的图形展示功能，支持数十种图形，包括2D和3D图形，交互很流畅，足以满足一般科学计算的需要。

1.Panes（窗格）

Panes就是用于绘图的小窗格，在代码中叫Window，可以使用浏览器的放大和缩小功能来调整用户界面的大小，如图9-6所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303601695-16c5bf77-2282-42b3-aede-f32c341d7ae0.jpeg)

图9-6　Panes（窗格）

用户界面刚开始是一个白板，用户可以用图像和文本填充它。这些填充的数据出现在 Panes中，用户可以对这些 Panes进行拖放、删除、调整大小和销毁操作。Panes是保存在Environments（环境）中的，Environments的状态存储在会话之间。用户可以下载Panes中的内容，包括在SVG中的绘图。

2.Environments（环境）

可以使用Environments对可视化空间进行分区。默认情况下，每个用户都有一个叫作 main的 Environments。可以通过编程或用户界面创建新的 Environments。Environments的状态是长期保存的。

可以通过 http://localhost.com:8097/env/main访问本地的 Environments。如果用户的Visdom服务器是部署在远程服务器上的，那么可以将此URL分享给其他人，其他人也能看到该用户的可视化结果。

在初始化服务器时，用户的Environments默认通过“$HOME/.visdom/”加载，也可以将自定义的路径当作命令行参数传入。如果移除了Env文件夹下的.json文件，那么相应的环境也会被删除。

3.State（状态）

一旦创建了一些可视化，状态是被保存的。服务器自动缓存用户的可视化——如果重新加载网页，则用户的可视化会重新出现。

● Save：通过单击save按钮，用户可以手动保存Environments。保存时首先序列化Env的状态，然后以.json文件的形式保存到硬盘上，包括窗口的位置。同样，用户也可以通过编程来实现Env的保存。当面对一些十分复杂的可视化时，参数的设置非常重要，这种保存Env状态的方法是十分有用的。例如，数据丰富的演示、模型的训练和系统实验，这些设计依旧可以使这些可视化十分容易分享和复用。

● Fork：如果用户输入了一个新的 Environments名字，保存时就会建立一个新的Environments，有效地复制（forking，等价于GitHub的fork）之前的状态。

### 9.2.5　Visdom经典案例

Visdom支持下列API。由Plotly提供可视化支持。

● vis.text：文本。

● vis.image：图片。

● vis.scatter：2D或3D散点图。

● vis.line：线图。

● vis.stem：茎叶图。

● vis.heatmap：热力图。

● vis.bar：条形图。

● vis.histogram：直方图。

● vis.boxplot：箱型图。

● vis.surf：表面图。

● vis.contour：轮廓图。

● vis.mesh：网格图。

● vis.svg：SVG图像。

这些API的确切输入类型有所不同，尽管大多数API 的输入包含一个tensor X（保存数据）和一个可选的tensor Y（保存标签或时间戳）。所有的绘图函数都接收一个可选参数win，用来将图画到一个特定的Window（窗格）上。每个绘图函数也会返回当前绘图的win参数。用户也可以指定绘出的图添加到哪个Environments上（这里Window的意思就是之前讲的Panes）。

1.查看Visdom模块的帮助实例

可以使用Python的原生命令help来查看Visdom模块下函数的参数与属性，使用的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303602458-34cf1f1d-d372-4b55-90db-6aee385a632e.jpeg)

Visdom其他绘图的内置函数也可以使用这种方法查看有关函数的内置属性，输出信息如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303602713-460e1815-57e6-49c8-a766-e470a9f6ac27.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303603266-d47752cb-cceb-4ead-aa15-0243920a3c3f.jpeg)

2.vis.text

使用此函数可在文本框中打印文本。

本案例文件名为 Chapter09/pt09_vm01_text.py，在文本框内输入一个 text字符串，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303603513-dbd8512b-eadb-4b28-96f7-19d38b17664c.jpeg)

启动 Visdom服务器后，运行脚本，访问 http://localhost:8097的显示效果如图9-7所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303603978-34894d62-7877-4c4d-8d00-692d7d5fc888.jpeg)

图9-7　显示文本

3.vis.image

vis.image函数用来显示图片。本案例文件名为 Chapter09/pt09_vm02_img.py，演示在页面中显示图片，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303604400-8f9f89e0-fd84-43fc-8341-4506b210f555.jpeg)

运行脚本，显示效果如图9-8所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303604753-2a2e6c6d-6929-41dd-a779-6f8cab3c02ad.jpeg)

图9-8　显示图片

4.vis.scatter

vis.scatter函数用来画2D和3D数据的散点图。它需要输入N×2或N×3的tensor X来指定N个点的位置。一个可供选择的长度为N的vector用来保存X中的点对应的标签（1～K），标签可以通过点的颜色反映出来。

本案例文件名为Chapter09/pt09_vm03_scatter.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303605365-87a2abc5-679e-43d7-9042-e7a8aaf9fa15.jpeg)

运行脚本，显示效果如图9-9所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303605859-df54e5bd-b46c-4416-8e8d-38144740278c.jpeg)

图9-9　散点图

5.vis.line

vis.line函数用来画线形图。该函数需要一个形状为N或N×M的tensor Y，用来指定M条线的值（每条线上有N个点），以及一个可供选择的tensor X，用来指定对应的X轴的值，X可以是一个长度为N的tensor（这种情况下，M条线共享同一个X轴），也可以是形状和Y一样的tensor。

该函数支持以下属性。

● options.fillarea：填充线下面的区域（boolean）。

● options.colormap：颜色图（string; default = \'Viridis\'）。

● options.markers：显示点标记（boolean; default = false）。

● options.markersymbol：标记的形状（string; default = \'dot\'）。

● options.markersize：标记的大小（number; default = \'10\'）。

● options.legend：包含图例名称的表。

本案例文件名为Chapter09/pt09_vm04_line.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303606534-39427748-180d-4064-94ac-cab5db60c3d8.jpeg)

运行脚本，显示效果如图9-10所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303607117-de5a68df-2664-4862-b050-27d62ea17324.jpeg)

图9-10　线形图

6.vis.stem

vis.stem函数用来画茎叶图。该函数需要一个形状为N或N×M的tensor X来指定M时间序列中N个点的值，以及一个可选择的Y，形状为N或N×M，用Y来指定时间戳，如果Y的形状是N，那么默认M时间序列共享同一个时间戳。

该函数支持以下特定选项。

● options.colormap：颜色图（string; default = \'Viridis\'）。

● options.legend：包含图例名称的表。

本案例文件名为Chapter09/pt09_vm05_stem.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303607538-512b95c4-9a07-4059-af25-46f9bca7178f.jpeg)

运行脚本，显示效果如图9-11所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303607961-66079309-7c78-4138-b94b-80f12308cd19.jpeg)

图9-11　茎叶图

7.vis.heatmap

vis.heatmap函数用来画热力图。该函数需要输入一个形状为N×M的 tensor X，X指定了热力图中位置的值。

该函数支持下列特定选项。

● options.colormap：颜色图（string; default = \'Viridis\'）。

● options.xmin：小于这个值时会被剪切成这个值（number; default = X:min()）。

● options.xmax：大于这个值时会被剪切成这个值（number; default = X:max()）。

● options.columnnames：包含X轴标签的表。

● options.rownames：包含Y轴标签的表。

本案例文件名为Chapter09/pt09_vm06_heatmap.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303608595-8324ef20-c0f2-4435-b618-fe5d2fe8f521.jpeg)

运行脚本，显示效果如图9-12所示。

8.vis.bar

vis.bar函数可以画普通的、堆起来的或分组的条形图。该函数的输入参数如下。

● X（tensor）：形状N或N×M，指定每个条形的高度。如果X有M列，那么每行的值可以看作一组或把它们的值堆起来（取决于options.stacked是否为True）。

● Y（tensor, optional）：形状N，指定对应的X轴的值。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303609046-62016ce0-924d-42ba-8124-dce9dfdd86fe.jpeg)

图9-12　热力图

该函数支持以下特定选项。

● options.columnnames：包含X轴标签的表格。

● options.stacked：在X中堆叠多个列。

● options.legend：包含图例名称的表。

本案例文件名为Chapter09/pt09_vm07_bar.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303609939-48df0e08-5b24-4965-818e-9327aa74115a.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303610645-64fc6ab4-0b08-4801-b122-dfe90084ee69.jpeg)

运行脚本，显示效果如图9-13所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303611388-630d1414-e3be-4923-8111-53942156b899.jpeg)

图9-13　条形图

9.vis.histogram

vis.histogram函数用来画指定数据的直方图，需要输入长度为N的tensor X，X保存了构建直方图的值。

该函数支持下面的特定选项。

● options.numbins：bins的个数（number; default = 30）。

本案例文件名为Chapter09/pt09_vm06_heatmap.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303611808-0c20ccff-8683-4340-af01-9d80e57fb131.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303612124-56e3ff91-4fc9-40a6-91cb-3c38f6a7e9b6.jpeg)

运行脚本，显示效果如图9-14所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303612444-889e1ee0-d6ae-4409-a116-f0cf1aaebbf9.jpeg)

图9-14　直方图

10.vis.boxplot

vis.boxplot函数用来画箱型图，其输入参数如下。

● X（tensor）：形状N或N×M，指定做第M个箱型图的N个值。

该函数支持下面的特定选项。

● options.legend：数据X中每一列的标签。

本案例文件名为Chapter09/pt09_vm09_boxplot.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303612799-c08c54e7-2a3c-403d-ab8c-a134198e7e01.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303613194-28d83525-846f-4fc9-94e1-b576fe23b34b.jpeg)

运行脚本，显示效果如图9-15所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303613506-7e5c9c03-9ac1-449e-a293-a3ec0629c4cf.jpeg)

图9-15　箱型图

11.vis.surf

vis.surf函数用来画表面图，其输入参数如下。

● X（tensor）：形状N×M，指定表面图上位置的值。

该函数支持以下特定选项。

● options.colormap：颜色谱，字符串格式，默认为“Viridis（翠绿色）”。

● options.xmin：设置最小值，数字格式，默认是X的最小值。

● options.xmax：设置最大值，数字格式，默认是X的最大值。

本案例文件名为Chapter09/pt09_vm10_surf.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303613842-a204198c-7e82-4804-b0f6-706de7288225.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303614423-9995467f-92aa-4af9-8437-5ea19d03f040.jpeg)

运行脚本，显示效果如图9-16所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303614922-5c66847e-af75-407e-96a6-2764c7b4fd00.jpeg)

图9-16　表面图

12.vis.contour

vis.contour函数用来画轮廓图，其输入参数如下。

● X（tensor）：形状N×M，指定轮廓图中的值。

该函数支持以下特定选项。

● options.colormap：颜色谱，字符串格式，默认为“Viridis（翠绿色）”。

● options.xmin：设置最小值，数字格式，默认是X的最小值。

● options.xmax：设置最大值，数字格式，默认是X的最大值。

本案例文件名为Chapter09/pt09_vm11_contour.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303615458-5a29c2eb-33e9-4f05-b1b8-053de13ec2bb.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303616072-54f14df1-25a6-427e-aafd-96d93da32247.jpeg)

运行脚本，显示效果如图9-17所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303616472-d20ff2d9-e8b8-4a75-bcc5-bdd5539f7c70.jpeg)

图9-17　轮廓图

13.vis.mesh

vis.mesh函数用来画网格图，其输入参数如下。

● X（tensor）：形状N×2或N×3，定义N个顶点。

● Y（tensor，optional）：形状M×2或M×3，定义多边形。

该函数支持下列特定选项。

● options.color：颜色（string）。

● options.opacity：多边形的不透明性（取值为0～1）。

本案例文件名为Chapter09/pt09_vm12_mesh.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303616976-a6fad4c6-4d7c-4109-ba28-1b49a1a348e1.jpeg)

运行脚本，显示效果如图9-18所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303617493-8301d386-554a-4c71-81f0-3644e4055b83.jpeg)

图9-18　网格图

14.vis.svg

vis.svg函数用来绘制SVG对象。该函数的输入是一个SVG字符串或一个SVG文件的名称。

本案例文件名为Chapter09/pt09_vm13_svg.py，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303618119-f76eac57-7117-4f1e-9940-944335073672.jpeg)

运行脚本，显示效果如图9-19所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303618547-2f2fefa6-f533-4af4-9d93-9dfd0abd79c7.jpeg)

图9-19　SVG图像

### 9.2.6　Visdom与PyTorch

虽然Visdom强大的绘图功能可以与PyTorch结合在一起使用，但是截至2018年2月10日，PyTorch仍然不支持Windows环境，仅支持Linux和Mac OS系统，而对于绝大部分入门级别的程序员来说，Linux环境的门槛还是比较高的，所以本书没有提供Visdom与PyTorch结合的相关案例。Visdom其实是一个和Plotly一样的可视化工具，其在机器学习中的应用也仅仅是用来可视化而已。读者如果想要自行研究Visdom与PyTorch结合的案例，可以参考9.1节Plotly在Sklearn中的应用的相关案例，对 PyTorch的训练结果进行相应修改即可，前提是需要自行准备 Linux环境。

# 第10章　Plotly在量化投资中的应用

量化投资，简单地说，就是通过计算机编程的方法从历史数据中找到可以盈利的规律，并把它应用到未来数据上，在未来数据上实现盈利。与传统投资相比，量化投资最大的特点是在投资策略中广泛地应用程序化思想。

虽然量化投资的核心盈利策略与Plotly没什么关系，但是并不意味着Plotly就不能应用于量化投资中。实际上，任何投资策略的最终结果都需要一个漂亮的界面来呈现，这就是Plotly在量化投资中的意义。根据笔者的经验，投资策略结果的界面呈现只适合作为回测平台的一个扩展，如果读者没有开源的或自己写的回测平台，那么就没有必要为每个投资策略结果都单独设计一个输出界面，那样做无异于浪费时间。

本章的目的是给现有的回测平台适配基于Plotly的界面输出结果。本书使用的是Python 3的本地开发环境，这就限制了市场上的在线回测平台及基于Python 2的本地回测平台的使用。本章选择给回测平台 zwQuant添加输出界面扩展，是因为zwQuant免费且开源，支持 Python 3，而且简单、易于上手，整个回测平台仅由几个.py文件构成。

目前zwQuant只发布了第1版，其中有很多细节不够完善，本书提供的代码增加了对Plotly输出界面的支持，是一个类似网页的界面，并调整了zwQuant的一些细节，使之更容易扩展和使用。

在学习本章之前，有一点需要说明，本章内容只涉及对zwQuant的Plotly界面输出的封装，不涉及zwQuant的具体使用，读者如果对zwQuant感兴趣，可以参考《零起点 Python大数据与量化交易》（以下简称《零起点》）一书，本章涉及的扩展方法对这本书的所有案例都兼容。使用本书提供的修改版zwQuant回测框架，对《零起点》这本书涉及的策略文件稍微修改一下并运行即可得到Plotly的精美绘图结果。

运行Chapter10/zq902_macd_v2.py文件，结果如图10-1所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303619060-56bdbe55-34ae-4377-b51b-d6573a7c3a85.jpeg)

图10-1　绘图结果

注意

Pandas 升级到0.21.0 版本之后，其版本的兼容性与之前版本的兼容性有点差别，所以导致这个案例运行出错。这个错误的原因是Pandas 团队在新的版本（0.21.0）中对idxmax 函数的设计没有考虑周全。

所以，建议使用的Pandas 版本不超过0.20.xx。

这是对zwQuant适配Plotly扩展的界面，下面对这个界面进行解读。

在默认情况下，是不显示Plotly界面的，要开启Plotly界面的显示，首先需要对策略参数进行如下设置：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303619577-19a312ba-5319-48ee-b912-002bfeef2cef.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303620159-b9716eb2-6b0b-4cac-af00-b676aed7d3f8.jpeg)

其中，qx.plotly_mode_flag=True就是指开启 Plotly输出模式。如果设置了qx.plotly_mode_flag=True，在bt_endRets函数中会执行下面的代码：

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303620627-f7e4d4bd-eb81-4431-aac1-5125e7553ffa.jpeg)

zwdr.my_plotly_show()对应的Chapter10/zwQTDraw.py文件的my_plotly_show()函数代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303621125-94bfcdc6-b871-4174-a779-dc3f8cbf281b.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303621385-51c15179-456d-4f36-b7a7-951efdf8efba.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303621710-7da70a63-6f23-4c38-b195-d68ff6fb5e36.jpeg)

运行结果如图10-2所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303622275-a0ed436b-bdfa-4bf9-97c4-688fc5c45d7c.jpeg)

图10-2　绘图结果

由于纸质版的原因，这幅图的动态效果在这里体现不出来，如果想要看它的原始结果，可以使用浏览器打开本地文件Chapter10\tmp\macd20.html，在计算机中查看动态绘图结果。在认识Plotly之前，笔者印象中要想做出这种效果，只有老老实实地去学习网页开发的一些框架，例如Django、Flask等。虽然技多不压身，多学点网页开发技术对自己有好处，但是也要考虑实际需求与时间成本。从笔者金融行业背景的角度来说，仅是想要一个简单的输出界面，没有必要也没有动力去学习那么多网页开发的基础，因此，Plotly的出现完全满足了个人的需求。下面就开始对图10-2对应的代码进行分析。

从绘图结果中可以发现，这个绘图结果是一个表格与一个具有主次坐标轴的直线图的混合结果。通过前面所学到的知识，我们知道单独绘制一个表格很简单，而绘制主次坐标轴的直线图也不是太麻烦的事情，但是要把两者结合在一起就有一些难度了，接下来就解决这个问题。

首先，新建一个表格。传入的 qx.result_info是一个 23×2结构的列表，我们添加一个1×2的元素，把它转换成24×2结构的列表；然后把这个列表转换成6×8结构的 NumPy数组；最后把这个数组转换成 6×8结构的 DataFrame，利用 create_table函数把DataFrame转换成Plotly的表格，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303622848-1533d44e-5707-4351-b340-5c2b1f918e83.jpeg)

接下来，新建两个trace，用来构建拥有主次坐标轴的线条图，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303623340-ef771106-1496-4030-ab15-95b6e68d4f6f.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303623891-1e7ace57-1dfc-4f02-bc46-19440de859e6.jpeg)

qx.qxLib存放的是每日交易情况的汇总，如果读者很想知道它到底长什么样子，可以用 Excel打开文件 Chapter10\tmp\macd20_qxLib.csv。每次回测之后，qx.qxLib都会在本地保存一份，这个文件就是本次回测的备份结果。

上面的代码并不难理解，只是有几个参数需要在这里解释一下。

对于trace1来说，如下几个参数比较重要。

● xaxis='x2'，表示trace1是在第二幅图上绘制的（第一幅图对应参数值默认是x1）。

● yaxis='y2'，解释同上。

● legendgroup='one'，默认是''，如果赋值为 string（这里是'one'），那么对于所有legendgroup='one'的legend来说，单击任意一个legend，等价于单击该legendgroup的所有legend。

对于trace2来说，与trace1类似，只有下面这个参数稍微不同。

● yaxis='y3'，这里之所以要设置为'y3'，而不是'y2'，是因为'y2'要被设置为第二幅图的主坐标轴，因此，次坐标轴就属于'y3'了。

接下来，把trace1、trace2合并到表格里面，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303624376-26fd2bbf-e8f1-455d-b171-f2ed2d64ab1c.jpeg)

最后，由于figure['data']里面既有之前创建的table，又有trace1和trace2，如果不对它们进行布局，Plotly会默认把它们混合在一起，所以需要对figure进行布局，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303624938-11e37fc7-e909-4de2-940c-948fdb6e8af7.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303625347-423e7b8c-a4e6-4153-97eb-7de438e810ab.jpeg)

上面的代码有些凌乱，下面分开解读。

对于yaxis轴，由于其是一个表格，我们希望它占据一定的空间高度，代码如下。

yaxis={'domain': [.7, 1]},

对于yaxis2轴，由于其是线形图的主坐标轴，我们也希望它占据一定的空间高度，并且希望它对应axis2，因为默认情况下对应的是axis，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303625868-15dde588-e690-4665-a796-a11338026f55.jpeg)

对于yaxis3轴，我们希望它和yaxis2轴一样都是坐标轴（overlaying='y2'），只是在右侧作为副坐标轴（side='right'）。另外，这里还用到了tickfont与titlefont参数，用来设置标题与刻度的颜色，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303626386-df481992-bee1-4838-bc57-476d91d7ed52.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303626864-dd00bde6-4cf7-4e4b-83ef-1cf93ab7e140.jpeg)

对于xaxis2轴，我们希望它能对应yaxis2轴，代码如下。

xaxis2={'anchor': 'y2'},

然后设置窗口的举例（margin参数）、figure的标题（title参数）、高度（height参数）、图例（legend参数）。注意，legend参数中的意思是把图例的位置放在（0.9,0.6）的相对空间位置上，xanchor与yanchor分别设置为'auto'表示程序会自动在水平与垂直方向上调整大小，结果会影响margin参数的效果，读者可以注释掉这两行代码，然后运行一下，查看前后的结果，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303627393-7d3544ac-f6a7-4a8b-a1d2-34c73b4fa2d2.jpeg)

至此，本章内容最重要的部分就介绍完毕了，如果读者对本章前面的内容已经了解了，会发现本章的内容是很简单的。

Plotly的出现为金融数据可视化尤其是量化投资的结果可视化打开了一个新的天地：利用 Plotly，我们可以以很简单的方式绘制一些精美的动态图表；可以绘制类似网页的动态输出结果，而不需要学习一些网络开发框架，如Django和Flask等；可以把绘图结果原汁原味地分享给自己的朋友或同事，和他们一起分享我们的喜悦。总之，Plotly的出现确实可以影响我们对数据可视化的固有观念，让我们的编程生活更加美好。

# 第11章　Plotly在其他语言中的应用

## 11.1　Plotly在R语言中的应用

R语言是用于统计分析、图形表示和报告的编程语言和软件环境。R语言由Ross Ihaka和Robert Gentleman等在新西兰奥克兰大学创建，目前由R语言开发核心团队开发。R语言问世以来，其官方社区为R语言提供了非常多的免费、开源而且强大的模块，这些模块的开发者很多都是学术界的“大牛”，并且紧跟学术前沿，因此R语言在学术界有着非常高的地位。

R语言由于其安装空间小、模块管理方便、易学易用等特点，在数据分析与处理方面有着很重要的地位。使用R语言绘图也非常方便，如大名鼎鼎的ggplot可以说是R语言的绘图神器。但是和python一样，这些绘图模块绘制的图表都是静态的，而Plotly是基于JS的动态绘图模块，本节主要介绍Plotly在R语言中的应用。

### 11.1.1　安装R语言

R语言支持Mac、Linux和Windows三大系统，我们可以从R语言的官方网站（https://cran.r-project.org/）下载对应系统的安装包，这里以 Windows操作系统为例进行介绍。

从R语言官方网站下载R的Windows安装包，并将其保存在本地目录中。它是一个名为“R-version-win.exe”的 Windows安装程序（.exe），只需双击并运行安装程序，接受默认设置即可。如果读者的Windows是32位版本，那么它将安装32位版本；如果读者的Windows是64位版本，那么它将安装32位和64位版本。

安装后，既可以单击桌面上的程序快捷图标运行程序，也可以单击Windows程序文件下的路径“R\R3.2.2\bin\i386\Rgui.exe”运行程序。这时会打开R-GUI，这是一个R控制台，可以在里面进行R语言编程。

### 11.1.2　安装Plotly模块

安装Plotly模块最简单的方法是在控制台中通过以下命令安装：

install.packages("plotly")

安装完成后，在使用这个包里面的函数之前要加载Plotly包，代码如下。

library(plotly)

在这个包里面有一个非常重要的函数plot_ly，它是用来绘制图形的函数。由于R语言的绘图并不是本书的重点，所以本书仅介绍几个入门图形的绘制方法。

### 11.1.3　Plotly应用分析

本节主要介绍 Plotly在 R语言中的基本应用，本节的所有代码都可以在文件code.R中找到。

1.散点图

使用plot_ly函数画几幅简单的图形，最常见的就是散点图。本案例使用模拟的数据进行画图，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303627645-3e266a99-7ca8-4e81-bfe6-d459af614616.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303627999-5d77d118-e36e-44b9-8a9a-e8c5865daabc.jpeg)

绘图结果如图11-1所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303628506-234cbc75-886e-434e-bd83-f52f2b73700a.jpeg)

图11-1　散点图

代码解释如下。

● 第1行代码表示加载Plotly包，加载后可以一直使用Plotly包里面的函数，如果R语言关闭后重新打开，则需要再加载一次该包。

● 第2行代码表示设定随机种子，设定随机种子后，每次产生的随机数将是一样的。

● 第3行代码表示产生样本量为50、均值为0、标准差为1的标准正态分布随机数x1。

● 第4行代码表示产生样本量为50、均值为1、标准差为1的标准正态分布随机数x2。

● 第5行代码表示将产生的两个随机数放入数据框data中（因为plot_ly函数要求data是数据框格式）。

● 第6行代码表示画x1与x2的散点图，其中，x = ～x1表示以x1为X轴（横坐标），y = ～x2表示以x2为Y轴（纵坐标），type ="scatter"表示画图的类型为散点图。

注意

（1）如果读者用的是R 语言，以上代码画的图形会在读者的浏览器网页上显示，如果读者用的是RStudio，则图形会在RStudio 自带的浏览器中显示。

（2）与Python 不同，Plotly 在R 语言中的绘图没有离线绘图与在线绘图之说，所有绘图都是离线绘图。因此，本节内容就没有区分离线绘图与在线绘图。

2.散点图（三维）

使用plot_ly函数绘制三维散点图也是很方便的，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303629052-847ee8a5-7e2d-4402-ba92-a61f5122ebb6.jpeg)

这里的代码与二维散点图中的代码的区别在于type这个参数，只需要把scatter换成scatter3d即可。绘制的结果如图11-2所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303629616-d590d486-ac13-47d6-929a-9e11cf80f4ca.jpeg)

图11-2　三维散点图

3.线形图

接下来介绍一些基本线形图的画法。绘制线形图同样使用plot_ly函数，type参数中没有提供线形的类型，因为在 Plotly里面，线形图是由散点图演变过来的，我们可以在函数里面添加参数mode把散点图的点连接成线，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303630089-2a216b6d-33d3-4417-b55d-eda1b1245298.jpeg)

代码解释如下。

● 第2行seq函数表示生成有规律的序列，我们在此生成从1到50、间隔为1的50个数据。

● 第3行代码表示产生样本量为50、均值为0、标准差为1的标准正态分布随机数y。

● 第4行代码表示将数据x、y放入数据框data中。

● 第5行代码表示以x为横轴、以y为纵轴画线形图。

绘制结果如图11-3所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303630595-0f24375e-f135-4c13-bd79-dbb01bfe0f49.jpeg)

图11-3　线形图

在图11-3中我们只画了一条线，也可以在同一幅图中画多条线，有两种方法可以完成这个工作。接下来用两种方法在同一幅图中画出三条线。

第一种方法：先画出一条线，然后在该图形中添加另外两条线。

第二种方法：先画出坐标轴（画出横轴），然后在坐标轴中添加三条线。

4.线形图（多元1）

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303631024-bc052e64-d861-4b10-b40a-f12148c9e3c0.jpeg)

代码解释如下。

● 第1行代码表示设定随机种子。

● 第2、3、4行代码表示生成随机数，我们在此设定均值分别为0、3、6，主要是为了便于观察图形。

● 第5行代码表示产生1到50、间隔为1的序列。

● 第6行代码表示将x、y1、y2、y3放到数据框data中。

● 第7行代码表示以x为横坐标轴、以y1为纵坐标轴画线形图。

● 第8行代码表示在原坐标轴上添加曲线y2。

● 第9行代码表示在原坐标轴上添加曲线y3。

注意

第7、8、9行中的name参数表示将曲线y1命名为y1、将曲线y2命名为y2、将曲线y3命名为y3。

参数mode表示线条类型，lines表示加线，markers表示为对应的点加上标记，它们可以同时使用，即lines+markers。

%>%可以表示一个连接符，连接符后面还有语句，直到语句后面不再出现%>%时，执行从开始出现%>%到结束的语句。

绘图结果如图11-4所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303631350-d8c0629c-f3e5-4802-bd7a-de86b18271c5.jpeg)

图11-4　三条曲线图

5.线形图（多元2）

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303631718-7d317591-b189-41d0-8684-c258064b3bfb.jpeg)

绘图结果如图11-5所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303632078-e8c77310-172a-446b-866c-df41ee5e564f.jpeg)

图11-5　三条曲线图

从图11-4和图11-5可以看出，上面两种方法绘图的结果是一样的，只是实现的方法不一样。

### 11.1.4　更多扩展

使用 plot_ly函数可以画多种类型的图，比较简单的方法是通过修改参数 type来实现，type的可选参数有："scatter"、"box"、"bar"、"heatmap"、"histogram"、"histogram2d"、"histogram2dcontour"、"pie"、"contour"、"scatterternary"、"sankey"、"scatter3d"、"surface"、"mesh3d"、"scattergeo"、"choropleth"、"scattergl"、"pointcloud"、"heatmapgl"、"parcoords"、"scattermapbox"、"carpet"、"scattercarpet"、"contourcarpet"、"ohlc"、"candlestick"和"area"。具体的使用方法及案例可参考 Plotly中的 plot_ly函数的使用方法。

如果读者对 Plotly在 R语言中的应用有更多的需求，可以参考官方网站https://plot.ly/r/，在这个网站中可以找到绝大部分想要的案例，官网部分截图如图11-6所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303632357-79311d63-7c53-4d7f-9f70-add0d53d766f.jpeg)

图11-6　官网部分截图

## 11.2　Plotly在MATLAB中的应用

Plotly作为强大的数据可视化工具，拥有支持MATLAB使用的接口，对于众多使用 MATLAB进行研究工作的用户来说，能将 MATLAB强大的数据处理能力与Plotly的可视化功能结合起来，无疑是一个巨大的帮助。由于Plotly绘图模块丰富的内容和优秀的美化功能，使得Plotly在MATLAB中得到了广泛应用。

### 11.2.1　下载与安装

MATLAB的 Plotly工具箱可以从官网目录 https://plot.ly/matlab/下的 Getting Started中下载，下载后将其解压，得到一个名为MATLAB-Online-master的文件夹，然后打开MATLAB进行Plotly工具箱的安装。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303632756-3ad9c202-44cc-42ea-b4c3-afbc4add5199.jpeg)

其中，Username和 API Key可以在官网上免费注册获得，笔者为本书注册的Username为PlotlyBookTest，API Key为ECmqAy8kLE5Qk7h29trH。

安装成功后将显示Plotly工具箱已成功安装并导入MATLAB路径中。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303633113-e57987e2-d186-42ec-829c-922364039a1e.jpeg)

安装完成后可以将上述下载并解压得到的文件夹删除。

接下来便可以使用Plotly工具箱在线画图了！

注意

（1）如果下一次重新打开MATLAB 时遇到如图11-7 所示的警告，可打开D:\software\Matlab2013b\1\toolbox\local\startup.m 文件，将里面的“addpath(genpath(fullfile(matlabroot,'toolbox','plotly')),'-end');”语句剪切至function…end 之间保存，然后重新启动MATLAB。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303633695-47c48256-8650-4a21-89ce-a6d5e70b3093.jpeg)

图11-7　警告

（2）需要版本更新时运行plotlyupdate 文件，但此功能可能会间接性失效，失效时只能通过官网下载最新版本，再按照上述流程安装一遍。

### 11.2.2　基础入门

1.在线绘图

接下来利用Plotly将MATLAB中的图变成既美观又实用的交互式在线图片，只需要调用一个函数fig2plotly()即可，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303634156-e7bca154-0ac2-4e9d-82f0-bb68d74e1668.jpeg)

运行后将弹出一个网页，显示调用 Plotly后的绘图结果，并将图片保存在账户的云端。此运行结果如图11-8所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303634460-fb8b0f29-4f3e-47ef-bb2c-fcde1ec0b519.jpeg)

图11-8　在线绘图结果

若不希望Plotly对图片进行调色改变，希望保留MATLAB中图片的样式，则可以使用fig2plotly（gcf,'strip',false）。另外，可通过所得到结构体plotly_fig中的layout和PlotOptions中的参数进行其他设置，如fig2plotly（gcf,'filename', 'plotly1'）设置文件名等。

2.离线绘图

在线绘图的速度过慢，我们更常用的是Plotly支持的离线绘图功能。

要使用Plotly的离线绘图功能，首先需要下载一个离线绘图包。此下载流程已在Plotly工具箱中包含了，只需要运行下面这行代码即可。

\>>getplotlyoffline('https://cdn.plot.ly/plotly-latest.min.js')

下载成功后输出以下代码。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303634794-c2410a15-82eb-45bf-be8e-614ce6444d2a.jpeg)

注意

若下载时报错，可以先尝试运行后面的离线绘图代码，也许已经可以正常使用了。

接下来就可以使用Plotly的离线绘图功能了，使用离线绘图只需要在在线绘图代码上稍作修改，将'offline'参数设置为true，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303635319-4f21d104-5fca-4d78-acab-f0c7965c4596.jpeg)

此时绘图结果将形成一个HTML文件保存在当前文件夹下。将plotly_fig.url复制并粘贴至浏览器的地址栏中，即可查看保存在本地的绘图结果，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303635857-4754f777-215c-4fb3-a53a-522bd0ff14fa.jpeg)

离线绘图的运行结果如图11-9所示。

若离线绘图的操作已经全部完成，希望将结果上传至云端，只需要单击图11-9右上角的“保存并上传”按钮即可。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303636462-82b7e04e-8070-41db-a172-1ebf7e4bfee6.jpeg)

图11-9　离线绘图结果

至此，已经学习完MATLAB操作Plotly工具箱的基本操作了，接下来是一些更复杂的经典案例，重点介绍离线绘图操作。

### 11.2.3　经典案例

1.气泡散点图

（1）简单气泡散点图

首先设置坐标、大小、颜色并在MATLAB中绘图，然后使用Plotly，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303636969-b9c01455-3a0a-47cc-8050-26864694dec1.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303637511-13c4e795-a6e6-443a-847f-d348206dcbfe.jpeg)

绘图结果如图11-10所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303638040-a39e4ac3-6f12-4b30-bb8c-145c14a31c38.jpeg)

图11-10　简单气泡散点图

（2）复合气泡散点图

可以同时对多份数据绘图，并画出多种不同形状的气泡，也可以不通过MATLAB而直接利用Plotly绘图，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303638493-1c911f26-b46d-4278-b57a-b255171f83dd.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303639195-1491c05a-a679-4fcd-9a14-981954ef602e.jpeg)

绘图结果如图11-11所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303639622-8f5672b5-1fb7-4937-b5e5-76ce3dff3184.jpeg)

图11-11　复合气泡散点图

2.时间序列

时间序列数据是金融领域重要的数据类型，Plotly工具箱中有强大的功能来辅助数据可视化。

（1）标准日期

标准日期绘图案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303640025-fae73040-62e2-49c9-a82d-0dbf5df37aa7.jpeg)

绘图结果如图11-12所示。

如果使用在线绘图，只需要将'offline'参数设为false，将plotlyoffline()函数替换为plotly()函数。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303640669-99d9bb32-80e0-4710-9d80-aafb09acfc84.jpeg)

图11-12　标准日期绘图

（2）字符串日期

字符串日期绘图案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303641130-bc20afa9-4e91-421d-aebd-871306766c7e.jpeg)

绘图结果如图11-13所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303641626-7c5a5711-09da-44dc-a8dc-0922caa278f8.jpeg)

图11-13　字符串日期绘图

3.频率直方图

下面介绍复杂一些的绘图，使用 Plotly工具箱画两幅重叠的频率直方图，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303642139-a69be4ad-42e7-416c-a8a8-a45c755e5ae8.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303642670-d5ea3d05-d62f-409b-90bf-f14d4889db44.jpeg)

绘图结果如图11-14所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303643169-3d2ff21f-88d5-4277-9d0f-4c01ba0aa62d.jpeg)

图11-14　频率直方图

4.箱型图

箱型图在数据信息展示中的应用十分广泛，其包含的数据特征很多，绘图案例的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303643510-b813420a-085a-4c94-bccd-e2843533d8ca.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303643764-4917ea95-15b0-4e89-80c5-7d35fa6d59b0.jpeg)

绘图结果如图11-15所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303644251-a0c94d43-4ba1-432d-a6f7-da5b1aff6b31.jpeg)

图11-15　箱型图

5.组合图

组合图就是将多种图形绘制在一张图中，其实前面已经展示了同时绘制多图的例子，只是绘制的是多幅同种图形，下面讲解简单组合图形的绘制方法。例如，柱形图与线形图组合的绘图代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303644672-c9d2d305-dc1c-4292-8b3f-726ef9f62add.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303645236-eee89e09-c80a-470b-8e04-fefdee091e2f.jpeg)

在数据中，设置参数'type'为不同类型，即可同时绘制出不同类型的图形。

绘图结果如图11-16所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303645896-0b57a08d-7a3b-4861-9b4a-2ebcd559dd57.jpeg)

图11-16　柱形图与线形图组合

### 11.2.4　更多扩展

除以上常用的经典用法外，Plotly工具箱在MATLAB中还有很多扩展功能。

可以说，数据可视化在各个行业所需要的图，Plotly都可以结合MATLAB本身的绘图功能加以实现，如建筑方面的 3D图、物理学中的能量图、试验模拟用到的动图、信号处理中的实时更新变化图、金融经济数据常用的面板数据展示图、组合展示的双坐标轴图和数据对比用的多子图等。

Plotly作为最好的数据可视化工具之一，还有众多有吸引力的功能待我们去学习与应用，有兴趣的读者可以参考官网（https://plot.ly/matlab/）中的介绍和案例。

## 11.3　Plotly在JavaScript语言中的应用

Plotly是一款独立的Web版数据可视化工具，界面友好，提供强大的互动性操作。Plotly的绘图底层使用的是plotly.js，plotly.js基于D3.js、stack.gl（WebGL组件库，由Plotly团队的Mikola Lysenko领导开发）和SVG，用JavaScript在网页上实现了类似MATLAB和Python Matplotlib的图形展示功能，支持20种图形，包括2D和3D图形，交互流畅，足以满足一般科学计算的需要。

本节主要介绍基于JavaScript接口的Plotly的使用，使用方法非常简单，只需要在独立的HTML文件中调用plotly.js绘图函数库就会生成基本的图形。

下面介绍最常用的几种图形格式：线形图（Line）、散点图（Scatter）、条形图（Bar）和扇形图（Pie）。

### 11.3.1　基础入门

Plotly绘图分为两种情况，一种是离线绘图，另一种是在线绘图。

1.离线绘图

笔者使用的是winpython开发的Plotly（详见本书1.2节安装与安装环境），在winpython环境中（在其他环境下方法类似）使用pip命令安装Plotly模块。

pip install plotly

安装成功后可以在%\WinPython-2bit361\python-3.6.1\Lib\site-packages\plotly\package_data目录下发现plotly.min.js文件。

首先，新建一个项目，命名为plotlyweb，项目可以被理解为一个网站，在项目中新建文件夹js，存放Plotly需要加载的JavaScript绘图函数库文件plotly.min.js，创建好的项目目录结构如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303646379-c5f3e008-1066-4fde-8f07-ccf01e062a64.jpeg)

然后，在plotlyweb项目下，新建HTML文件，命名为pl1.html，在HTML文档中使用<script>标签加载plotly.min.js文件，代码如下。

<script src="js/plotly.min.js"></script>

接着，在HTML文档中创建一个空的div，宽为600px，高为250px，用来绘制图形，代码如下。

<div id="tester" style="width:600px;height:250px;"></div>

最后，使用Plotly.plot() 函数创建交互式plotly.js图表——一个简单的曲线图，代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303646993-6c2ae1a7-a790-4dd7-a8aa-a04a3f02ee97.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303647474-ceefb83f-b0b7-483b-9aec-bf94667d4407.jpeg)

在本案例中最重要的是设置plot()函数的参数。

● 第一个参数：在HTML中需要渲染的图形使用的div节点对象。

● 第二个参数：设置X、Y轴的坐标数据和margin（边距）的值。

使用浏览器打开 pl1.html页面，稍等片刻就会渲染完成一个交互式的曲线图，得到的绘图结果如图11-17所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303648036-590e9378-5c35-4224-90ee-e655dc506f53.jpeg)

图11-17　交互式的曲线图

2.在线绘图

除离线绘图外，也可以使用在线绘图，也就是该绘图不依赖本地的plotly.min.js文件。对于在线绘图，可以使用Plotly的CDN链接加载plotly.js，提高JS脚本的加载速度。CDN广泛采用各种缓存服务器，将这些缓存服务器分布到用户访问相对集中的地区或网络中，在用户访问网站时，利用全局负载技术将用户的访问指向距离最近的工作正常的缓存服务器上，由缓存服务器直接响应用户请求。

要把离线绘图方式修改为在线绘图方式，只要把JS脚本的加载方式修改一下就可以了。下面的代码是离线的加载方式。

<script src="js/plotly.min.js"></script>

替换为在线的CDN加载，代码如下。

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

修改后完整的代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303648434-7445eaaf-b343-450e-b886-8e40b9a43b86.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303648998-74b74d52-f58e-47bc-96c1-102891ae33e2.jpeg)

使用浏览器打开 pl1.html页面，绘图结果如图11-18所示，与离线的输出效果一样。为了提高 JavaScript脚本的加载速度，在后面的案例中，我们都采用在线方式绘制基本的图表。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303649523-cd3f7a5a-30f2-48c4-b895-8155365ea0bd.jpeg)

图11-18　在线绘图结果

### 11.3.2　散点图

线形图又称曲线图，是最常用的图形类型。与传统的绘图软件不同，Plotly没有独立的线形图函数，而是将线形图（Line）与散点图（Scatter）全部用 newPlot函数实现，且newPlot函数的type参数都需要设置为'scatter'，它们的区别在于mode参数不同。

本案例包括线形图与散点图两种图形的混合。新建一个 HTML文件，命名为pl_scatter.html，具体代码如图11-19所示。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303650036-35c28493-9fde-4f86-bd44-c42c20350657.jpeg)

图11-19　散点图案例代码

使用浏览器打开pl_scatter.html页面，得到如图11-20所示的结果。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303650534-a9e34ca1-175f-4f29-8f52-327e8aa67fb9.jpeg)

图11-20　散点图

上述程序代码主要说明如下。

● 第1行，说明该HTML代码文件是符合HTML 5文档类型的。

● 代码第3～6行，HTML的head标签。

● 代码第8行，在HTML文档中，创建一个空的DIV来绘制图形。

● 代码第11行，导入plotly.js的CDN链接。

● 代码第13～18行，设置散点图的数据源，这是一个JSON格式的字符串，trace0对象的属性x、y对应图形在坐标系上的X、Y轴的值。trace0对象的mode属性为markers，表示图形为点图。trace0对象的type属性为scatter，表示渲染的图形类型是散点图。

● 代码第20～25行，设置散点图的数据源，trace1对象的属性x、y对应图形在坐标系上的X、Y轴的值。trace1对象的mode属性为lines，表示图形为线形图。trace1对象的type属性为scatter，表示渲染的图形类型是散点图。

● 代码第27～32行，设置散点图的数据源，trace2对象的属性x、y对应图形在坐标系上的X、Y轴的值。trace2对象的mode属性为lines+markers，表示图形为线形图+点图。trace2对象的type属性为scatter，表明渲染的图形类型是散点图。

● 代码第34行，声明一个数组变量data，包括数据源trace0、trace1和trace2。

● 代码第36行，使用Plotly.newPlot()函数渲染散点图，第一个参数是在HTML中创建的空白DIV节点，第二个参数是加载的图形数据源。

查看案例源码可以看出，markers、lines、markers+lines三个图输出的图表格式不同，是因为newPlot函数中的mode参数不同。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303651076-442d4401-2cb5-4ab5-a042-afb105812a96.jpeg)

### 11.3.3　条形图

条形图（Bar），也叫柱状图，是以长方形的长度为变量的统计视图，用来比较多个项目分类的数据大小，通常用于较小的数据集分析。例如，不同季度的销量、不同国家的人口等。

用Plotly绘制条形图与绘制线形图类似，不同之处是需要在newPlot()函数中设置图形数据源的type参数为bar。本案例新建一个HTML文件，命名为 pl_bar.html，具体代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303651625-70d2099d-92fa-45d2-aa73-189a1a6a752c.jpeg)

使用浏览器打开pl_bar.html页面，得到如图11-21所示的结果。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303652104-70d63b96-1a12-4efe-8d0f-bc7bb1e93a68.jpeg)

图11-21　条形图

### 11.3.4　扇形图

扇形图（Pie），也叫饼图，显示一个数据系列中各项的大小与各项总和的比例。饼图中的数据显示整个饼图的百分比，如移动手机品牌占市场份额图。

用Plotly画一个基本的扇形图，需要调用newPlot()函数，传递数据并设置样式。通过 layout参数绘制出不同类型的扇形图。本案例新建一个 HTML文件，命名为pl_pie.html，具体代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303652621-37ca6253-f76d-4733-91ec-a3895fdc802a.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303653184-5f8dce4b-7a86-4274-9c87-36f7a300482a.jpeg)

使用浏览器打开pl_pie.html页面，得到如图11-22所示的结果。

在本案例中，核心代码是设置layout参数，设置扇形图的高度（height）和宽度（width），代码如下。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303653729-4467eda0-2598-4b90-88d0-5c921182e0a1.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303654315-1a18a937-6d41-424a-a85c-7267784dde20.jpeg)

图11-22　扇形图

### 11.3.5　更多扩展

Plotly绘图是基于JavaScript技术而来的，所以对JavaScript语言天生支持，本节内容仅展示了JavaScript调用Plotly最基础的案例，对于更多的案例，读者可以参考Plotly的JavaScript官方网站（https://plot.ly/javascript/），在这个网站中可以找到自己所需的绝大部分绘图功能。

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303654821-396d3662-a5f8-48ee-80b7-7e321359fecb.jpeg)

![img](https://cdn.nlark.com/yuque/0/2022/jpeg/21473765/1644303655339-afc598fb-f026-4a8d-8de0-d322b03d016a.jpeg)
